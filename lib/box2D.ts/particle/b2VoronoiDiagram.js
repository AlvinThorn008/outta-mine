/*
 * Copyright (c) 2013 Google, Inc.
 *
 * This software is provided 'as-is', without any express or implied
 * warranty.  In no event will the authors be held liable for any damages
 * arising from the use of this software.
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 * 1. The origin of this software must not be misrepresented; you must not
 * claim that you wrote the original software. If you use this software
 * in a product, an acknowledgment in the product documentation would be
 * appreciated but is not required.
 * 2. Altered source versions must be plainly marked as such, and must not be
 * misrepresented as being the original software.
 * 3. This notice may not be removed or altered from any source distribution.
 */
import { b2_maxFloat, b2Assert, b2MakeArray } from '../common/b2Settings';
import { b2Vec2 } from '../common/b2Math';
import { b2StackQueue } from './b2StackQueue';
/**
 * A field representing the nearest generator from each point.
 */
export class b2VoronoiDiagram {
    constructor(generatorCapacity) {
        this.m_generatorCapacity = 0;
        this.m_generatorCount = 0;
        this.m_countX = 0;
        this.m_countY = 0;
        this.m_diagram = [];
        this.m_generatorBuffer = b2MakeArray(generatorCapacity, (index) => new b2VoronoiDiagram_Generator());
        this.m_generatorCapacity = generatorCapacity;
    }
    /**
     * Add a generator.
     *
     * @param center the position of the generator.
     * @param tag a tag used to identify the generator in callback functions.
     * @param necessary whether to callback for nodes associated with the generator.
     */
    AddGenerator(center, tag, necessary) {
        !!B2_DEBUG && b2Assert(this.m_generatorCount < this.m_generatorCapacity);
        const g = this.m_generatorBuffer[this.m_generatorCount++];
        g.center.Copy(center);
        g.tag = tag;
        g.necessary = necessary;
    }
    /**
     * Generate the Voronoi diagram. It is rasterized with a given
     * interval in the same range as the necessary generators exist.
     *
     * @param radius the interval of the diagram.
     * @param margin margin for which the range of the diagram is extended.
     */
    Generate(radius, margin) {
        const inverseRadius = 1 / radius;
        const lower = new b2Vec2(+b2_maxFloat, +b2_maxFloat);
        const upper = new b2Vec2(-b2_maxFloat, -b2_maxFloat);
        let necessary_count = 0;
        for (let k = 0; k < this.m_generatorCount; k++) {
            const g = this.m_generatorBuffer[k];
            if (g.necessary) {
                b2Vec2.MinV(lower, g.center, lower);
                b2Vec2.MaxV(upper, g.center, upper);
                ++necessary_count;
            }
        }
        if (necessary_count === 0) {
            ///debugger;
            this.m_countX = 0;
            this.m_countY = 0;
            return;
        }
        lower.x -= margin;
        lower.y -= margin;
        upper.x += margin;
        upper.y += margin;
        this.m_countX = 1 + Math.floor(inverseRadius * (upper.x - lower.x));
        this.m_countY = 1 + Math.floor(inverseRadius * (upper.y - lower.y));
        this.m_diagram = []; // b2MakeArray(this.m_countX * this.m_countY, (index) => null);
        // (4 * m_countX * m_countY) is the queue capacity that is experimentally
        // known to be necessary and sufficient for general particle distributions.
        const queue = new b2StackQueue(4 * this.m_countX * this.m_countY);
        for (let k = 0; k < this.m_generatorCount; k++) {
            const g = this.m_generatorBuffer[k];
            ///  g.center = inverseRadius * (g.center - lower);
            g.center.SelfSub(lower).SelfMul(inverseRadius);
            const x = Math.floor(g.center.x);
            const y = Math.floor(g.center.y);
            if (x >= 0 && y >= 0 && x < this.m_countX && y < this.m_countY) {
                queue.Push(new b2VoronoiDiagram_Task(x, y, x + y * this.m_countX, g));
            }
        }
        while (!queue.Empty()) {
            const task = queue.Front();
            const x = task.m_x;
            const y = task.m_y;
            const i = task.m_i;
            const g = task.m_generator;
            queue.Pop();
            if (!this.m_diagram[i]) {
                this.m_diagram[i] = g;
                if (x > 0) {
                    queue.Push(new b2VoronoiDiagram_Task(x - 1, y, i - 1, g));
                }
                if (y > 0) {
                    queue.Push(new b2VoronoiDiagram_Task(x, y - 1, i - this.m_countX, g));
                }
                if (x < this.m_countX - 1) {
                    queue.Push(new b2VoronoiDiagram_Task(x + 1, y, i + 1, g));
                }
                if (y < this.m_countY - 1) {
                    queue.Push(new b2VoronoiDiagram_Task(x, y + 1, i + this.m_countX, g));
                }
            }
        }
        for (let y = 0; y < this.m_countY; y++) {
            for (let x = 0; x < this.m_countX - 1; x++) {
                const i = x + y * this.m_countX;
                const a = this.m_diagram[i];
                const b = this.m_diagram[i + 1];
                if (a !== b) {
                    queue.Push(new b2VoronoiDiagram_Task(x, y, i, b));
                    queue.Push(new b2VoronoiDiagram_Task(x + 1, y, i + 1, a));
                }
            }
        }
        for (let y = 0; y < this.m_countY - 1; y++) {
            for (let x = 0; x < this.m_countX; x++) {
                const i = x + y * this.m_countX;
                const a = this.m_diagram[i];
                const b = this.m_diagram[i + this.m_countX];
                if (a !== b) {
                    queue.Push(new b2VoronoiDiagram_Task(x, y, i, b));
                    queue.Push(new b2VoronoiDiagram_Task(x, y + 1, i + this.m_countX, a));
                }
            }
        }
        while (!queue.Empty()) {
            const task = queue.Front();
            const x = task.m_x;
            const y = task.m_y;
            const i = task.m_i;
            const k = task.m_generator;
            queue.Pop();
            const a = this.m_diagram[i];
            const b = k;
            if (a !== b) {
                const ax = a.center.x - x;
                const ay = a.center.y - y;
                const bx = b.center.x - x;
                const by = b.center.y - y;
                const a2 = ax * ax + ay * ay;
                const b2 = bx * bx + by * by;
                if (a2 > b2) {
                    this.m_diagram[i] = b;
                    if (x > 0) {
                        queue.Push(new b2VoronoiDiagram_Task(x - 1, y, i - 1, b));
                    }
                    if (y > 0) {
                        queue.Push(new b2VoronoiDiagram_Task(x, y - 1, i - this.m_countX, b));
                    }
                    if (x < this.m_countX - 1) {
                        queue.Push(new b2VoronoiDiagram_Task(x + 1, y, i + 1, b));
                    }
                    if (y < this.m_countY - 1) {
                        queue.Push(new b2VoronoiDiagram_Task(x, y + 1, i + this.m_countX, b));
                    }
                }
            }
        }
    }
    /**
     * Enumerate all nodes that contain at least one necessary
     * generator.
     */
    GetNodes(callback) {
        for (let y = 0; y < this.m_countY - 1; y++) {
            for (let x = 0; x < this.m_countX - 1; x++) {
                const i = x + y * this.m_countX;
                const a = this.m_diagram[i];
                const b = this.m_diagram[i + 1];
                const c = this.m_diagram[i + this.m_countX];
                const d = this.m_diagram[i + 1 + this.m_countX];
                if (b !== c) {
                    if (a !== b && a !== c && (a.necessary || b.necessary || c.necessary)) {
                        callback(a.tag, b.tag, c.tag);
                    }
                    if (d !== b && d !== c && (a.necessary || b.necessary || c.necessary)) {
                        callback(b.tag, d.tag, c.tag);
                    }
                }
            }
        }
    }
}
export class b2VoronoiDiagram_Generator {
    constructor() {
        this.center = new b2Vec2();
        this.tag = 0;
        this.necessary = false;
    }
}
export class b2VoronoiDiagram_Task {
    constructor(x, y, i, g) {
        this.m_x = x;
        this.m_y = y;
        this.m_i = i;
        this.m_generator = g;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYjJWb3Jvbm9pRGlhZ3JhbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wYXJ0aWNsZS9iMlZvcm9ub2lEaWFncmFtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7O0dBZ0JHO0FBRUgsT0FBTyxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDMUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU5Qzs7R0FFRztBQUNILE1BQU0sT0FBTyxnQkFBZ0I7SUFRM0IsWUFBWSxpQkFBeUI7UUFOckMsd0JBQW1CLEdBQUcsQ0FBQyxDQUFDO1FBQ3hCLHFCQUFnQixHQUFHLENBQUMsQ0FBQztRQUNyQixhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsYUFBUSxHQUFHLENBQUMsQ0FBQztRQUNiLGNBQVMsR0FBaUMsRUFBRSxDQUFDO1FBRzNDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxXQUFXLENBQ2xDLGlCQUFpQixFQUNqQixDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsSUFBSSwwQkFBMEIsRUFBRSxDQUM1QyxDQUFDO1FBQ0YsSUFBSSxDQUFDLG1CQUFtQixHQUFHLGlCQUFpQixDQUFDO0lBQy9DLENBQUM7SUFFRDs7Ozs7O09BTUc7SUFDSCxZQUFZLENBQUMsTUFBYyxFQUFFLEdBQVcsRUFBRSxTQUFrQjtRQUMxRCxDQUFDLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDekUsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7UUFDMUQsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENB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RyxHQUFHLENBQUMsQ0FBQztRQUNiLElBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIENvcHlyaWdodCAoYykgMjAxMyBHb29nbGUsIEluYy5cclxuICpcclxuICogVGhpcyBzb2Z0d2FyZSBpcyBwcm92aWRlZCAnYXMtaXMnLCB3aXRob3V0IGFueSBleHByZXNzIG9yIGltcGxpZWRcclxuICogd2FycmFudHkuICBJbiBubyBldmVudCB3aWxsIHRoZSBhdXRob3JzIGJlIGhlbGQgbGlhYmxlIGZvciBhbnkgZGFtYWdlc1xyXG4gKiBhcmlzaW5nIGZyb20gdGhlIHVzZSBvZiB0aGlzIHNvZnR3YXJlLlxyXG4gKiBQZXJtaXNzaW9uIGlzIGdyYW50ZWQgdG8gYW55b25lIHRvIHVzZSB0aGlzIHNvZnR3YXJlIGZvciBhbnkgcHVycG9zZSxcclxuICogaW5jbHVkaW5nIGNvbW1lcmNpYWwgYXBwbGljYXRpb25zLCBhbmQgdG8gYWx0ZXIgaXQgYW5kIHJlZGlzdHJpYnV0ZSBpdFxyXG4gKiBmcmVlbHksIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyByZXN0cmljdGlvbnM6XHJcbiAqIDEuIFRoZSBvcmlnaW4gb2YgdGhpcyBzb2Z0d2FyZSBtdXN0IG5vdCBiZSBtaXNyZXByZXNlbnRlZDsgeW91IG11c3Qgbm90XHJcbiAqIGNsYWltIHRoYXQgeW91IHdyb3RlIHRoZSBvcmlnaW5hbCBzb2Z0d2FyZS4gSWYgeW91IHVzZSB0aGlzIHNvZnR3YXJlXHJcbiAqIGluIGEgcHJvZHVjdCwgYW4gYWNrbm93bGVkZ21lbnQgaW4gdGhlIHByb2R1Y3QgZG9jdW1lbnRhdGlvbiB3b3VsZCBiZVxyXG4gKiBhcHByZWNpYXRlZCBidXQgaXMgbm90IHJlcXVpcmVkLlxyXG4gKiAyLiBBbHRlcmVkIHNvdXJjZSB2ZXJzaW9ucyBtdXN0IGJlIHBsYWlubHkgbWFya2VkIGFzIHN1Y2gsIGFuZCBtdXN0IG5vdCBiZVxyXG4gKiBtaXNyZXByZXNlbnRlZCBhcyBiZWluZyB0aGUgb3JpZ2luYWwgc29mdHdhcmUuXHJcbiAqIDMuIFRoaXMgbm90aWNlIG1heSBub3QgYmUgcmVtb3ZlZCBvciBhbHRlcmVkIGZyb20gYW55IHNvdXJjZSBkaXN0cmlidXRpb24uXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgYjJfbWF4RmxvYXQsIGIyQXNzZXJ0LCBiMk1ha2VBcnJheSB9IGZyb20gJy4uL2NvbW1vbi9iMlNldHRpbmdzJztcclxuaW1wb3J0IHsgYjJWZWMyIH0gZnJvbSAnLi4vY29tbW9uL2IyTWF0aCc7XHJcbmltcG9ydCB7IGIyU3RhY2tRdWV1ZSB9IGZyb20gJy4vYjJTdGFja1F1ZXVlJztcclxuXHJcbi8qKlxyXG4gKiBBIGZpZWxkIHJlcHJlc2VudGluZyB0aGUgbmVhcmVzdCBnZW5lcmF0b3IgZnJvbSBlYWNoIHBvaW50LlxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIGIyVm9yb25vaURpYWdyYW0ge1xyXG4gIG1fZ2VuZXJhdG9yQnVmZmVyOiBiMlZvcm9ub2lEaWFncmFtX0dlbmVyYXRvcltdO1xyXG4gIG1fZ2VuZXJhdG9yQ2FwYWNpdHkgPSAwO1xyXG4gIG1fZ2VuZXJhdG9yQ291bnQgPSAwO1xyXG4gIG1fY291bnRYID0gMDtcclxuICBtX2NvdW50WSA9IDA7XHJcbiAgbV9kaWFncmFtOiBiMlZvcm9ub2lEaWFncmFtX0dlbmVyYXRvcltdID0gW107XHJcblxyXG4gIGNvbnN0cnVjdG9yKGdlbmVyYXRvckNhcGFjaXR5OiBudW1iZXIpIHtcclxuICAgIHRoaXMubV9nZW5lcmF0b3JCdWZmZXIgPSBiMk1ha2VBcnJheShcclxuICAgICAgZ2VuZXJhdG9yQ2FwYWNpdHksXHJcbiAgICAgIChpbmRleCkgPT4gbmV3IGIyVm9yb25vaURpYWdyYW1fR2VuZXJhdG9yKCksXHJcbiAgICApO1xyXG4gICAgdGhpcy5tX2dlbmVyYXRvckNhcGFjaXR5ID0gZ2VuZXJhdG9yQ2FwYWNpdHk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBZGQgYSBnZW5lcmF0b3IuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gY2VudGVyIHRoZSBwb3NpdGlvbiBvZiB0aGUgZ2VuZXJhdG9yLlxyXG4gICAqIEBwYXJhbSB0YWcgYSB0YWcgdXNlZCB0byBpZGVudGlmeSB0aGUgZ2VuZXJhdG9yIGluIGNhbGxiYWNrIGZ1bmN0aW9ucy5cclxuICAgKiBAcGFyYW0gbmVjZXNzYXJ5IHdoZXRoZXIgdG8gY2FsbGJhY2sgZm9yIG5vZGVzIGFzc29jaWF0ZWQgd2l0aCB0aGUgZ2VuZXJhdG9yLlxyXG4gICAqL1xyXG4gIEFkZEdlbmVyYXRvcihjZW50ZXI6IGIyVmVjMiwgdGFnOiBudW1iZXIsIG5lY2Vzc2FyeTogYm9vbGVhbik6IHZvaWQge1xyXG4gICAgISFCMl9ERUJVRyAmJiBiMkFzc2VydCh0aGlzLm1fZ2VuZXJhdG9yQ291bnQgPCB0aGlzLm1fZ2VuZXJhdG9yQ2FwYWNpdHkpO1xyXG4gICAgY29uc3QgZyA9IHRoaXMubV9nZW5lcmF0b3JCdWZmZXJbdGhpcy5tX2dlbmVyYXRvckNvdW50KytdO1xyXG4gICAgZy5jZW50ZXIuQ29weShjZW50ZXIpO1xyXG4gICAgZy50YWcgPSB0YWc7XHJcbiAgICBnLm5lY2Vzc2FyeSA9IG5lY2Vzc2FyeTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdlbmVyYXRlIHRoZSBWb3Jvbm9pIGRpYWdyYW0uIEl0IGlzIHJhc3Rlcml6ZWQgd2l0aCBhIGdpdmVuXHJcbiAgICogaW50ZXJ2YWwgaW4gdGhlIHNhbWUgcmFuZ2UgYXMgdGhlIG5lY2Vzc2FyeSBnZW5lcmF0b3JzIGV4aXN0LlxyXG4gICAqXHJcbiAgICogQHBhcmFtIHJhZGl1cyB0aGUgaW50ZXJ2YWwgb2YgdGhlIGRpYWdyYW0uXHJcbiAgICogQHBhcmFtIG1hcmdpbiBtYXJnaW4gZm9yIHdoaWNoIHRoZSByYW5nZSBvZiB0aGUgZGlhZ3JhbSBpcyBleHRlbmRlZC5cclxuICAgKi9cclxuICBHZW5lcmF0ZShyYWRpdXM6IG51bWJlciwgbWFyZ2luOiBudW1iZXIpOiB2b2lkIHtcclxuICAgIGNvbnN0IGludmVyc2VSYWRpdXMgPSAxIC8gcmFkaXVzO1xyXG4gICAgY29uc3QgbG93ZXIgPSBuZXcgYjJWZWMyKCtiMl9tYXhGbG9hdCwgK2IyX21heEZsb2F0KTtcclxuICAgIGNvbnN0IHVwcGVyID0gbmV3IGIyVmVjMigtYjJfbWF4RmxvYXQsIC1iMl9tYXhGbG9hdCk7XHJcbiAgICBsZXQgbmVjZXNzYXJ5X2NvdW50ID0gMDtcclxuICAgIGZvciAobGV0IGsgPSAwOyBrIDwgdGhpcy5tX2dlbmVyYXRvckNvdW50OyBrKyspIHtcclxuICAgICAgY29uc3QgZyA9IHRoaXMubV9nZW5lcmF0b3JCdWZmZXJba107XHJcbiAgICAgIGlmIChnLm5lY2Vzc2FyeSkge1xyXG4gICAgICAgIGIyVmVjMi5NaW5WKGxvd2VyLCBnLmNlbnRlciwgbG93ZXIpO1xyXG4gICAgICAgIGIyVmVjMi5NYXhWKHVwcGVyLCBnLmNlbnRlciwgdXBwZXIpO1xyXG4gICAgICAgICsrbmVjZXNzYXJ5X2NvdW50O1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAobmVjZXNzYXJ5X2NvdW50ID09PSAwKSB7XHJcbiAgICAgIC8vL2RlYnVnZ2VyO1xyXG4gICAgICB0aGlzLm1fY291bnRYID0gMDtcclxuICAgICAgdGhpcy5tX2NvdW50WSA9IDA7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGxvd2VyLnggLT0gbWFyZ2luO1xyXG4gICAgbG93ZXIueSAtPSBtYXJnaW47XHJcbiAgICB1cHBlci54ICs9IG1hcmdpbjtcclxuICAgIHVwcGVyLnkgKz0gbWFyZ2luO1xyXG4gICAgdGhpcy5tX2NvdW50WCA9IDEgKyBNYXRoLmZsb29yKGludmVyc2VSYWRpdXMgKiAodXBwZXIueCAtIGxvd2VyLngpKTtcclxuICAgIHRoaXMubV9jb3VudFkgPSAxICsgTWF0aC5mbG9vcihpbnZlcnNlUmFkaXVzICogKHVwcGVyLnkgLSBsb3dlci55KSk7XHJcbiAgICB0aGlzLm1fZGlhZ3JhbSA9IFtdOyAvLyBiMk1ha2VBcnJheSh0aGlzLm1fY291bnRYICogdGhpcy5tX2NvdW50WSwgKGluZGV4KSA9PiBudWxsKTtcclxuXHJcbiAgICAvLyAoNCAqIG1fY291bnRYICogbV9jb3VudFkpIGlzIHRoZSBxdWV1ZSBjYXBhY2l0eSB0aGF0IGlzIGV4cGVyaW1lbnRhbGx5XHJcbiAgICAvLyBrbm93biB0byBiZSBuZWNlc3NhcnkgYW5kIHN1ZmZpY2llbnQgZm9yIGdlbmVyYWwgcGFydGljbGUgZGlzdHJpYnV0aW9ucy5cclxuICAgIGNvbnN0IHF1ZXVlID0gbmV3IGIyU3RhY2tRdWV1ZTxiMlZvcm9ub2lEaWFncmFtX1Rhc2s+KDQgKiB0aGlzLm1fY291bnRYICogdGhpcy5tX2NvdW50WSk7XHJcbiAgICBmb3IgKGxldCBrID0gMDsgayA8IHRoaXMubV9nZW5lcmF0b3JDb3VudDsgaysrKSB7XHJcbiAgICAgIGNvbnN0IGcgPSB0aGlzLm1fZ2VuZXJhdG9yQnVmZmVyW2tdO1xyXG4gICAgICAvLy8gIGcuY2VudGVyID0gaW52ZXJzZVJhZGl1cyAqIChnLmNlbnRlciAtIGxvd2VyKTtcclxuICAgICAgZy5jZW50ZXIuU2VsZlN1Yihsb3dlcikuU2VsZk11bChpbnZlcnNlUmFkaXVzKTtcclxuICAgICAgY29uc3QgeCA9IE1hdGguZmxvb3IoZy5jZW50ZXIueCk7XHJcbiAgICAgIGNvbnN0IHkgPSBNYXRoLmZsb29yKGcuY2VudGVyLnkpO1xyXG4gICAgICBpZiAoeCA+PSAwICYmIHkgPj0gMCAmJiB4IDwgdGhpcy5tX2NvdW50WCAmJiB5IDwgdGhpcy5tX2NvdW50WSkge1xyXG4gICAgICAgIHF1ZXVlLlB1c2gobmV3IGIyVm9yb25vaURpYWdyYW1fVGFzayh4LCB5LCB4ICsgeSAqIHRoaXMubV9jb3VudFgsIGcpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgd2hpbGUgKCFxdWV1ZS5FbXB0eSgpKSB7XHJcbiAgICAgIGNvbnN0IHRhc2sgPSBxdWV1ZS5Gcm9udCgpO1xyXG4gICAgICBjb25zdCB4ID0gdGFzay5tX3g7XHJcbiAgICAgIGNvbnN0IHkgPSB0YXNrLm1feTtcclxuICAgICAgY29uc3QgaSA9IHRhc2subV9pO1xyXG4gICAgICBjb25zdCBnID0gdGFzay5tX2dlbmVyYXRvcjtcclxuICAgICAgcXVldWUuUG9wKCk7XHJcbiAgICAgIGlmICghdGhpcy5tX2RpYWdyYW1baV0pIHtcclxuICAgICAgICB0aGlzLm1fZGlhZ3JhbVtpXSA9IGc7XHJcbiAgICAgICAgaWYgKHggPiAwKSB7XHJcbiAgICAgICAgICBxdWV1ZS5QdXNoKG5ldyBiMlZvcm9ub2lEaWFncmFtX1Rhc2soeCAtIDEsIHksIGkgLSAxLCBnKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh5ID4gMCkge1xyXG4gICAgICAgICAgcXVldWUuUHVzaChuZXcgYjJWb3Jvbm9pRGlhZ3JhbV9UYXNrKHgsIHkgLSAxLCBpIC0gdGhpcy5tX2NvdW50WCwgZykpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoeCA8IHRoaXMubV9jb3VudFggLSAxKSB7XHJcbiAgICAgICAgICBxdWV1ZS5QdXNoKG5ldyBiMlZvcm9ub2lEaWFncmFtX1Rhc2soeCArIDEsIHksIGkgKyAxLCBnKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh5IDwgdGhpcy5tX2NvdW50WSAtIDEpIHtcclxuICAgICAgICAgIHF1ZXVlLlB1c2gobmV3IGIyVm9yb25vaURpYWdyYW1fVGFzayh4LCB5ICsgMSwgaSArIHRoaXMubV9jb3VudFgsIGcpKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGZvciAobGV0IHkgPSAwOyB5IDwgdGhpcy5tX2NvdW50WTsgeSsrKSB7XHJcbiAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgdGhpcy5tX2NvdW50WCAtIDE7IHgrKykge1xyXG4gICAgICAgIGNvbnN0IGkgPSB4ICsgeSAqIHRoaXMubV9jb3VudFg7XHJcbiAgICAgICAgY29uc3QgYSA9IHRoaXMubV9kaWFncmFtW2ldO1xyXG4gICAgICAgIGNvbnN0IGIgPSB0aGlzLm1fZGlhZ3JhbVtpICsgMV07XHJcbiAgICAgICAgaWYgKGEgIT09IGIpIHtcclxuICAgICAgICAgIHF1ZXVlLlB1c2gobmV3IGIyVm9yb25vaURpYWdyYW1fVGFzayh4LCB5LCBpLCBiKSk7XHJcbiAgICAgICAgICBxdWV1ZS5QdXNoKG5ldyBiMlZvcm9ub2lEaWFncmFtX1Rhc2soeCArIDEsIHksIGkgKyAxLCBhKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRoaXMubV9jb3VudFkgLSAxOyB5KyspIHtcclxuICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLm1fY291bnRYOyB4KyspIHtcclxuICAgICAgICBjb25zdCBpID0geCArIHkgKiB0aGlzLm1fY291bnRYO1xyXG4gICAgICAgIGNvbnN0IGEgPSB0aGlzLm1fZGlhZ3JhbVtpXTtcclxuICAgICAgICBjb25zdCBiID0gdGhpcy5tX2RpYWdyYW1baSArIHRoaXMubV9jb3VudFhdO1xyXG4gICAgICAgIGlmIChhICE9PSBiKSB7XHJcbiAgICAgICAgICBxdWV1ZS5QdXNoKG5ldyBiMlZvcm9ub2lEaWFncmFtX1Rhc2soeCwgeSwgaSwgYikpO1xyXG4gICAgICAgICAgcXVldWUuUHVzaChuZXcgYjJWb3Jvbm9pRGlhZ3JhbV9UYXNrKHgsIHkgKyAxLCBpICsgdGhpcy5tX2NvdW50WCwgYSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgd2hpbGUgKCFxdWV1ZS5FbXB0eSgpKSB7XHJcbiAgICAgIGNvbnN0IHRhc2sgPSBxdWV1ZS5Gcm9udCgpO1xyXG4gICAgICBjb25zdCB4ID0gdGFzay5tX3g7XHJcbiAgICAgIGNvbnN0IHkgPSB0YXNrLm1feTtcclxuICAgICAgY29uc3QgaSA9IHRhc2subV9pO1xyXG4gICAgICBjb25zdCBrID0gdGFzay5tX2dlbmVyYXRvcjtcclxuICAgICAgcXVldWUuUG9wKCk7XHJcbiAgICAgIGNvbnN0IGEgPSB0aGlzLm1fZGlhZ3JhbVtpXTtcclxuICAgICAgY29uc3QgYiA9IGs7XHJcbiAgICAgIGlmIChhICE9PSBiKSB7XHJcbiAgICAgICAgY29uc3QgYXggPSBhLmNlbnRlci54IC0geDtcclxuICAgICAgICBjb25zdCBheSA9IGEuY2VudGVyLnkgLSB5O1xyXG4gICAgICAgIGNvbnN0IGJ4ID0gYi5jZW50ZXIueCAtIHg7XHJcbiAgICAgICAgY29uc3QgYnkgPSBiLmNlbnRlci55IC0geTtcclxuICAgICAgICBjb25zdCBhMiA9IGF4ICogYXggKyBheSAqIGF5O1xyXG4gICAgICAgIGNvbnN0IGIyID0gYnggKiBieCArIGJ5ICogYnk7XHJcbiAgICAgICAgaWYgKGEyID4gYjIpIHtcclxuICAgICAgICAgIHRoaXMubV9kaWFncmFtW2ldID0gYjtcclxuICAgICAgICAgIGlmICh4ID4gMCkge1xyXG4gICAgICAgICAgICBxdWV1ZS5QdXNoKG5ldyBiMlZvcm9ub2lEaWFncmFtX1Rhc2soeCAtIDEsIHksIGkgLSAxLCBiKSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBpZiAoeSA+IDApIHtcclxuICAgICAgICAgICAgcXVldWUuUHVzaChuZXcgYjJWb3Jvbm9pRGlhZ3JhbV9UYXNrKHgsIHkgLSAxLCBpIC0gdGhpcy5tX2NvdW50WCwgYikpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKHggPCB0aGlzLm1fY291bnRYIC0gMSkge1xyXG4gICAgICAgICAgICBxdWV1ZS5QdXNoKG5ldyBiMlZvcm9ub2lEaWFncmFtX1Rhc2soeCArIDEsIHksIGkgKyAxLCBiKSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBpZiAoeSA8IHRoaXMubV9jb3VudFkgLSAxKSB7XHJcbiAgICAgICAgICAgIHF1ZXVlLlB1c2gobmV3IGIyVm9yb25vaURpYWdyYW1fVGFzayh4LCB5ICsgMSwgaSArIHRoaXMubV9jb3VudFgsIGIpKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEVudW1lcmF0ZSBhbGwgbm9kZXMgdGhhdCBjb250YWluIGF0IGxlYXN0IG9uZSBuZWNlc3NhcnlcclxuICAgKiBnZW5lcmF0b3IuXHJcbiAgICovXHJcbiAgR2V0Tm9kZXMoY2FsbGJhY2s6IGIyVm9yb25vaURpYWdyYW1fTm9kZUNhbGxiYWNrKTogdm9pZCB7XHJcbiAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRoaXMubV9jb3VudFkgLSAxOyB5KyspIHtcclxuICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLm1fY291bnRYIC0gMTsgeCsrKSB7XHJcbiAgICAgICAgY29uc3QgaSA9IHggKyB5ICogdGhpcy5tX2NvdW50WDtcclxuICAgICAgICBjb25zdCBhID0gdGhpcy5tX2RpYWdyYW1baV07XHJcbiAgICAgICAgY29uc3QgYiA9IHRoaXMubV9kaWFncmFtW2kgKyAxXTtcclxuICAgICAgICBjb25zdCBjID0gdGhpcy5tX2RpYWdyYW1baSArIHRoaXMubV9jb3VudFhdO1xyXG4gICAgICAgIGNvbnN0IGQgPSB0aGlzLm1fZGlhZ3JhbVtpICsgMSArIHRoaXMubV9jb3VudFhdO1xyXG4gICAgICAgIGlmIChiICE9PSBjKSB7XHJcbiAgICAgICAgICBpZiAoYSAhPT0gYiAmJiBhICE9PSBjICYmIChhLm5lY2Vzc2FyeSB8fCBiLm5lY2Vzc2FyeSB8fCBjLm5lY2Vzc2FyeSkpIHtcclxuICAgICAgICAgICAgY2FsbGJhY2soYS50YWcsIGIudGFnLCBjLnRhZyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBpZiAoZCAhPT0gYiAmJiBkICE9PSBjICYmIChhLm5lY2Vzc2FyeSB8fCBiLm5lY2Vzc2FyeSB8fCBjLm5lY2Vzc2FyeSkpIHtcclxuICAgICAgICAgICAgY2FsbGJhY2soYi50YWcsIGQudGFnLCBjLnRhZyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogQ2FsbGJhY2sgdXNlZCBieSBHZXROb2RlcygpLlxyXG4gKlxyXG4gKiBSZWNlaXZlIHRhZ3MgZm9yIGdlbmVyYXRvcnMgYXNzb2NpYXRlZCB3aXRoIGEgbm9kZS5cclxuICovXHJcbmV4cG9ydCB0eXBlIGIyVm9yb25vaURpYWdyYW1fTm9kZUNhbGxiYWNrID0gKGE6IG51bWJlciwgYjogbnVtYmVyLCBjOiBudW1iZXIpID0+IHZvaWQ7XHJcblxyXG5leHBvcnQgY2xhc3MgYjJWb3Jvbm9pRGlhZ3JhbV9HZW5lcmF0b3Ige1xyXG4gIGNlbnRlciA9IG5ldyBiMlZlYzIoKTtcclxuICB0YWcgPSAwO1xyXG4gIG5lY2Vzc2FyeSA9IGZhbHNlO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgYjJWb3Jvbm9pRGlhZ3JhbV9UYXNrIHtcclxuICBtX3g6IG51bWJlcjsgLy8gaW50XHJcbiAgbV95OiBudW1iZXI7IC8vIGludFxyXG4gIG1faTogbnVtYmVyOyAvLyBpbnRcclxuICBtX2dlbmVyYXRvcjogYjJWb3Jvbm9pRGlhZ3JhbV9HZW5lcmF0b3I7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHg6IG51bWJlciwgeTogbnVtYmVyLCBpOiBudW1iZXIsIGc6IGIyVm9yb25vaURpYWdyYW1fR2VuZXJhdG9yKSB7XHJcbiAgICB0aGlzLm1feCA9IHg7XHJcbiAgICB0aGlzLm1feSA9IHk7XHJcbiAgICB0aGlzLm1faSA9IGk7XHJcbiAgICB0aGlzLm1fZ2VuZXJhdG9yID0gZztcclxuICB9XHJcbn1cclxuIl19