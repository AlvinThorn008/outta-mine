/*
 * Copyright (c) 2006-2010 Erin Catto http://www.box2d.org
 *
 * This software is provided 'as-is', without any express or implied
 * warranty.  In no event will the authors be held liable for any damages
 * arising from the use of this software.
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 * 1. The origin of this software must not be misrepresented; you must not
 * claim that you wrote the original software. If you use this software
 * in a product, an acknowledgment in the product documentation would be
 * appreciated but is not required.
 * 2. Altered source versions must be plainly marked as such, and must not be
 * misrepresented as being the original software.
 * 3. This notice may not be removed or altered from any source distribution.
 */
import { b2_polygonRadius, b2Assert } from '../../common/b2Settings';
import { b2Transform, b2Vec2 } from '../../common/b2Math';
import { b2Shape } from './b2Shape';
import { b2EdgeShape } from './b2EdgeShape';
/// A chain shape is a free form sequence of line segments.
/// The chain has two-sided collision, so you can use inside and outside collision.
/// Therefore, you may use any winding order.
/// Since there may be many vertices, they are allocated using b2Alloc.
/// Connectivity information is used to create smooth collisions.
/// WARNING: The chain will not collide properly if there are self-intersections.
export class b2ChainShape extends b2Shape {
    constructor() {
        super(3 /* e_chainShape */, b2_polygonRadius);
        this.m_vertices = [];
        this.m_count = 0;
        this.m_prevVertex = new b2Vec2();
        this.m_nextVertex = new b2Vec2();
        this.m_hasPrevVertex = false;
        this.m_hasNextVertex = false;
    }
    CreateLoop(...args) {
        if (typeof args[0][0] === 'number') {
            const vertices = args[0];
            if (vertices.length % 2 !== 0) {
                throw new Error();
            }
            return this._CreateLoop((index) => ({
                x: vertices[index * 2],
                y: vertices[index * 2 + 1],
            }), vertices.length / 2);
        }
        else {
            const vertices = args[0];
            const count = args[1] || vertices.length;
            return this._CreateLoop((index) => vertices[index], count);
        }
    }
    _CreateLoop(vertices, count) {
        !!B2_DEBUG && b2Assert(count >= 3);
        if (count < 3) {
            return this;
        }
        // DEBUG: for (let i: number = 1; i < count; ++i) {
        // DEBUG:   const v1 = vertices[start + i - 1];
        // DEBUG:   const v2 = vertices[start + i];
        // DEBUG:   // If the code crashes here, it means your vertices are too close together.
        // DEBUG:   b2Assert(b2Vec2.DistanceSquaredVV(v1, v2) > b2_linearSlop * b2_linearSlop);
        // DEBUG: }
        this.m_count = count + 1;
        this.m_vertices = b2Vec2.MakeArray(this.m_count);
        for (let i = 0; i < count; ++i) {
            this.m_vertices[i].Copy(vertices(i));
        }
        this.m_vertices[count].Copy(this.m_vertices[0]);
        this.m_prevVertex.Copy(this.m_vertices[this.m_count - 2]);
        this.m_nextVertex.Copy(this.m_vertices[1]);
        this.m_hasPrevVertex = true;
        this.m_hasNextVertex = true;
        return this;
    }
    CreateChain(...args) {
        if (typeof args[0][0] === 'number') {
            const vertices = args[0];
            if (vertices.length % 2 !== 0) {
                throw new Error();
            }
            return this._CreateChain((index) => ({
                x: vertices[index * 2],
                y: vertices[index * 2 + 1],
            }), vertices.length / 2);
        }
        else {
            const vertices = args[0];
            const count = args[1] || vertices.length;
            return this._CreateChain((index) => vertices[index], count);
        }
    }
    _CreateChain(vertices, count) {
        !!B2_DEBUG && b2Assert(count >= 2);
        // DEBUG: for (let i: number = 1; i < count; ++i) {
        // DEBUG:   const v1 = vertices[start + i - 1];
        // DEBUG:   const v2 = vertices[start + i];
        // DEBUG:   // If the code crashes here, it means your vertices are too close together.
        // DEBUG:   b2Assert(b2Vec2.DistanceSquaredVV(v1, v2) > b2_linearSlop * b2_linearSlop);
        // DEBUG: }
        this.m_count = count;
        this.m_vertices = b2Vec2.MakeArray(count);
        for (let i = 0; i < count; ++i) {
            this.m_vertices[i].Copy(vertices(i));
        }
        this.m_hasPrevVertex = false;
        this.m_hasNextVertex = false;
        this.m_prevVertex.SetZero();
        this.m_nextVertex.SetZero();
        return this;
    }
    /// Establish connectivity to a vertex that precedes the first vertex.
    /// Don't call this for loops.
    SetPrevVertex(prevVertex) {
        this.m_prevVertex.Copy(prevVertex);
        this.m_hasPrevVertex = true;
        return this;
    }
    /// Establish connectivity to a vertex that follows the last vertex.
    /// Don't call this for loops.
    SetNextVertex(nextVertex) {
        this.m_nextVertex.Copy(nextVertex);
        this.m_hasNextVertex = true;
        return this;
    }
    /// Implement b2Shape. Vertices are cloned using b2Alloc.
    Clone() {
        return new b2ChainShape().Copy(this);
    }
    Copy(other) {
        super.Copy(other);
        !!B2_DEBUG && b2Assert(other instanceof b2ChainShape);
        this._CreateChain((index) => other.m_vertices[index], other.m_count);
        this.m_prevVertex.Copy(other.m_prevVertex);
        this.m_nextVertex.Copy(other.m_nextVertex);
        this.m_hasPrevVertex = other.m_hasPrevVertex;
        this.m_hasNextVertex = other.m_hasNextVertex;
        return this;
    }
    /// @see b2Shape::GetChildCount
    GetChildCount() {
        // edge count = vertex count - 1
        return this.m_count - 1;
    }
    /// Get a child edge.
    GetChildEdge(edge, index) {
        !!B2_DEBUG && b2Assert(0 <= index && index < this.m_count - 1);
        edge.m_radius = this.m_radius;
        edge.m_vertex1.Copy(this.m_vertices[index]);
        edge.m_vertex2.Copy(this.m_vertices[index + 1]);
        if (index > 0) {
            edge.m_vertex0.Copy(this.m_vertices[index - 1]);
            edge.m_hasVertex0 = true;
        }
        else {
            edge.m_vertex0.Copy(this.m_prevVertex);
            edge.m_hasVertex0 = this.m_hasPrevVertex;
        }
        if (index < this.m_count - 2) {
            edge.m_vertex3.Copy(this.m_vertices[index + 2]);
            edge.m_hasVertex3 = true;
        }
        else {
            edge.m_vertex3.Copy(this.m_nextVertex);
            edge.m_hasVertex3 = this.m_hasNextVertex;
        }
    }
    /// This always return false.
    /// @see b2Shape::TestPoint
    TestPoint(xf, p) {
        return false;
    }
    ComputeDistance(xf, p, normal, childIndex) {
        if (B2_ENABLE_PARTICLE) {
            const edge = b2ChainShape.ComputeDistance_s_edgeShape;
            this.GetChildEdge(edge, childIndex);
            return edge.ComputeDistance(xf, p, normal, 0);
        }
        else {
            return 0.0;
        }
    }
    RayCast(output, input, xf, childIndex) {
        !!B2_DEBUG && b2Assert(childIndex < this.m_count);
        const edgeShape = b2ChainShape.RayCast_s_edgeShape;
        edgeShape.m_vertex1.Copy(this.m_vertices[childIndex]);
        edgeShape.m_vertex2.Copy(this.m_vertices[(childIndex + 1) % this.m_count]);
        return edgeShape.RayCast(output, input, xf, 0);
    }
    ComputeAABB(aabb, xf, childIndex) {
        !!B2_DEBUG && b2Assert(childIndex < this.m_count);
        const vertexi1 = this.m_vertices[childIndex];
        const vertexi2 = this.m_vertices[(childIndex + 1) % this.m_count];
        const v1 = b2Transform.MulXV(xf, vertexi1, b2ChainShape.ComputeAABB_s_v1);
        const v2 = b2Transform.MulXV(xf, vertexi2, b2ChainShape.ComputeAABB_s_v2);
        b2Vec2.MinV(v1, v2, aabb.lowerBound);
        b2Vec2.MaxV(v1, v2, aabb.upperBound);
    }
    /// Chains have zero mass.
    /// @see b2Shape::ComputeMass
    ComputeMass(massData, density) {
        massData.mass = 0;
        massData.center.SetZero();
        massData.I = 0;
    }
    SetupDistanceProxy(proxy, index) {
        !!B2_DEBUG && b2Assert(0 <= index && index < this.m_count);
        proxy.m_vertices = proxy.m_buffer;
        proxy.m_vertices[0].Copy(this.m_vertices[index]);
        if (index + 1 < this.m_count) {
            proxy.m_vertices[1].Copy(this.m_vertices[index + 1]);
        }
        else {
            proxy.m_vertices[1].Copy(this.m_vertices[0]);
        }
        proxy.m_count = 2;
        proxy.m_radius = this.m_radius;
    }
    ComputeSubmergedArea(normal, offset, xf, c) {
        c.SetZero();
        return 0;
    }
}
/// @see b2Shape::ComputeDistance
b2ChainShape.ComputeDistance_s_edgeShape = new b2EdgeShape();
// #endif
/// Implement b2Shape.
b2ChainShape.RayCast_s_edgeShape = new b2EdgeShape();
/// @see b2Shape::ComputeAABB
b2ChainShape.ComputeAABB_s_v1 = new b2Vec2();
b2ChainShape.ComputeAABB_s_v2 = new b2Vec2();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYjJDaGFpblNoYXBlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbGxpc2lvbi9zaGFwZXMvYjJDaGFpblNoYXBlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7O0dBZ0JHO0FBRUgsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFNLE1BQU0scUJBQXFCLENBQUM7QUFHOUQsT0FBTyxFQUFjLE9BQU8sRUFBZSxNQUFNLFdBQVcsQ0FBQztBQUM3RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTVDLDJEQUEyRDtBQUMzRCxtRkFBbUY7QUFDbkYsNkNBQTZDO0FBQzdDLHVFQUF1RTtBQUN2RSxpRUFBaUU7QUFDakUsaUZBQWlGO0FBQ2pGLE1BQU0sT0FBTyxZQUFhLFNBQVEsT0FBTztJQVF2QztRQUNFLEtBQUssdUJBQTJCLGdCQUFnQixDQUFDLENBQUM7UUFScEQsZUFBVSxHQUFhLEVBQUUsQ0FBQztRQUMxQixZQUFPLEdBQUcsQ0FBQyxDQUFDO1FBQ0gsaUJBQVksR0FBRyxJQUFJLE1BQU0sRUFBRSxDQUFDO1FBQzVCLGlCQUFZLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUNyQyxvQkFBZSxHQUFHLEtBQUssQ0FBQztRQUN4QixvQkFBZSxHQUFHLEtBQUssQ0FBQztJQUl4QixDQUFDO0lBUUQsVUFBVSxDQUFDLEdBQUcsSUFBVztRQUN2QixJQUFJLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsRUFBRTtZQUNsQyxNQUFNLFFBQVEsR0FBYSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkMsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQzdCLE1BQU0sSUFBSSxL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UUFDbEMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ2pELElBQUksS0FBSyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQzVCLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDdEQ7YUFBTTtZQUNMLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUM5QztRQUNELEtBQUssQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLEtBQUssQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUNqQyxDQUFDO0lBRUQsb0JBQW9CLENBQUMsTUFBYyxFQUFFLE1BQWMsRUFBRSxFQUFlLEVBQUUsQ0FBUztRQUM3RSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDWixPQUFPLENBQUMsQ0FBQztJQUNYLENBQUM7O0FBNUVELGlDQUFpQztBQUNsQix3Q0FBMkIsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0FBWS9ELFNBQVM7QUFFVCxzQkFBc0I7QUFDUCxnQ0FBbUIsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0FBa0J2RCw2QkFBNkI7QUFDZCw2QkFBZ0IsR0FBRyxJQUFJLE1BQU0sRUFBRSxDQUFDO0FBQ2hDLDZCQUFnQixHQUFHLElBQUksTUFBTSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBDb3B5cmlnaHQgKGMpIDIwMDYtMjAxMCBFcmluIENhdHRvIGh0dHA6Ly93d3cuYm94MmQub3JnXHJcbiAqXHJcbiAqIFRoaXMgc29mdHdhcmUgaXMgcHJvdmlkZWQgJ2FzLWlzJywgd2l0aG91dCBhbnkgZXhwcmVzcyBvciBpbXBsaWVkXHJcbiAqIHdhcnJhbnR5LiAgSW4gbm8gZXZlbnQgd2lsbCB0aGUgYXV0aG9ycyBiZSBoZWxkIGxpYWJsZSBmb3IgYW55IGRhbWFnZXNcclxuICogYXJpc2luZyBmcm9tIHRoZSB1c2Ugb2YgdGhpcyBzb2Z0d2FyZS5cclxuICogUGVybWlzc2lvbiBpcyBncmFudGVkIHRvIGFueW9uZSB0byB1c2UgdGhpcyBzb2Z0d2FyZSBmb3IgYW55IHB1cnBvc2UsXHJcbiAqIGluY2x1ZGluZyBjb21tZXJjaWFsIGFwcGxpY2F0aW9ucywgYW5kIHRvIGFsdGVyIGl0IGFuZCByZWRpc3RyaWJ1dGUgaXRcclxuICogZnJlZWx5LCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgcmVzdHJpY3Rpb25zOlxyXG4gKiAxLiBUaGUgb3JpZ2luIG9mIHRoaXMgc29mdHdhcmUgbXVzdCBub3QgYmUgbWlzcmVwcmVzZW50ZWQ7IHlvdSBtdXN0IG5vdFxyXG4gKiBjbGFpbSB0aGF0IHlvdSB3cm90ZSB0aGUgb3JpZ2luYWwgc29mdHdhcmUuIElmIHlvdSB1c2UgdGhpcyBzb2Z0d2FyZVxyXG4gKiBpbiBhIHByb2R1Y3QsIGFuIGFja25vd2xlZGdtZW50IGluIHRoZSBwcm9kdWN0IGRvY3VtZW50YXRpb24gd291bGQgYmVcclxuICogYXBwcmVjaWF0ZWQgYnV0IGlzIG5vdCByZXF1aXJlZC5cclxuICogMi4gQWx0ZXJlZCBzb3VyY2UgdmVyc2lvbnMgbXVzdCBiZSBwbGFpbmx5IG1hcmtlZCBhcyBzdWNoLCBhbmQgbXVzdCBub3QgYmVcclxuICogbWlzcmVwcmVzZW50ZWQgYXMgYmVpbmcgdGhlIG9yaWdpbmFsIHNvZnR3YXJlLlxyXG4gKiAzLiBUaGlzIG5vdGljZSBtYXkgbm90IGJlIHJlbW92ZWQgb3IgYWx0ZXJlZCBmcm9tIGFueSBzb3VyY2UgZGlzdHJpYnV0aW9uLlxyXG4gKi9cclxuXHJcbmltcG9ydCB7IGIyX3BvbHlnb25SYWRpdXMsIGIyQXNzZXJ0IH0gZnJvbSAnLi4vLi4vY29tbW9uL2IyU2V0dGluZ3MnO1xyXG5pbXBvcnQgeyBiMlRyYW5zZm9ybSwgYjJWZWMyLCBYWSB9IGZyb20gJy4uLy4uL2NvbW1vbi9iMk1hdGgnO1xyXG5pbXBvcnQgeyBiMkFBQkIsIGIyUmF5Q2FzdElucHV0LCBiMlJheUNhc3RPdXRwdXQgfSBmcm9tICcuLi9iMkNvbGxpc2lvbic7XHJcbmltcG9ydCB7IGIyRGlzdGFuY2VQcm94eSB9IGZyb20gJy4uL2IyRGlzdGFuY2UnO1xyXG5pbXBvcnQgeyBiMk1hc3NEYXRhLCBiMlNoYXBlLCBiMlNoYXBlVHlwZSB9IGZyb20gJy4vYjJTaGFwZSc7XHJcbmltcG9ydCB7IGIyRWRnZVNoYXBlIH0gZnJvbSAnLi9iMkVkZ2VTaGFwZSc7XHJcblxyXG4vLy8gQSBjaGFpbiBzaGFwZSBpcyBhIGZyZWUgZm9ybSBzZXF1ZW5jZSBvZiBsaW5lIHNlZ21lbnRzLlxyXG4vLy8gVGhlIGNoYWluIGhhcyB0d28tc2lkZWQgY29sbGlzaW9uLCBzbyB5b3UgY2FuIHVzZSBpbnNpZGUgYW5kIG91dHNpZGUgY29sbGlzaW9uLlxyXG4vLy8gVGhlcmVmb3JlLCB5b3UgbWF5IHVzZSBhbnkgd2luZGluZyBvcmRlci5cclxuLy8vIFNpbmNlIHRoZXJlIG1heSBiZSBtYW55IHZlcnRpY2VzLCB0aGV5IGFyZSBhbGxvY2F0ZWQgdXNpbmcgYjJBbGxvYy5cclxuLy8vIENvbm5lY3Rpdml0eSBpbmZvcm1hdGlvbiBpcyB1c2VkIHRvIGNyZWF0ZSBzbW9vdGggY29sbGlzaW9ucy5cclxuLy8vIFdBUk5JTkc6IFRoZSBjaGFpbiB3aWxsIG5vdCBjb2xsaWRlIHByb3Blcmx5IGlmIHRoZXJlIGFyZSBzZWxmLWludGVyc2VjdGlvbnMuXHJcbmV4cG9ydCBjbGFzcyBiMkNoYWluU2hhcGUgZXh0ZW5kcyBiMlNoYXBlIHtcclxuICBtX3ZlcnRpY2VzOiBiMlZlYzJbXSA9IFtdO1xyXG4gIG1fY291bnQgPSAwO1xyXG4gIHJlYWRvbmx5IG1fcHJldlZlcnRleCA9IG5ldyBiMlZlYzIoKTtcclxuICByZWFkb25seSBtX25leHRWZXJ0ZXggPSBuZXcgYjJWZWMyKCk7XHJcbiAgbV9oYXNQcmV2VmVydGV4ID0gZmFsc2U7XHJcbiAgbV9oYXNOZXh0VmVydGV4ID0gZmFsc2U7XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgc3VwZXIoYjJTaGFwZVR5cGUuZV9jaGFpblNoYXBlLCBiMl9wb2x5Z29uUmFkaXVzKTtcclxuICB9XHJcblxyXG4gIC8vLyBDcmVhdGUgYSBsb29wLiBUaGlzIGF1dG9tYXRpY2FsbHkgYWRqdXN0cyBjb25uZWN0aXZpdHkuXHJcbiAgLy8vIEBwYXJhbSB2ZXJ0aWNlcyBhbiBhcnJheSBvZiB2ZXJ0aWNlcywgdGhlc2UgYXJlIGNvcGllZFxyXG4gIC8vLyBAcGFyYW0gY291bnQgdGhlIHZlcnRleCBjb3VudFxyXG4gIENyZWF0ZUxvb3AodmVydGljZXM6IFhZW10pOiBiMkNoYWluU2hhcGU7XHJcbiAgQ3JlYXRlTG9vcCh2ZXJ0aWNlczogWFlbXSwgY291bnQ6IG51bWJlcik6IGIyQ2hhaW5TaGFwZTtcclxuICBDcmVhdGVMb29wKHZlcnRpY2VzOiBudW1iZXJbXSk6IGIyQ2hhaW5TaGFwZTtcclxuICBDcmVhdGVMb29wKC4uLmFyZ3M6IGFueVtdKTogYjJDaGFpblNoYXBlIHtcclxuICAgIGlmICh0eXBlb2YgYXJnc1swXVswXSA9PT0gJ251bWJlcicpIHtcclxuICAgICAgY29uc3QgdmVydGljZXM6IG51bWJlcltdID0gYXJnc1swXTtcclxuICAgICAgaWYgKHZlcnRpY2VzLmxlbmd0aCAlIDIgIT09IDApIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdGhpcy5fQ3JlYXRlTG9vcChcclxuICAgICAgICAoaW5kZXg6IG51bWJlcik6IFhZID0+ICh7XHJcbiAgICAgICAgICB4OiB2ZXJ0aWNlc1tpbmRleCAqIDJdLFxyXG4gICAgICAgICAgeTogdmVydGljZXNbaW5kZXggKiAyICsgMV0sXHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgdmVydGljZXMubGVuZ3RoIC8gMixcclxuICAgICAgKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IHZlcnRpY2VzOiBYWVtdID0gYXJnc1swXTtcclxuICAgICAgY29uc3QgY291bnQ6IG51bWJlciA9IGFyZ3NbMV0gfHwgdmVydGljZXMubGVuZ3RoO1xyXG4gICAgICByZXR1cm4gdGhpcy5fQ3JlYXRlTG9vcCgoaW5kZXg6IG51bWJlcik6IFhZID0+IHZlcnRpY2VzW2luZGV4XSwgY291bnQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfQ3JlYXRlTG9vcCh2ZXJ0aWNlczogKGluZGV4OiBudW1iZXIpID0+IFhZLCBjb3VudDogbnVtYmVyKTogYjJDaGFpblNoYXBlIHtcclxuICAgICEhQjJfREVCVUcgJiYgYjJBc3NlcnQoY291bnQgPj0gMyk7XHJcbiAgICBpZiAoY291bnQgPCAzKSB7XHJcbiAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG4gICAgLy8gREVCVUc6IGZvciAobGV0IGk6IG51bWJlciA9IDE7IGkgPCBjb3VudDsgKytpKSB7XHJcbiAgICAvLyBERUJVRzogICBjb25zdCB2MSA9IHZlcnRpY2VzW3N0YXJ0ICsgaSAtIDFdO1xyXG4gICAgLy8gREVCVUc6ICAgY29uc3QgdjIgPSB2ZXJ0aWNlc1tzdGFydCArIGldO1xyXG4gICAgLy8gREVCVUc6ICAgLy8gSWYgdGhlIGNvZGUgY3Jhc2hlcyBoZXJlLCBpdCBtZWFucyB5b3VyIHZlcnRpY2VzIGFyZSB0b28gY2xvc2UgdG9nZXRoZXIuXHJcbiAgICAvLyBERUJVRzogICBiMkFzc2VydChiMlZlYzIuRGlzdGFuY2VTcXVhcmVkVlYodjEsIHYyKSA+IGIyX2xpbmVhclNsb3AgKiBiMl9saW5lYXJTbG9wKTtcclxuICAgIC8vIERFQlVHOiB9XHJcblxyXG4gICAgdGhpcy5tX2NvdW50ID0gY291bnQgKyAxO1xyXG4gICAgdGhpcy5tX3ZlcnRpY2VzID0gYjJWZWMyLk1ha2VBcnJheSh0aGlzLm1fY291bnQpO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgKytpKSB7XHJcbiAgICAgIHRoaXMubV92ZXJ0aWNlc1tpXS5Db3B5KHZlcnRpY2VzKGkpKTtcclxuICAgIH1cclxuICAgIHRoaXMubV92ZXJ0aWNlc1tjb3VudF0uQ29weSh0aGlzLm1fdmVydGljZXNbMF0pO1xyXG4gICAgdGhpcy5tX3ByZXZWZXJ0ZXguQ29weSh0aGlzLm1fdmVydGljZXNbdGhpcy5tX2NvdW50IC0gMl0pO1xyXG4gICAgdGhpcy5tX25leHRWZXJ0ZXguQ29weSh0aGlzLm1fdmVydGljZXNbMV0pO1xyXG4gICAgdGhpcy5tX2hhc1ByZXZWZXJ0ZXggPSB0cnVlO1xyXG4gICAgdGhpcy5tX2hhc05leHRWZXJ0ZXggPSB0cnVlO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfVxyXG5cclxuICAvLy8gQ3JlYXRlIGEgY2hhaW4gd2l0aCBpc29sYXRlZCBlbmQgdmVydGljZXMuXHJcbiAgLy8vIEBwYXJhbSB2ZXJ0aWNlcyBhbiBhcnJheSBvZiB2ZXJ0aWNlcywgdGhlc2UgYXJlIGNvcGllZFxyXG4gIC8vLyBAcGFyYW0gY291bnQgdGhlIHZlcnRleCBjb3VudFxyXG4gIENyZWF0ZUNoYWluKHZlcnRpY2VzOiBYWVtdKTogYjJDaGFpblNoYXBlO1xyXG4gIENyZWF0ZUNoYWluKHZlcnRpY2VzOiBYWVtdLCBjb3VudDogbnVtYmVyKTogYjJDaGFpblNoYXBlO1xyXG4gIENyZWF0ZUNoYWluKHZlcnRpY2VzOiBudW1iZXJbXSk6IGIyQ2hhaW5TaGFwZTtcclxuICBDcmVhdGVDaGFpbiguLi5hcmdzOiBhbnlbXSk6IGIyQ2hhaW5TaGFwZSB7XHJcbiAgICBpZiAodHlwZW9mIGFyZ3NbMF1bMF0gPT09ICdudW1iZXInKSB7XHJcbiAgICAgIGNvbnN0IHZlcnRpY2VzOiBudW1iZXJbXSA9IGFyZ3NbMF07XHJcbiAgICAgIGlmICh2ZXJ0aWNlcy5sZW5ndGggJSAyICE9PSAwKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHRoaXMuX0NyZWF0ZUNoYWluKFxyXG4gICAgICAgIChpbmRleDogbnVtYmVyKTogWFkgPT4gKHtcclxuICAgICAgICAgIHg6IHZlcnRpY2VzW2luZGV4ICogMl0sXHJcbiAgICAgICAgICB5OiB2ZXJ0aWNlc1tpbmRleCAqIDIgKyAxXSxcclxuICAgICAgICB9KSxcclxuICAgICAgICB2ZXJ0aWNlcy5sZW5ndGggLyAyLFxyXG4gICAgICApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc3QgdmVydGljZXM6IFhZW10gPSBhcmdzWzBdO1xyXG4gICAgICBjb25zdCBjb3VudDogbnVtYmVyID0gYXJnc1sxXSB8fCB2ZXJ0aWNlcy5sZW5ndGg7XHJcbiAgICAgIHJldHVybiB0aGlzLl9DcmVhdGVDaGFpbigoaW5kZXg6IG51bWJlcik6IFhZID0+IHZlcnRpY2VzW2luZGV4XSwgY291bnQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfQ3JlYXRlQ2hhaW4odmVydGljZXM6IChpbmRleDogbnVtYmVyKSA9PiBYWSwgY291bnQ6IG51bWJlcik6IGIyQ2hhaW5TaGFwZSB7XHJcbiAgICAhIUIyX0RFQlVHICYmIGIyQXNzZXJ0KGNvdW50ID49IDIpO1xyXG4gICAgLy8gREVCVUc6IGZvciAobGV0IGk6IG51bWJlciA9IDE7IGkgPCBjb3VudDsgKytpKSB7XHJcbiAgICAvLyBERUJVRzogICBjb25zdCB2MSA9IHZlcnRpY2VzW3N0YXJ0ICsgaSAtIDFdO1xyXG4gICAgLy8gREVCVUc6ICAgY29uc3QgdjIgPSB2ZXJ0aWNlc1tzdGFydCArIGldO1xyXG4gICAgLy8gREVCVUc6ICAgLy8gSWYgdGhlIGNvZGUgY3Jhc2hlcyBoZXJlLCBpdCBtZWFucyB5b3VyIHZlcnRpY2VzIGFyZSB0b28gY2xvc2UgdG9nZXRoZXIuXHJcbiAgICAvLyBERUJVRzogICBiMkFzc2VydChiMlZlYzIuRGlzdGFuY2VTcXVhcmVkVlYodjEsIHYyKSA+IGIyX2xpbmVhclNsb3AgKiBiMl9saW5lYXJTbG9wKTtcclxuICAgIC8vIERFQlVHOiB9XHJcblxyXG4gICAgdGhpcy5tX2NvdW50ID0gY291bnQ7XHJcbiAgICB0aGlzLm1fdmVydGljZXMgPSBiMlZlYzIuTWFrZUFycmF5KGNvdW50KTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7ICsraSkge1xyXG4gICAgICB0aGlzLm1fdmVydGljZXNbaV0uQ29weSh2ZXJ0aWNlcyhpKSk7XHJcbiAgICB9XHJcbiAgICB0aGlzLm1faGFzUHJldlZlcnRleCA9IGZhbHNlO1xyXG4gICAgdGhpcy5tX2hhc05leHRWZXJ0ZXggPSBmYWxzZTtcclxuXHJcbiAgICB0aGlzLm1fcHJldlZlcnRleC5TZXRaZXJvKCk7XHJcbiAgICB0aGlzLm1fbmV4dFZlcnRleC5TZXRaZXJvKCk7XHJcblxyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfVxyXG5cclxuICAvLy8gRXN0YWJsaXNoIGNvbm5lY3Rpdml0eSB0byBhIHZlcnRleCB0aGF0IHByZWNlZGVzIHRoZSBmaXJzdCB2ZXJ0ZXguXHJcbiAgLy8vIERvbid0IGNhbGwgdGhpcyBmb3IgbG9vcHMuXHJcbiAgU2V0UHJldlZlcnRleChwcmV2VmVydGV4OiBYWSk6IGIyQ2hhaW5TaGFwZSB7XHJcbiAgICB0aGlzLm1fcHJldlZlcnRleC5Db3B5KHByZXZWZXJ0ZXgpO1xyXG4gICAgdGhpcy5tX2hhc1ByZXZWZXJ0ZXggPSB0cnVlO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfVxyXG5cclxuICAvLy8gRXN0YWJsaXNoIGNvbm5lY3Rpdml0eSB0byBhIHZlcnRleCB0aGF0IGZvbGxvd3MgdGhlIGxhc3QgdmVydGV4LlxyXG4gIC8vLyBEb24ndCBjYWxsIHRoaXMgZm9yIGxvb3BzLlxyXG4gIFNldE5leHRWZXJ0ZXgobmV4dFZlcnRleDogWFkpOiBiMkNoYWluU2hhcGUge1xyXG4gICAgdGhpcy5tX25leHRWZXJ0ZXguQ29weShuZXh0VmVydGV4KTtcclxuICAgIHRoaXMubV9oYXNOZXh0VmVydGV4ID0gdHJ1ZTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH1cclxuXHJcbiAgLy8vIEltcGxlbWVudCBiMlNoYXBlLiBWZXJ0aWNlcyBhcmUgY2xvbmVkIHVzaW5nIGIyQWxsb2MuXHJcbiAgQ2xvbmUoKTogYjJDaGFpblNoYXBlIHtcclxuICAgIHJldHVybiBuZXcgYjJDaGFpblNoYXBlKCkuQ29weSh0aGlzKTtcclxuICB9XHJcblxyXG4gIENvcHkob3RoZXI6IGIyQ2hhaW5TaGFwZSk6IGIyQ2hhaW5TaGFwZSB7XHJcbiAgICBzdXBlci5Db3B5KG90aGVyKTtcclxuXHJcbiAgICAhIUIyX0RFQlVHICYmIGIyQXNzZXJ0KG90aGVyIGluc3RhbmNlb2YgYjJDaGFpblNoYXBlKTtcclxuXHJcbiAgICB0aGlzLl9DcmVhdGVDaGFpbigoaW5kZXg6IG51bWJlcik6IFhZID0+IG90aGVyLm1fdmVydGljZXNbaW5kZXhdLCBvdGhlci5tX2NvdW50KTtcclxuICAgIHRoaXMubV9wcmV2VmVydGV4LkNvcHkob3RoZXIubV9wcmV2VmVydGV4KTtcclxuICAgIHRoaXMubV9uZXh0VmVydGV4LkNvcHkob3RoZXIubV9uZXh0VmVydGV4KTtcclxuICAgIHRoaXMubV9oYXNQcmV2VmVydGV4ID0gb3RoZXIubV9oYXNQcmV2VmVydGV4O1xyXG4gICAgdGhpcy5tX2hhc05leHRWZXJ0ZXggPSBvdGhlci5tX2hhc05leHRWZXJ0ZXg7XHJcblxyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfVxyXG5cclxuICAvLy8gQHNlZSBiMlNoYXBlOjpHZXRDaGlsZENvdW50XHJcbiAgR2V0Q2hpbGRDb3VudCgpOiBudW1iZXIge1xyXG4gICAgLy8gZWRnZSBjb3VudCA9IHZlcnRleCBjb3VudCAtIDFcclxuICAgIHJldHVybiB0aGlzLm1fY291bnQgLSAxO1xyXG4gIH1cclxuXHJcbiAgLy8vIEdldCBhIGNoaWxkIGVkZ2UuXHJcbiAgR2V0Q2hpbGRFZGdlKGVkZ2U6IGIyRWRnZVNoYXBlLCBpbmRleDogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAhIUIyX0RFQlVHICYmIGIyQXNzZXJ0KDAgPD0gaW5kZXggJiYgaW5kZXggPCB0aGlzLm1fY291bnQgLSAxKTtcclxuICAgIGVkZ2UubV9yYWRpdXMgPSB0aGlzLm1fcmFkaXVzO1xyXG5cclxuICAgIGVkZ2UubV92ZXJ0ZXgxLkNvcHkodGhpcy5tX3ZlcnRpY2VzW2luZGV4XSk7XHJcbiAgICBlZGdlLm1fdmVydGV4Mi5Db3B5KHRoaXMubV92ZXJ0aWNlc1tpbmRleCArIDFdKTtcclxuXHJcbiAgICBpZiAoaW5kZXggPiAwKSB7XHJcbiAgICAgIGVkZ2UubV92ZXJ0ZXgwLkNvcHkodGhpcy5tX3ZlcnRpY2VzW2luZGV4IC0gMV0pO1xyXG4gICAgICBlZGdlLm1faGFzVmVydGV4MCA9IHRydWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBlZGdlLm1fdmVydGV4MC5Db3B5KHRoaXMubV9wcmV2VmVydGV4KTtcclxuICAgICAgZWRnZS5tX2hhc1ZlcnRleDAgPSB0aGlzLm1faGFzUHJldlZlcnRleDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoaW5kZXggPCB0aGlzLm1fY291bnQgLSAyKSB7XHJcbiAgICAgIGVkZ2UubV92ZXJ0ZXgzLkNvcHkodGhpcy5tX3ZlcnRpY2VzW2luZGV4ICsgMl0pO1xyXG4gICAgICBlZGdlLm1faGFzVmVydGV4MyA9IHRydWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBlZGdlLm1fdmVydGV4My5Db3B5KHRoaXMubV9uZXh0VmVydGV4KTtcclxuICAgICAgZWRnZS5tX2hhc1ZlcnRleDMgPSB0aGlzLm1faGFzTmV4dFZlcnRleDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vLyBUaGlzIGFsd2F5cyByZXR1cm4gZmFsc2UuXHJcbiAgLy8vIEBzZWUgYjJTaGFwZTo6VGVzdFBvaW50XHJcbiAgVGVzdFBvaW50KHhmOiBiMlRyYW5zZm9ybSwgcDogWFkpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIC8vLyBAc2VlIGIyU2hhcGU6OkNvbXB1dGVEaXN0YW5jZVxyXG4gIHByaXZhdGUgc3RhdGljIENvbXB1dGVEaXN0YW5jZV9zX2VkZ2VTaGFwZSA9IG5ldyBiMkVkZ2VTaGFwZSgpO1xyXG5cclxuICBDb21wdXRlRGlzdGFuY2UoeGY6IGIyVHJhbnNmb3JtLCBwOiBiMlZlYzIsIG5vcm1hbDogYjJWZWMyLCBjaGlsZEluZGV4OiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgaWYgKEIyX0VOQUJMRV9QQVJUSUNMRSkge1xyXG4gICAgICBjb25zdCBlZGdlID0gYjJDaGFpblNoYXBlLkNvbXB1dGVEaXN0YW5jZV9zX2VkZ2VTaGFwZTtcclxuICAgICAgdGhpcy5HZXRDaGlsZEVkZ2UoZWRnZSwgY2hpbGRJbmRleCk7XHJcbiAgICAgIHJldHVybiBlZGdlLkNvbXB1dGVEaXN0YW5jZSh4ZiwgcCwgbm9ybWFsLCAwKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiAwLjA7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyAjZW5kaWZcclxuXHJcbiAgLy8vIEltcGxlbWVudCBiMlNoYXBlLlxyXG4gIHByaXZhdGUgc3RhdGljIFJheUNhc3Rfc19lZGdlU2hhcGUgPSBuZXcgYjJFZGdlU2hhcGUoKTtcclxuXHJcbiAgUmF5Q2FzdChcclxuICAgIG91dHB1dDogYjJSYXlDYXN0T3V0cHV0LFxyXG4gICAgaW5wdXQ6IGIyUmF5Q2FzdElucHV0LFxyXG4gICAgeGY6IGIyVHJhbnNmb3JtLFxyXG4gICAgY2hpbGRJbmRleDogbnVtYmVyLFxyXG4gICk6IGJvb2xlYW4ge1xyXG4gICAgISFCMl9ERUJVRyAmJiBiMkFzc2VydChjaGlsZEluZGV4IDwgdGhpcy5tX2NvdW50KTtcclxuXHJcbiAgICBjb25zdCBlZGdlU2hhcGU6IGIyRWRnZVNoYXBlID0gYjJDaGFpblNoYXBlLlJheUNhc3Rfc19lZGdlU2hhcGU7XHJcblxyXG4gICAgZWRnZVNoYXBlLm1fdmVydGV4MS5Db3B5KHRoaXMubV92ZXJ0aWNlc1tjaGlsZEluZGV4XSk7XHJcbiAgICBlZGdlU2hhcGUubV92ZXJ0ZXgyLkNvcHkodGhpcy5tX3ZlcnRpY2VzWyhjaGlsZEluZGV4ICsgMSkgJSB0aGlzLm1fY291bnRdKTtcclxuXHJcbiAgICByZXR1cm4gZWRnZVNoYXBlLlJheUNhc3Qob3V0cHV0LCBpbnB1dCwgeGYsIDApO1xyXG4gIH1cclxuXHJcbiAgLy8vIEBzZWUgYjJTaGFwZTo6Q29tcHV0ZUFBQkJcclxuICBwcml2YXRlIHN0YXRpYyBDb21wdXRlQUFCQl9zX3YxID0gbmV3IGIyVmVjMigpO1xyXG4gIHByaXZhdGUgc3RhdGljIENvbXB1dGVBQUJCX3NfdjIgPSBuZXcgYjJWZWMyKCk7XHJcblxyXG4gIENvbXB1dGVBQUJCKGFhYmI6IGIyQUFCQiwgeGY6IGIyVHJhbnNmb3JtLCBjaGlsZEluZGV4OiBudW1iZXIpOiB2b2lkIHtcclxuICAgICEhQjJfREVCVUcgJiYgYjJBc3NlcnQoY2hpbGRJbmRleCA8IHRoaXMubV9jb3VudCk7XHJcblxyXG4gICAgY29uc3QgdmVydGV4aTE6IGIyVmVjMiA9IHRoaXMubV92ZXJ0aWNlc1tjaGlsZEluZGV4XTtcclxuICAgIGNvbnN0IHZlcnRleGkyOiBiMlZlYzIgPSB0aGlzLm1fdmVydGljZXNbKGNoaWxkSW5kZXggKyAxKSAlIHRoaXMubV9jb3VudF07XHJcblxyXG4gICAgY29uc3QgdjE6IGIyVmVjMiA9IGIyVHJhbnNmb3JtLk11bFhWKHhmLCB2ZXJ0ZXhpMSwgYjJDaGFpblNoYXBlLkNvbXB1dGVBQUJCX3NfdjEpO1xyXG4gICAgY29uc3QgdjI6IGIyVmVjMiA9IGIyVHJhbnNmb3JtLk11bFhWKHhmLCB2ZXJ0ZXhpMiwgYjJDaGFpblNoYXBlLkNvbXB1dGVBQUJCX3NfdjIpO1xyXG5cclxuICAgIGIyVmVjMi5NaW5WKHYxLCB2MiwgYWFiYi5sb3dlckJvdW5kKTtcclxuICAgIGIyVmVjMi5NYXhWKHYxLCB2MiwgYWFiYi51cHBlckJvdW5kKTtcclxuICB9XHJcblxyXG4gIC8vLyBDaGFpbnMgaGF2ZSB6ZXJvIG1hc3MuXHJcbiAgLy8vIEBzZWUgYjJTaGFwZTo6Q29tcHV0ZU1hc3NcclxuICBDb21wdXRlTWFzcyhtYXNzRGF0YTogYjJNYXNzRGF0YSwgZGVuc2l0eTogbnVtYmVyKTogdm9pZCB7XHJcbiAgICBtYXNzRGF0YS5tYXNzID0gMDtcclxuICAgIG1hc3NEYXRhLmNlbnRlci5TZXRaZXJvKCk7XHJcbiAgICBtYXNzRGF0YS5JID0gMDtcclxuICB9XHJcblxyXG4gIFNldHVwRGlzdGFuY2VQcm94eShwcm94eTogYjJEaXN0YW5jZVByb3h5LCBpbmRleDogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAhIUIyX0RFQlVHICYmIGIyQXNzZXJ0KDAgPD0gaW5kZXggJiYgaW5kZXggPCB0aGlzLm1fY291bnQpO1xyXG5cclxuICAgIHByb3h5Lm1fdmVydGljZXMgPSBwcm94eS5tX2J1ZmZlcjtcclxuICAgIHByb3h5Lm1fdmVydGljZXNbMF0uQ29weSh0aGlzLm1fdmVydGljZXNbaW5kZXhdKTtcclxuICAgIGlmIChpbmRleCArIDEgPCB0aGlzLm1fY291bnQpIHtcclxuICAgICAgcHJveHkubV92ZXJ0aWNlc1sxXS5Db3B5KHRoaXMubV92ZXJ0aWNlc1tpbmRleCArIDFdKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHByb3h5Lm1fdmVydGljZXNbMV0uQ29weSh0aGlzLm1fdmVydGljZXNbMF0pO1xyXG4gICAgfVxyXG4gICAgcHJveHkubV9jb3VudCA9IDI7XHJcbiAgICBwcm94eS5tX3JhZGl1cyA9IHRoaXMubV9yYWRpdXM7XHJcbiAgfVxyXG5cclxuICBDb21wdXRlU3VibWVyZ2VkQXJlYShub3JtYWw6IGIyVmVjMiwgb2Zmc2V0OiBudW1iZXIsIHhmOiBiMlRyYW5zZm9ybSwgYzogYjJWZWMyKTogbnVtYmVyIHtcclxuICAgIGMuU2V0WmVybygpO1xyXG4gICAgcmV0dXJuIDA7XHJcbiAgfVxyXG59XHJcbiJdfQ==