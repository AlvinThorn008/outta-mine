/*
 * Copyright (c) 2006-2009 Erin Catto http://www.box2d.org
 *
 * This software is provided 'as-is', without any express or implied
 * warranty.  In no event will the authors be held liable for any damages
 * arising from the use of this software.
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 * 1. The origin of this software must not be misrepresented; you must not
 * claim that you wrote the original software. If you use this software
 * in a product, an acknowledgment in the product documentation would be
 * appreciated but is not required.
 * 2. Altered source versions must be plainly marked as such, and must not be
 * misrepresented as being the original software.
 * 3. This notice may not be removed or altered from any source distribution.
 */
import { b2_epsilon, b2_pi, b2Assert } from '../../common/b2Settings';
import { b2Asin, b2Pow, b2Sq, b2Sqrt, b2Transform, b2Vec2 } from '../../common/b2Math';
import { b2Shape } from './b2Shape';
/// @see b2Shape::ComputeDistance
const ComputeDistance_s_center = new b2Vec2();
/// A circle shape.
export class b2CircleShape extends b2Shape {
    constructor(radius = 0.0) {
        super(0 /* e_circleShape */, radius);
        this.m_p = new b2Vec2();
    }
    Set(position, radius = this.m_radius) {
        this.m_p.Copy(position);
        this.m_radius = radius;
        return this;
    }
    /// Implement b2Shape.
    Clone() {
        return new b2CircleShape().Copy(this);
    }
    Copy(other) {
        super.Copy(other);
        !!B2_DEBUG && b2Assert(other instanceof b2CircleShape);
        this.m_p.Copy(other.m_p);
        return this;
    }
    /// @see b2Shape::GetChildCount
    GetChildCount() {
        return 1;
    }
    TestPoint(transform, p) {
        const center = b2Transform.MulXV(transform, this.m_p, b2CircleShape.TestPoint_s_center);
        const d = b2Vec2.SubVV(p, center, b2CircleShape.TestPoint_s_d);
        return b2Vec2.DotVV(d, d) <= b2Sq(this.m_radius);
    }
    ComputeDistance(xf, p, normal, childIndex) {
        if (B2_ENABLE_PARTICLE) {
            const center = b2Transform.MulXV(xf, this.m_p, ComputeDistance_s_center);
            b2Vec2.SubVV(p, center, normal);
            return normal.Normalize() - this.m_radius;
        }
        else {
            return 0.0;
        }
    }
    RayCast(output, input, transform, childIndex) {
        const position = b2Transform.MulXV(transform, this.m_p, b2CircleShape.RayCast_s_position);
        const s = b2Vec2.SubVV(input.p1, position, b2CircleShape.RayCast_s_s);
        const b = b2Vec2.DotVV(s, s) - b2Sq(this.m_radius);
        // Solve quadratic equation.
        const r = b2Vec2.SubVV(input.p2, input.p1, b2CircleShape.RayCast_s_r);
        const c = b2Vec2.DotVV(s, r);
        const rr = b2Vec2.DotVV(r, r);
        const sigma = c * c - rr * b;
        // Check for negative discriminant and short segment.
        if (sigma < 0 || rr < b2_epsilon) {
            return false;
        }
        // Find the point of intersection of the line with the circle.
        let a = -(c + b2Sqrt(sigma));
        // Is the intersection point on the segment?
        if (0 <= a && a <= input.maxFraction * rr) {
            a /= rr;
            output.fraction = a;
            b2Vec2.AddVMulSV(s, a, r, output.normal).SelfNormalize();
            return true;
        }
        return false;
    }
    ComputeAABB(aabb, transform, childIndex) {
        const p = b2Transform.MulXV(transform, this.m_p, b2CircleShape.ComputeAABB_s_p);
        aabb.lowerBound.Set(p.x - this.m_radius, p.y - this.m_radius);
        aabb.upperBound.Set(p.x + this.m_radius, p.y + this.m_radius);
    }
    /// @see b2Shape::ComputeMass
    ComputeMass(massData, density) {
        const radius_sq = b2Sq(this.m_radius);
        massData.mass = density * b2_pi * radius_sq;
        massData.center.Copy(this.m_p);
        // inertia about the local origin
        massData.I = massData.mass * (0.5 * radius_sq + b2Vec2.DotVV(this.m_p, this.m_p));
    }
    SetupDistanceProxy(proxy, index) {
        proxy.m_vertices = proxy.m_buffer;
        proxy.m_vertices[0].Copy(this.m_p);
        proxy.m_count = 1;
        proxy.m_radius = this.m_radius;
    }
    ComputeSubmergedArea(normal, offset, xf, c) {
        const p = b2Transform.MulXV(xf, this.m_p, new b2Vec2());
        const l = -(b2Vec2.DotVV(normal, p) - offset);
        if (l < -this.m_radius + b2_epsilon) {
            // Completely dry
            return 0;
        }
        if (l > this.m_radius) {
            // Completely wet
            c.Copy(p);
            return b2_pi * this.m_radius * this.m_radius;
        }
        // Magic
        const r2 = this.m_radius * this.m_radius;
        const l2 = l * l;
        const area = r2 * (b2Asin(l / this.m_radius) + b2_pi / 2) + l * b2Sqrt(r2 - l2);
        const com = ((-2 / 3) * b2Pow(r2 - l2, 1.5)) / area;
        c.x = p.x + normal.x * com;
        c.y = p.y + normal.y * com;
        return area;
    }
}
/// Implement b2Shape.
b2CircleShape.TestPoint_s_center = new b2Vec2();
b2CircleShape.TestPoint_s_d = new b2Vec2();
/// Implement b2Shape.
// Collision Detection in Interactive 3D Environments by Gino van den Bergen
// From Section 3.1.2
// x = s + a * r
// norm(x) = radius
b2CircleShape.RayCast_s_position = new b2Vec2();
b2CircleShape.RayCast_s_s = new b2Vec2();
b2CircleShape.RayCast_s_r = new b2Vec2();
/// @see b2Shape::ComputeAABB
b2CircleShape.ComputeAABB_s_p = new b2Vec2();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYjJDaXJjbGVTaGFwZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb2xsaXNpb24vc2hhcGVzL2IyQ2lyY2xlU2hhcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7R0FnQkc7QUFFSCxPQUFPLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN0RSxPQUFPLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQU0sTUFBTSxxQkFBcUIsQ0FBQztBQUczRixPQUFPLEVBQWMsT0FBTyxFQUFlLE1BQU0sV0FBVyxDQUFDO0FBRTdELGlDQUFpQztBQUNqQyxNQUFNLHdCQUF3QixHQUFHLElBQUksTUFBTSxFQUFFLENBQUM7QUFFOUMsbUJBQW1CO0FBQ25CLE1BQU0sT0FBTyxhQUFjLFNBQVEsT0FBTztJQUd4QyxZQUFZLE1BQU0sR0FBRyxHQUFHO1FBQ3RCLEtBQUssd0JBQTRCLE1BQU0sQ0FBQyxDQUFDO1FBSGxDLFFBQUcsR0FBVyxJQUFJLE1BQU0sRUFBRSxDQUFDO0lBSXBDLENBQUM7SUFFRCxHQUFHLENBQUMsUUFBWSxFQUFFLFNBQWlCLElBQUksQ0FBQyxRQUFRO1FBQzlDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELHNCQUFzQjtJQUN0QixLQUFLO1FBQ0gsT0FBTyxJQUFJLGFBQWEsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUQsSUFBSSxDQUFDLEtBQW9CO1FBQ3ZCLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFbEIsQ0FBQyxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsS0FBSyxZQUFZLGFBQWEsQ0FBQyxDQUFDO1FBRXZELElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6QixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCwrQkFBK0I7SUFDL0IsYUFBYTtRQUNYLE9BQU8sQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQU1ELFNBQVMsQ0FBQyxTQUFzQixFQUFFLENBQUs7UUFDckMsTUFBTSxNQUFNLEdBQVcsV0FBVyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxhQUFhLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUNoRyxNQUFNLENBQUMsR0FBVyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3ZFLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRUQsZUFBZSxDQUFDLEVBQWUsRUFBRSxDQUFTLEVBQUUsTUFBYyxFQUFFLFVBQWtCO1FBQzVFLElBQUksa0JBQWtCLEVBQUU7WUFDdEIsTUFBTSxNQUFNLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO1lBQ3pFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNoQyxPQUFPLE1BQU0sQ0FBQyxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1NBQzNDO2FBQU07WUFDTCxPQUFPLEdBQUcsQ0FBQztTQUNaO0lBQ0gsQ0FBQztJQVdELE9BQU8sQ0FDTCxNQUF1QixFQUN2QixLQUFxQixFQUNyQixTQUFzQixFQUN0QixVQUFrQjtRQUVsQixNQUFNLFFBQVEsR0FBVyxXQUFXLENBQUMsS0FBSyxDQUN4QyxTQUFTLEVBQ1QsSUFBSSxDQUFDLEdBQUcsRUFDUixhQUFhLENBQUMsa0JBQWtCLENBQ2pDLENBQUM7UUFDRixNQUFNLENBQUMsR0FBVyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsUUFBUSxFQUFFLGFBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM5RSxNQUFNLENBQUMsR0FBVyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRTNELDRCQUE0QjtRQUM1QixNQUFNLENBQUMsR0FBVyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRSxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDOUUsTUFBTSxDQUFDLEdBQVcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckMsTUFBTSxFQUFFLEdBQVcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdEMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRTdCLHFEQUFxRDtRQUNyRCxJQUFJLEtBQUssR0FBRyxDQUFDLElBQUksRUFBRSxHQUFHLFVBQVUsRUFBRTtZQUNoQyxPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsOERBQThEO1FBQzlELElBQUksQ0FBQyxHQUFXLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFFckMsNENBQTRDO1FBQzVDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLFdBQVcsR0FBRyxFQUFFLEVBQUU7WUFDekMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNSLE1BQU0sQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ3pELE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFFRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFLRCxXQUFXLENBQUMsSUFBWSxFQUFFLFNBQXNCLEVBQUUsVUFBa0I7UUFDbEUsTUFBTSxDQUFDLEdBQVcsV0FBVyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxhQUFhLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDeEYsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzlELElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNoRSxDQUFDO0lBRUQsNkJBQTZCO0lBQzdCLFdBQVcsQ0FBQyxRQUFvQixFQUFFLE9BQWU7UUFDL0MsTUFBTSxTQUFTLEdBQVcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM5QyxRQUFRLENBQUMsSUFBSSxHQUFHLE9BQU8sR0FBRyxLQUFLLEdBQUcsU0FBUyxDQUFDO1FBQzVDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUUvQixpQ0FBaUM7UUFDakMsUUFBUSxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxHQUFHLFNBQVMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDcEYsQ0FBQztJQUVELGtCQUFrQixDQUFDLEtBQXNCLEVBQUUsS0FBYTtRQUN0RCxLQUFLLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUM7UUFDbEMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ25DLEtBQUssQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLEtBQUssQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUNqQyxDQUFDO0lBRUQsb0JBQW9CLENBQUMsTUFBYyxFQUFFLE1BQWMsRUFBRSxFQUFlLEVBQUUsQ0FBUztRQUM3RSxNQUFNLENBQUMsR0FBVyxXQUFXLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksTUFBTSxFQUFFLENBQUMsQ0FBQztRQUNoRSxNQUFNLENBQUMsR0FBVyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUM7UUFFdEQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLFVBQVUsRUFBRTtZQUNuQyxpQkFBaUI7WUFDakIsT0FBTyxDQUFDLENBQUM7U0FDVjtRQUNELElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDckIsaUJBQWlCO1lBQ2pCLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDVixPQUFPLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7U0FDOUM7UUFFRCxRQUFRO1FBQ1IsTUFBTSxFQUFFLEdBQVcsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQ2pELE1BQU0sRUFBRSxHQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDekIsTUFBTSxJQUFJLEdBQVcsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ3hGLE1BQU0sR0FBRyxHQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsRUFBRSxHQUFHLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUU1RCxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBRTNCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQzs7QUF0SEQsc0JBQXNCO0FBQ1AsZ0NBQWtCLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztBQUNsQywyQkFBYSxHQUFHLElBQUksTUFBTSxFQUFFLENBQUM7QUFrQjVDLHNCQUFzQjtBQUN0Qiw0RUFBNEU7QUFDNUUscUJBQXFCO0FBQ3JCLGdCQUFnQjtBQUNoQixtQkFBbUI7QUFDSixnQ0FBa0IsR0FBRyxJQUFJLE1BQU0sRUFBRSxDQUFDO0FBQ2xDLHlCQUFXLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztBQUMzQix5QkFBVyxHQUFHLElBQUksTUFBTSxFQUFFLENBQUM7QUF5QzFDLDZCQUE2QjtBQUNkLDZCQUFlLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIENvcHlyaWdodCAoYykgMjAwNi0yMDA5IEVyaW4gQ2F0dG8gaHR0cDovL3d3dy5ib3gyZC5vcmdcclxuICpcclxuICogVGhpcyBzb2Z0d2FyZSBpcyBwcm92aWRlZCAnYXMtaXMnLCB3aXRob3V0IGFueSBleHByZXNzIG9yIGltcGxpZWRcclxuICogd2FycmFudHkuICBJbiBubyBldmVudCB3aWxsIHRoZSBhdXRob3JzIGJlIGhlbGQgbGlhYmxlIGZvciBhbnkgZGFtYWdlc1xyXG4gKiBhcmlzaW5nIGZyb20gdGhlIHVzZSBvZiB0aGlzIHNvZnR3YXJlLlxyXG4gKiBQZXJtaXNzaW9uIGlzIGdyYW50ZWQgdG8gYW55b25lIHRvIHVzZSB0aGlzIHNvZnR3YXJlIGZvciBhbnkgcHVycG9zZSxcclxuICogaW5jbHVkaW5nIGNvbW1lcmNpYWwgYXBwbGljYXRpb25zLCBhbmQgdG8gYWx0ZXIgaXQgYW5kIHJlZGlzdHJpYnV0ZSBpdFxyXG4gKiBmcmVlbHksIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyByZXN0cmljdGlvbnM6XHJcbiAqIDEuIFRoZSBvcmlnaW4gb2YgdGhpcyBzb2Z0d2FyZSBtdXN0IG5vdCBiZSBtaXNyZXByZXNlbnRlZDsgeW91IG11c3Qgbm90XHJcbiAqIGNsYWltIHRoYXQgeW91IHdyb3RlIHRoZSBvcmlnaW5hbCBzb2Z0d2FyZS4gSWYgeW91IHVzZSB0aGlzIHNvZnR3YXJlXHJcbiAqIGluIGEgcHJvZHVjdCwgYW4gYWNrbm93bGVkZ21lbnQgaW4gdGhlIHByb2R1Y3QgZG9jdW1lbnRhdGlvbiB3b3VsZCBiZVxyXG4gKiBhcHByZWNpYXRlZCBidXQgaXMgbm90IHJlcXVpcmVkLlxyXG4gKiAyLiBBbHRlcmVkIHNvdXJjZSB2ZXJzaW9ucyBtdXN0IGJlIHBsYWlubHkgbWFya2VkIGFzIHN1Y2gsIGFuZCBtdXN0IG5vdCBiZVxyXG4gKiBtaXNyZXByZXNlbnRlZCBhcyBiZWluZyB0aGUgb3JpZ2luYWwgc29mdHdhcmUuXHJcbiAqIDMuIFRoaXMgbm90aWNlIG1heSBub3QgYmUgcmVtb3ZlZCBvciBhbHRlcmVkIGZyb20gYW55IHNvdXJjZSBkaXN0cmlidXRpb24uXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgYjJfZXBzaWxvbiwgYjJfcGksIGIyQXNzZXJ0IH0gZnJvbSAnLi4vLi4vY29tbW9uL2IyU2V0dGluZ3MnO1xyXG5pbXBvcnQgeyBiMkFzaW4sIGIyUG93LCBiMlNxLCBiMlNxcnQsIGIyVHJhbnNmb3JtLCBiMlZlYzIsIFhZIH0gZnJvbSAnLi4vLi4vY29tbW9uL2IyTWF0aCc7XHJcbmltcG9ydCB7IGIyQUFCQiwgYjJSYXlDYXN0SW5wdXQsIGIyUmF5Q2FzdE91dHB1dCB9IGZyb20gJy4uL2IyQ29sbGlzaW9uJztcclxuaW1wb3J0IHsgYjJEaXN0YW5jZVByb3h5IH0gZnJvbSAnLi4vYjJEaXN0YW5jZSc7XHJcbmltcG9ydCB7IGIyTWFzc0RhdGEsIGIyU2hhcGUsIGIyU2hhcGVUeXBlIH0gZnJvbSAnLi9iMlNoYXBlJztcclxuXHJcbi8vLyBAc2VlIGIyU2hhcGU6OkNvbXB1dGVEaXN0YW5jZVxyXG5jb25zdCBDb21wdXRlRGlzdGFuY2Vfc19jZW50ZXIgPSBuZXcgYjJWZWMyKCk7XHJcblxyXG4vLy8gQSBjaXJjbGUgc2hhcGUuXHJcbmV4cG9ydCBjbGFzcyBiMkNpcmNsZVNoYXBlIGV4dGVuZHMgYjJTaGFwZSB7XHJcbiAgcmVhZG9ubHkgbV9wOiBiMlZlYzIgPSBuZXcgYjJWZWMyKCk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHJhZGl1cyA9IDAuMCkge1xyXG4gICAgc3VwZXIoYjJTaGFwZVR5cGUuZV9jaXJjbGVTaGFwZSwgcmFkaXVzKTtcclxuICB9XHJcblxyXG4gIFNldChwb3NpdGlvbjogWFksIHJhZGl1czogbnVtYmVyID0gdGhpcy5tX3JhZGl1cyk6IHRoaXMge1xyXG4gICAgdGhpcy5tX3AuQ29weShwb3NpdGlvbik7XHJcbiAgICB0aGlzLm1fcmFkaXVzID0gcmFkaXVzO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfVxyXG5cclxuICAvLy8gSW1wbGVtZW50IGIyU2hhcGUuXHJcbiAgQ2xvbmUoKTogYjJDaXJjbGVTaGFwZSB7XHJcbiAgICByZXR1cm4gbmV3IGIyQ2lyY2xlU2hhcGUoKS5Db3B5KHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgQ29weShvdGhlcjogYjJDaXJjbGVTaGFwZSk6IGIyQ2lyY2xlU2hhcGUge1xyXG4gICAgc3VwZXIuQ29weShvdGhlcik7XHJcblxyXG4gICAgISFCMl9ERUJVRyAmJiBiMkFzc2VydChvdGhlciBpbnN0YW5jZW9mIGIyQ2lyY2xlU2hhcGUpO1xyXG5cclxuICAgIHRoaXMubV9wLkNvcHkob3RoZXIubV9wKTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH1cclxuXHJcbiAgLy8vIEBzZWUgYjJTaGFwZTo6R2V0Q2hpbGRDb3VudFxyXG4gIEdldENoaWxkQ291bnQoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiAxO1xyXG4gIH1cclxuXHJcbiAgLy8vIEltcGxlbWVudCBiMlNoYXBlLlxyXG4gIHByaXZhdGUgc3RhdGljIFRlc3RQb2ludF9zX2NlbnRlciA9IG5ldyBiMlZlYzIoKTtcclxuICBwcml2YXRlIHN0YXRpYyBUZXN0UG9pbnRfc19kID0gbmV3IGIyVmVjMigpO1xyXG5cclxuICBUZXN0UG9pbnQodHJhbnNmb3JtOiBiMlRyYW5zZm9ybSwgcDogWFkpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IGNlbnRlcjogYjJWZWMyID0gYjJUcmFuc2Zvcm0uTXVsWFYodHJhbnNmb3JtLCB0aGlzLm1fcCwgYjJDaXJjbGVTaGFwZS5UZXN0UG9pbnRfc19jZW50ZXIpO1xyXG4gICAgY29uc3QgZDogYjJWZWMyID0gYjJWZWMyLlN1YlZWKHAsIGNlbnRlciwgYjJDaXJjbGVTaGFwZS5UZXN0UG9pbnRfc19kKTtcclxuICAgIHJldHVybiBiMlZlYzIuRG90VlYoZCwgZCkgPD0gYjJTcSh0aGlzLm1fcmFkaXVzKTtcclxuICB9XHJcblxyXG4gIENvbXB1dGVEaXN0YW5jZSh4ZjogYjJUcmFuc2Zvcm0sIHA6IGIyVmVjMiwgbm9ybWFsOiBiMlZlYzIsIGNoaWxkSW5kZXg6IG51bWJlcik6IG51bWJlciB7XHJcbiAgICBpZiAoQjJfRU5BQkxFX1BBUlRJQ0xFKSB7XHJcbiAgICAgIGNvbnN0IGNlbnRlciA9IGIyVHJhbnNmb3JtLk11bFhWKHhmLCB0aGlzLm1fcCwgQ29tcHV0ZURpc3RhbmNlX3NfY2VudGVyKTtcclxuICAgICAgYjJWZWMyLlN1YlZWKHAsIGNlbnRlciwgbm9ybWFsKTtcclxuICAgICAgcmV0dXJuIG5vcm1hbC5Ob3JtYWxpemUoKSAtIHRoaXMubV9yYWRpdXM7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gMC4wO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8vIEltcGxlbWVudCBiMlNoYXBlLlxyXG4gIC8vIENvbGxpc2lvbiBEZXRlY3Rpb24gaW4gSW50ZXJhY3RpdmUgM0QgRW52aXJvbm1lbnRzIGJ5IEdpbm8gdmFuIGRlbiBCZXJnZW5cclxuICAvLyBGcm9tIFNlY3Rpb24gMy4xLjJcclxuICAvLyB4ID0gcyArIGEgKiByXHJcbiAgLy8gbm9ybSh4KSA9IHJhZGl1c1xyXG4gIHByaXZhdGUgc3RhdGljIFJheUNhc3Rfc19wb3NpdGlvbiA9IG5ldyBiMlZlYzIoKTtcclxuICBwcml2YXRlIHN0YXRpYyBSYXlDYXN0X3NfcyA9IG5ldyBiMlZlYzIoKTtcclxuICBwcml2YXRlIHN0YXRpYyBSYXlDYXN0X3NfciA9IG5ldyBiMlZlYzIoKTtcclxuXHJcbiAgUmF5Q2FzdChcclxuICAgIG91dHB1dDogYjJSYXlDYXN0T3V0cHV0LFxyXG4gICAgaW5wdXQ6IGIyUmF5Q2FzdElucHV0LFxyXG4gICAgdHJhbnNmb3JtOiBiMlRyYW5zZm9ybSxcclxuICAgIGNoaWxkSW5kZXg6IG51bWJlcixcclxuICApOiBib29sZWFuIHtcclxuICAgIGNvbnN0IHBvc2l0aW9uOiBiMlZlYzIgPSBiMlRyYW5zZm9ybS5NdWxYVihcclxuICAgICAgdHJhbnNmb3JtLFxyXG4gICAgICB0aGlzLm1fcCxcclxuICAgICAgYjJDaXJjbGVTaGFwZS5SYXlDYXN0X3NfcG9zaXRpb24sXHJcbiAgICApO1xyXG4gICAgY29uc3QgczogYjJWZWMyID0gYjJWZWMyLlN1YlZWKGlucHV0LnAxLCBwb3NpdGlvbiwgYjJDaXJjbGVTaGFwZS5SYXlDYXN0X3Nfcyk7XHJcbiAgICBjb25zdCBiOiBudW1iZXIgPSBiMlZlYzIuRG90VlYocywgcykgLSBiMlNxKHRoaXMubV9yYWRpdXMpO1xyXG5cclxuICAgIC8vIFNvbHZlIHF1YWRyYXRpYyBlcXVhdGlvbi5cclxuICAgIGNvbnN0IHI6IGIyVmVjMiA9IGIyVmVjMi5TdWJWVihpbnB1dC5wMiwgaW5wdXQucDEsIGIyQ2lyY2xlU2hhcGUuUmF5Q2FzdF9zX3IpO1xyXG4gICAgY29uc3QgYzogbnVtYmVyID0gYjJWZWMyLkRvdFZWKHMsIHIpO1xyXG4gICAgY29uc3QgcnI6IG51bWJlciA9IGIyVmVjMi5Eb3RWVihyLCByKTtcclxuICAgIGNvbnN0IHNpZ21hID0gYyAqIGMgLSByciAqIGI7XHJcblxyXG4gICAgLy8gQ2hlY2sgZm9yIG5lZ2F0aXZlIGRpc2NyaW1pbmFudCBhbmQgc2hvcnQgc2VnbWVudC5cclxuICAgIGlmIChzaWdtYSA8IDAgfHwgcnIgPCBiMl9lcHNpbG9uKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBGaW5kIHRoZSBwb2ludCBvZiBpbnRlcnNlY3Rpb24gb2YgdGhlIGxpbmUgd2l0aCB0aGUgY2lyY2xlLlxyXG4gICAgbGV0IGE6IG51bWJlciA9IC0oYyArIGIyU3FydChzaWdtYSkpO1xyXG5cclxuICAgIC8vIElzIHRoZSBpbnRlcnNlY3Rpb24gcG9pbnQgb24gdGhlIHNlZ21lbnQ/XHJcbiAgICBpZiAoMCA8PSBhICYmIGEgPD0gaW5wdXQubWF4RnJhY3Rpb24gKiBycikge1xyXG4gICAgICBhIC89IHJyO1xyXG4gICAgICBvdXRwdXQuZnJhY3Rpb24gPSBhO1xyXG4gICAgICBiMlZlYzIuQWRkVk11bFNWKHMsIGEsIHIsIG91dHB1dC5ub3JtYWwpLlNlbGZOb3JtYWxpemUoKTtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgLy8vIEBzZWUgYjJTaGFwZTo6Q29tcHV0ZUFBQkJcclxuICBwcml2YXRlIHN0YXRpYyBDb21wdXRlQUFCQl9zX3AgPSBuZXcgYjJWZWMyKCk7XHJcblxyXG4gIENvbXB1dGVBQUJCKGFhYmI6IGIyQUFCQiwgdHJhbnNmb3JtOiBiMlRyYW5zZm9ybSwgY2hpbGRJbmRleDogbnVtYmVyKTogdm9pZCB7XHJcbiAgICBjb25zdCBwOiBiMlZlYzIgPSBiMlRyYW5zZm9ybS5NdWxYVih0cmFuc2Zvcm0sIHRoaXMubV9wLCBiMkNpcmNsZVNoYXBlLkNvbXB1dGVBQUJCX3NfcCk7XHJcbiAgICBhYWJiLmxvd2VyQm91bmQuU2V0KHAueCAtIHRoaXMubV9yYWRpdXMsIHAueSAtIHRoaXMubV9yYWRpdXMpO1xyXG4gICAgYWFiYi51cHBlckJvdW5kLlNldChwLnggKyB0aGlzLm1fcmFkaXVzLCBwLnkgKyB0aGlzLm1fcmFkaXVzKTtcclxuICB9XHJcblxyXG4gIC8vLyBAc2VlIGIyU2hhcGU6OkNvbXB1dGVNYXNzXHJcbiAgQ29tcHV0ZU1hc3MobWFzc0RhdGE6IGIyTWFzc0RhdGEsIGRlbnNpdHk6IG51bWJlcik6IHZvaWQge1xyXG4gICAgY29uc3QgcmFkaXVzX3NxOiBudW1iZXIgPSBiMlNxKHRoaXMubV9yYWRpdXMpO1xyXG4gICAgbWFzc0RhdGEubWFzcyA9IGRlbnNpdHkgKiBiMl9waSAqIHJhZGl1c19zcTtcclxuICAgIG1hc3NEYXRhLmNlbnRlci5Db3B5KHRoaXMubV9wKTtcclxuXHJcbiAgICAvLyBpbmVydGlhIGFib3V0IHRoZSBsb2NhbCBvcmlnaW5cclxuICAgIG1hc3NEYXRhLkkgPSBtYXNzRGF0YS5tYXNzICogKDAuNSAqIHJhZGl1c19zcSArIGIyVmVjMi5Eb3RWVih0aGlzLm1fcCwgdGhpcy5tX3ApKTtcclxuICB9XHJcblxyXG4gIFNldHVwRGlzdGFuY2VQcm94eShwcm94eTogYjJEaXN0YW5jZVByb3h5LCBpbmRleDogbnVtYmVyKTogdm9pZCB7XHJcbiAgICBwcm94eS5tX3ZlcnRpY2VzID0gcHJveHkubV9idWZmZXI7XHJcbiAgICBwcm94eS5tX3ZlcnRpY2VzWzBdLkNvcHkodGhpcy5tX3ApO1xyXG4gICAgcHJveHkubV9jb3VudCA9IDE7XHJcbiAgICBwcm94eS5tX3JhZGl1cyA9IHRoaXMubV9yYWRpdXM7XHJcbiAgfVxyXG5cclxuICBDb21wdXRlU3VibWVyZ2VkQXJlYShub3JtYWw6IGIyVmVjMiwgb2Zmc2V0OiBudW1iZXIsIHhmOiBiMlRyYW5zZm9ybSwgYzogYjJWZWMyKTogbnVtYmVyIHtcclxuICAgIGNvbnN0IHA6IGIyVmVjMiA9IGIyVHJhbnNmb3JtLk11bFhWKHhmLCB0aGlzLm1fcCwgbmV3IGIyVmVjMigpKTtcclxuICAgIGNvbnN0IGw6IG51bWJlciA9IC0oYjJWZWMyLkRvdFZWKG5vcm1hbCwgcCkgLSBvZmZzZXQpO1xyXG5cclxuICAgIGlmIChsIDwgLXRoaXMubV9yYWRpdXMgKyBiMl9lcHNpbG9uKSB7XHJcbiAgICAgIC8vIENvbXBsZXRlbHkgZHJ5XHJcbiAgICAgIHJldHVybiAwO1xyXG4gICAgfVxyXG4gICAgaWYgKGwgPiB0aGlzLm1fcmFkaXVzKSB7XHJcbiAgICAgIC8vIENvbXBsZXRlbHkgd2V0XHJcbiAgICAgIGMuQ29weShwKTtcclxuICAgICAgcmV0dXJuIGIyX3BpICogdGhpcy5tX3JhZGl1cyAqIHRoaXMubV9yYWRpdXM7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gTWFnaWNcclxuICAgIGNvbnN0IHIyOiBudW1iZXIgPSB0aGlzLm1fcmFkaXVzICogdGhpcy5tX3JhZGl1cztcclxuICAgIGNvbnN0IGwyOiBudW1iZXIgPSBsICogbDtcclxuICAgIGNvbnN0IGFyZWE6IG51bWJlciA9IHIyICogKGIyQXNpbihsIC8gdGhpcy5tX3JhZGl1cykgKyBiMl9waSAvIDIpICsgbCAqIGIyU3FydChyMiAtIGwyKTtcclxuICAgIGNvbnN0IGNvbTogbnVtYmVyID0gKCgtMiAvIDMpICogYjJQb3cocjIgLSBsMiwgMS41KSkgLyBhcmVhO1xyXG5cclxuICAgIGMueCA9IHAueCArIG5vcm1hbC54ICogY29tO1xyXG4gICAgYy55ID0gcC55ICsgbm9ybWFsLnkgKiBjb207XHJcblxyXG4gICAgcmV0dXJuIGFyZWE7XHJcbiAgfVxyXG59XHJcbiJdfQ==