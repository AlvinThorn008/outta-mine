import { b2Color } from '../common/b2Draw';
import { b2Transform, b2Vec2 } from '../common/b2Math';
function DrawParticleSystem(drawer, system) {
    const particleCount = system.GetParticleCount();
    if (particleCount) {
        const radius = system.GetRadius();
        const positionBuffer = system.GetPositionBuffer();
        if (system.m_colorBuffer.data) {
            const colorBuffer = system.GetColorBuffer();
            drawer.DrawParticles(positionBuffer, radius, colorBuffer, particleCount);
        }
        else {
            drawer.DrawParticles(positionBuffer, radius, null, particleCount);
        }
    }
}
const DrawJoint_s_p1 = new b2Vec2();
const DrawJoint_s_p2 = new b2Vec2();
const DrawJoint_s_color = new b2Color(0.5, 0.8, 0.8);
const DrawJoint_s_c = new b2Color();
function DrawJoint(drawer, joint) {
    const bodyA = joint.GetBodyA();
    const bodyB = joint.GetBodyB();
    const xf1 = bodyA.m_xf;
    const xf2 = bodyB.m_xf;
    const x1 = xf1.p;
    const x2 = xf2.p;
    const p1 = joint.GetAnchorA(DrawJoint_s_p1);
    const p2 = joint.GetAnchorB(DrawJoint_s_p2);
    const color = DrawJoint_s_color.SetRGB(0.5, 0.8, 0.8);
    switch (joint.m_type) {
        case 3 /* e_distanceJoint */:
            drawer.DrawSegment(p1, p2, color);
            break;
        case 4 /* e_pulleyJoint */: {
            const pulley = joint;
            const s1 = pulley.GetGroundAnchorA();
            const s2 = pulley.GetGroundAnchorB();
            drawer.DrawSegment(s1, p1, color);
            drawer.DrawSegment(s2, p2, color);
            drawer.DrawSegment(s1, s2, color);
            break;
        }
        case 5 /* e_mouseJoint */: {
            const c = DrawJoint_s_c;
            c.Set(0.0, 1.0, 0.0);
            drawer.DrawPoint(p1, 4.0, c);
            drawer.DrawPoint(p2, 4.0, c);
            c.Set(0.8, 0.8, 0.8);
            drawer.DrawSegment(p1, p2, c);
            break;
        }
        default:
            drawer.DrawSegment(x1, p1, color);
            drawer.DrawSegment(p1, p2, color);
            drawer.DrawSegment(x2, p2, color);
    }
}
const DrawShape_s_ghostColor = new b2Color();
function DrawShape(drawer, fixture, color) {
    const shape = fixture.GetShape();
    switch (shape.m_type) {
        case 0 /* e_circleShape */: {
            const circle = shape;
            const center = circle.m_p;
            const radius = circle.m_radius;
            const axis = b2Vec2.UNITX;
            drawer.DrawSolidCircle(center, radius, axis, color);
            break;
        }
        case 1 /* e_edgeShape */: {
            const edge = shape;
            const v1 = edge.m_vertex1;
            const v2 = edge.m_vertex2;
            drawer.DrawSegment(v1, v2, color);
            break;
        }
        case 3 /* e_chainShape */: {
            const chain = shape;
            const count = chain.m_count;
            const vertices = chain.m_vertices;
            const ghostColor = DrawShape_s_ghostColor.SetRGBA(0.75 * color.r, 0.75 * color.g, 0.75 * color.b, color.a);
            let v1 = vertices[0];
            drawer.DrawPoint(v1, 4.0, color);
            if (chain.m_hasPrevVertex) {
                const vp = chain.m_prevVertex;
                drawer.DrawSegment(vp, v1, ghostColor);
                drawer.DrawCircle(vp, 0.1, ghostColor);
            }
            for (let i = 1; i < count; ++i) {
                const v2 = vertices[i];
                drawer.DrawSegment(v1, v2, color);
                drawer.DrawPoint(v2, 4.0, color);
                v1 = v2;
            }
            if (chain.m_hasNextVertex) {
                const vn = chain.m_nextVertex;
                drawer.DrawSegment(vn, v1, ghostColor);
                drawer.DrawCircle(vn, 0.1, ghostColor);
            }
            break;
        }
        case 2 /* e_polygonShape */: {
            const poly = shape;
            const vertexCount = poly.m_count;
            const vertices = poly.m_vertices;
            drawer.DrawSolidPolygon(vertices, vertexCount, color);
            break;
        }
    }
}
/// Call this to draw shapes and other debug draw data.
const DrawDebugData_s_color = new b2Color(0, 0, 0);
const DrawDebugData_s_vs = b2Vec2.MakeArray(4);
const DrawDebugData_s_xf = new b2Transform();
export function drawDebugData(drawer, world) {
    const flags = drawer.GetFlags();
    const color = DrawDebugData_s_color.SetRGB(0, 0, 0);
    if (flags & 1 /* e_shapeBit */) {
        for (let b = world.m_bodyList; b; b = b.m_next) {
            const xf = b.m_xf;
            drawer.PushTransform(xf);
            for (let f = b.GetFixtureList(); f; f = f.m_next) {
                if (!b.IsActive()) {
                    color.SetRGB(0.5, 0.5, 0.3);
                    DrawShape(drawer, f, color);
                }
                else if (b.GetType() === 0 /* b2_staticBody */) {
                    color.SetRGB(0.5, 0.9, 0.5);
                    DrawShape(drawer, f, color);
                }
                else if (b.GetType() === 1 /* b2_kinematicBody */) {
                    color.SetRGB(0.5, 0.5, 0.9);
                    DrawShape(drawer, f, color);
                }
                else if (!b.IsAwake()) {
                    color.SetRGB(0.6, 0.6, 0.6);
                    DrawShape(drawer, f, color);
                }
                else {
                    color.SetRGB(0.9, 0.7, 0.7);
                    DrawShape(drawer, f, color);
                }
            }
            drawer.PopTransform(xf);
        }
    }
    if (!!B2_ENABLE_PARTICLE && flags & 32 /* e_particleBit */) {
        for (let p = world.m_particleSystemList; p; p = p.m_next) {
            DrawParticleSystem(drawer, p);
        }
    }
    if (flags & 2 /* e_jointBit */) {
        for (let j = world.m_jointList; j; j = j.m_next) {
            DrawJoint(drawer, j);
        }
    }
    /*
      if (flags & b2DrawFlags.e_pairBit) {
        color.SetRGB(0.3, 0.9, 0.9);
        for (let contact = this.m_contactManager.m_contactList; contact; contact = contact.m_next) {
          const fixtureA = contact.GetFixtureA();
          const fixtureB = contact.GetFixtureB();
  
          const cA = fixtureA.GetAABB().GetCenter();
          const cB = fixtureB.GetAABB().GetCenter();
  
          this.m_debugDraw.DrawSegment(cA, cB, color);
        }
      }
      */
    if (flags & 4 /* e_aabbBit */) {
        color.SetRGB(0.9, 0.3, 0.9);
        const vs = DrawDebugData_s_vs;
        for (let b = world.m_bodyList; b; b = b.m_next) {
            if (!b.IsActive()) {
                continue;
            }
            for (let f = b.GetFixtureList(); f; f = f.m_next) {
                for (let i = 0; i < f.m_proxyCount; ++i) {
                    const proxy = f.m_proxies[i];
                    const aabb = proxy.treeNode.aabb;
                    vs[0].Set(aabb.lowerBound.x, aabb.lowerBound.y);
                    vs[1].Set(aabb.upperBound.x, aabb.lowerBound.y);
                    vs[2].Set(aabb.upperBound.x, aabb.upperBound.y);
                    vs[3].Set(aabb.lowerBound.x, aabb.upperBound.y);
                    drawer.DrawPolygon(vs, 4, color);
                }
            }
        }
    }
    if (flags & 16 /* e_centerOfMassBit */) {
        for (let b = world.m_bodyList; b; b = b.m_next) {
            const xf = DrawDebugData_s_xf;
            xf.q.Copy(b.m_xf.q);
            xf.p.Copy(b.GetWorldCenter());
            drawer.DrawTransform(xf);
        }
    }
    // @see b2Controller list
    if (B2_ENABLE_CONTROLLER) {
        if (flags & 64 /* e_controllerBit */) {
            for (let c = world.m_controllerList; c; c = c.m_next) {
                c.Draw(drawer);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhd0RlYnVnRGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9keW5hbWljcy9kcmF3RGVidWdEYXRhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQXVCLE1BQU0sa0JBQWtCLENBQUM7QUFZaEUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUd2RCxTQUFTLGtCQUFrQixDQUFDLE1BQWMsRUFBRSxNQUF3QjtJQUNsRSxNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUNoRCxJQUFJLGFBQWEsRUFBRTtRQUNqQixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDbEMsTUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDbEQsSUFBSSxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRTtZQUM3QixNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDNUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxjQUFjLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxhQUFhLENBQUMsQ0FBQztTQUMxRTthQUFNO1lBQ0wsTUFBTSxDQUFDLGFBQWEsQ0FBQyxjQUFjLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQztTQUNuRTtLQUNGO0FBQ0gsQ0FBQztBQUVELE1BQU0sY0FBYyxHQUFXLElBQUksTUFBTSxFQUFFLENBQUM7QUFDNUMsTUFBTSxjQUFjLEdBQVcsSUFBSSxNQUFNLEVBQUUsQ0FBQztBQUM1QyxNQUFNLGlCQUFpQixHQUFZLElBQUksT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDOUQsTUFBTSxhQUFhLEdBQVksSUFBSSxPQUFPLEVBQUUsQ0FBQztBQUU3QyxTQUFTLFNBQVMs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QUM7b0JBRWhELE1BQU0sQ0FBQyxXQUFXLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztpQkFDbEM7YUFDRjtTQUNGO0tBQ0Y7SUFFRCxJQUFJLEtBQUssNkJBQWdDLEVBQUU7UUFDekMsS0FBSyxJQUFJLENBQUMsR0FBa0IsS0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUU7WUFDN0QsTUFBTSxFQUFFLEdBQUcsa0JBQWtCLENBQUM7WUFDOUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwQixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztZQUM5QixNQUFNLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQzFCO0tBQ0Y7SUFFRCx5QkFBeUI7SUFDekIsSUFBSSxvQkFBb0IsRUFBRTtRQUN4QixJQUFJLEtBQUssMkJBQThCLEVBQUU7WUFDdkMsS0FBSyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFO2dCQUNwRCxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ2hCO1NBQ0Y7S0FDRjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBiMkNvbG9yLCBiMkRyYXcsIGIyRHJhd0ZsYWdzIH0gZnJvbSAnLi4vY29tbW9uL2IyRHJhdyc7XHJcbmltcG9ydCB7IGIyV29ybGQgfSBmcm9tICcuL2IyV29ybGQnO1xyXG5pbXBvcnQgeyBiMkJvZHksIGIyQm9keVR5cGUgfSBmcm9tICcuL2IyQm9keSc7XHJcbmltcG9ydCB7IGIyQUFCQiB9IGZyb20gJy4uL2NvbGxpc2lvbi9iMkNvbGxpc2lvbic7XHJcbmltcG9ydCB7IGIyQ2hhaW5TaGFwZSB9IGZyb20gJy4uL2NvbGxpc2lvbi9zaGFwZXMvYjJDaGFpblNoYXBlJztcclxuaW1wb3J0IHsgYjJDaXJjbGVTaGFwZSB9IGZyb20gJy4uL2NvbGxpc2lvbi9zaGFwZXMvYjJDaXJjbGVTaGFwZSc7XHJcbmltcG9ydCB7IGIyRWRnZVNoYXBlIH0gZnJvbSAnLi4vY29sbGlzaW9uL3NoYXBlcy9iMkVkZ2VTaGFwZSc7XHJcbmltcG9ydCB7IGIyUG9seWdvblNoYXBlIH0gZnJvbSAnLi4vY29sbGlzaW9uL3NoYXBlcy9iMlBvbHlnb25TaGFwZSc7XHJcbmltcG9ydCB7IGIyU2hhcGUsIGIyU2hhcGVUeXBlIH0gZnJvbSAnLi4vY29sbGlzaW9uL3NoYXBlcy9iMlNoYXBlJztcclxuaW1wb3J0IHsgYjJGaXh0dXJlLCBiMkZpeHR1cmVQcm94eSB9IGZyb20gJy4vYjJGaXh0dXJlJztcclxuaW1wb3J0IHsgYjJKb2ludCwgYjJKb2ludFR5cGUgfSBmcm9tICcuL2pvaW50cy9iMkpvaW50JztcclxuaW1wb3J0IHsgYjJQdWxsZXlKb2ludCB9IGZyb20gJy4vam9pbnRzL2IyUHVsbGV5Sm9pbnQnO1xyXG5pbXBvcnQgeyBiMlRyYW5zZm9ybSwgYjJWZWMyIH0gZnJvbSAnLi4vY29tbW9uL2IyTWF0aCc7XHJcbmltcG9ydCB7IGIyUGFydGljbGVTeXN0ZW0gfSBmcm9tICcuLi9wYXJ0aWNsZS9iMlBhcnRpY2xlU3lzdGVtJztcclxuXHJcbmZ1bmN0aW9uIERyYXdQYXJ0aWNsZVN5c3RlbShkcmF3ZXI6IGIyRHJhdywgc3lzdGVtOiBiMlBhcnRpY2xlU3lzdGVtKTogdm9pZCB7XHJcbiAgY29uc3QgcGFydGljbGVDb3VudCA9IHN5c3RlbS5HZXRQYXJ0aWNsZUNvdW50KCk7XHJcbiAgaWYgKHBhcnRpY2xlQ291bnQpIHtcclxuICAgIGNvbnN0IHJhZGl1cyA9IHN5c3RlbS5HZXRSYWRpdXMoKTtcclxuICAgIGNvbnN0IHBvc2l0aW9uQnVmZmVyID0gc3lzdGVtLkdldFBvc2l0aW9uQnVmZmVyKCk7XHJcbiAgICBpZiAoc3lzdGVtLm1fY29sb3JCdWZmZXIuZGF0YSkge1xyXG4gICAgICBjb25zdCBjb2xvckJ1ZmZlciA9IHN5c3RlbS5HZXRDb2xvckJ1ZmZlcigpO1xyXG4gICAgICBkcmF3ZXIuRHJhd1BhcnRpY2xlcyhwb3NpdGlvbkJ1ZmZlciwgcmFkaXVzLCBjb2xvckJ1ZmZlciwgcGFydGljbGVDb3VudCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBkcmF3ZXIuRHJhd1BhcnRpY2xlcyhwb3NpdGlvbkJ1ZmZlciwgcmFkaXVzLCBudWxsLCBwYXJ0aWNsZUNvdW50KTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmNvbnN0IERyYXdKb2ludF9zX3AxOiBiMlZlYzIgPSBuZXcgYjJWZWMyKCk7XHJcbmNvbnN0IERyYXdKb2ludF9zX3AyOiBiMlZlYzIgPSBuZXcgYjJWZWMyKCk7XHJcbmNvbnN0IERyYXdKb2ludF9zX2NvbG9yOiBiMkNvbG9yID0gbmV3IGIyQ29sb3IoMC41LCAwLjgsIDAuOCk7XHJcbmNvbnN0IERyYXdKb2ludF9zX2M6IGIyQ29sb3IgPSBuZXcgYjJDb2xvcigpO1xyXG5cclxuZnVuY3Rpb24gRHJhd0pvaW50KGRyYXdlcjogYjJEcmF3LCBqb2ludDogYjJKb2ludCk6IHZvaWQge1xyXG4gIGNvbnN0IGJvZHlBOiBiMkJvZHkgPSBqb2ludC5HZXRCb2R5QSgpO1xyXG4gIGNvbnN0IGJvZHlCOiBiMkJvZHkgPSBqb2ludC5HZXRCb2R5QigpO1xyXG4gIGNvbnN0IHhmMTogYjJUcmFuc2Zvcm0gPSBib2R5QS5tX3hmO1xyXG4gIGNvbnN0IHhmMjogYjJUcmFuc2Zvcm0gPSBib2R5Qi5tX3hmO1xyXG4gIGNvbnN0IHgxOiBiMlZlYzIgPSB4ZjEucDtcclxuICBjb25zdCB4MjogYjJWZWMyID0geGYyLnA7XHJcbiAgY29uc3QgcDE6IGIyVmVjMiA9IGpvaW50LkdldEFuY2hvckEoRHJhd0pvaW50X3NfcDEpO1xyXG4gIGNvbnN0IHAyOiBiMlZlYzIgPSBqb2ludC5HZXRBbmNob3JCKERyYXdKb2ludF9zX3AyKTtcclxuXHJcbiAgY29uc3QgY29sb3I6IGIyQ29sb3IgPSBEcmF3Sm9pbnRfc19jb2xvci5TZXRSR0IoMC41LCAwLjgsIDAuOCk7XHJcblxyXG4gIHN3aXRjaCAoam9pbnQubV90eXBlKSB7XHJcbiAgICBjYXNlIGIySm9pbnRUeXBlLmVfZGlzdGFuY2VKb2ludDpcclxuICAgICAgZHJhd2VyLkRyYXdTZWdtZW50KHAxLCBwMiwgY29sb3IpO1xyXG4gICAgICBicmVhaztcclxuXHJcbiAgICBjYXNlIGIySm9pbnRUeXBlLmVfcHVsbGV5Sm9pbnQ6IHtcclxuICAgICAgY29uc3QgcHVsbGV5ID0gam9pbnQgYXMgYjJQdWxsZXlKb2ludDtcclxuICAgICAgY29uc3QgczE6IGIyVmVjMiA9IHB1bGxleS5HZXRHcm91bmRBbmNob3JBKCk7XHJcbiAgICAgIGNvbnN0IHMyOiBiMlZlYzIgPSBwdWxsZXkuR2V0R3JvdW5kQW5jaG9yQigpO1xyXG4gICAgICBkcmF3ZXIuRHJhd1NlZ21lbnQoczEsIHAxLCBjb2xvcik7XHJcbiAgICAgIGRyYXdlci5EcmF3U2VnbWVudChzMiwgcDIsIGNvbG9yKTtcclxuICAgICAgZHJhd2VyLkRyYXdTZWdtZW50KHMxLCBzMiwgY29sb3IpO1xyXG4gICAgICBicmVhaztcclxuICAgIH1cclxuXHJcbiAgICBjYXNlIGIySm9pbnRUeXBlLmVfbW91c2VKb2ludDoge1xyXG4gICAgICBjb25zdCBjID0gRHJhd0pvaW50X3NfYztcclxuICAgICAgYy5TZXQoMC4wLCAxLjAsIDAuMCk7XHJcbiAgICAgIGRyYXdlci5EcmF3UG9pbnQocDEsIDQuMCwgYyk7XHJcbiAgICAgIGRyYXdlci5EcmF3UG9pbnQocDIsIDQuMCwgYyk7XHJcblxyXG4gICAgICBjLlNldCgwLjgsIDAuOCwgMC44KTtcclxuICAgICAgZHJhd2VyLkRyYXdTZWdtZW50KHAxLCBwMiwgYyk7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG5cclxuICAgIGRlZmF1bHQ6XHJcbiAgICAgIGRyYXdlci5EcmF3U2VnbWVudCh4MSwgcDEsIGNvbG9yKTtcclxuICAgICAgZHJhd2VyLkRyYXdTZWdtZW50KHAxLCBwMiwgY29sb3IpO1xyXG4gICAgICBkcmF3ZXIuRHJhd1NlZ21lbnQoeDIsIHAyLCBjb2xvcik7XHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBEcmF3U2hhcGVfc19naG9zdENvbG9yID0gbmV3IGIyQ29sb3IoKTtcclxuXHJcbmZ1bmN0aW9uIERyYXdTaGFwZShkcmF3ZXI6IGIyRHJhdywgZml4dHVyZTogYjJGaXh0dXJlLCBjb2xvcjogYjJDb2xvcik6IHZvaWQge1xyXG4gIGNvbnN0IHNoYXBlOiBiMlNoYXBlID0gZml4dHVyZS5HZXRTaGFwZSgpO1xyXG5cclxuICBzd2l0Y2ggKHNoYXBlLm1fdHlwZSkge1xyXG4gICAgY2FzZSBiMlNoYXBlVHlwZS5lX2NpcmNsZVNoYXBlOiB7XHJcbiAgICAgIGNvbnN0IGNpcmNsZTogYjJDaXJjbGVTaGFwZSA9IHNoYXBlIGFzIGIyQ2lyY2xlU2hhcGU7XHJcbiAgICAgIGNvbnN0IGNlbnRlcjogYjJWZWMyID0gY2lyY2xlLm1fcDtcclxuICAgICAgY29uc3QgcmFkaXVzOiBudW1iZXIgPSBjaXJjbGUubV9yYWRpdXM7XHJcbiAgICAgIGNvbnN0IGF4aXM6IGIyVmVjMiA9IGIyVmVjMi5VTklUWDtcclxuICAgICAgZHJhd2VyLkRyYXdTb2xpZENpcmNsZShjZW50ZXIsIHJhZGl1cywgYXhpcywgY29sb3IpO1xyXG4gICAgICBicmVhaztcclxuICAgIH1cclxuXHJcbiAgICBjYXNlIGIyU2hhcGVUeXBlLmVfZWRnZVNoYXBlOiB7XHJcbiAgICAgIGNvbnN0IGVkZ2U6IGIyRWRnZVNoYXBlID0gc2hhcGUgYXMgYjJFZGdlU2hhcGU7XHJcbiAgICAgIGNvbnN0IHYxOiBiMlZlYzIgPSBlZGdlLm1fdmVydGV4MTtcclxuICAgICAgY29uc3QgdjI6IGIyVmVjMiA9IGVkZ2UubV92ZXJ0ZXgyO1xyXG4gICAgICBkcmF3ZXIuRHJhd1NlZ21lbnQodjEsIHYyLCBjb2xvcik7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG5cclxuICAgIGNhc2UgYjJTaGFwZVR5cGUuZV9jaGFpblNoYXBlOiB7XHJcbiAgICAgIGNvbnN0IGNoYWluOiBiMkNoYWluU2hhcGUgPSBzaGFwZSBhcyBiMkNoYWluU2hhcGU7XHJcbiAgICAgIGNvbnN0IGNvdW50OiBudW1iZXIgPSBjaGFpbi5tX2NvdW50O1xyXG4gICAgICBjb25zdCB2ZXJ0aWNlczogYjJWZWMyW10gPSBjaGFpbi5tX3ZlcnRpY2VzO1xyXG4gICAgICBjb25zdCBnaG9zdENvbG9yOiBiMkNvbG9yID0gRHJhd1NoYXBlX3NfZ2hvc3RDb2xvci5TZXRSR0JBKFxyXG4gICAgICAgIDAuNzUgKiBjb2xvci5yLFxyXG4gICAgICAgIDAuNzUgKiBjb2xvci5nLFxyXG4gICAgICAgIDAuNzUgKiBjb2xvci5iLFxyXG4gICAgICAgIGNvbG9yLmEsXHJcbiAgICAgICk7XHJcbiAgICAgIGxldCB2MTogYjJWZWMyID0gdmVydGljZXNbMF07XHJcbiAgICAgIGRyYXdlci5EcmF3UG9pbnQodjEsIDQuMCwgY29sb3IpO1xyXG5cclxuICAgICAgaWYgKGNoYWluLm1faGFzUHJldlZlcnRleCkge1xyXG4gICAgICAgIGNvbnN0IHZwID0gY2hhaW4ubV9wcmV2VmVydGV4O1xyXG4gICAgICAgIGRyYXdlci5EcmF3U2VnbWVudCh2cCwgdjEsIGdob3N0Q29sb3IpO1xyXG4gICAgICAgIGRyYXdlci5EcmF3Q2lyY2xlKHZwLCAwLjEsIGdob3N0Q29sb3IpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGNvdW50OyArK2kpIHtcclxuICAgICAgICBjb25zdCB2MjogYjJWZWMyID0gdmVydGljZXNbaV07XHJcbiAgICAgICAgZHJhd2VyLkRyYXdTZWdtZW50KHYxLCB2MiwgY29sb3IpO1xyXG4gICAgICAgIGRyYXdlci5EcmF3UG9pbnQodjIsIDQuMCwgY29sb3IpO1xyXG4gICAgICAgIHYxID0gdjI7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChjaGFpbi5tX2hhc05leHRWZXJ0ZXgpIHtcclxuICAgICAgICBjb25zdCB2biA9IGNoYWluLm1fbmV4dFZlcnRleDtcclxuICAgICAgICBkcmF3ZXIuRHJhd1NlZ21lbnQodm4sIHYxLCBnaG9zdENvbG9yKTtcclxuICAgICAgICBkcmF3ZXIuRHJhd0NpcmNsZSh2biwgMC4xLCBnaG9zdENvbG9yKTtcclxuICAgICAgfVxyXG4gICAgICBicmVhaztcclxuICAgIH1cclxuXHJcbiAgICBjYXNlIGIyU2hhcGVUeXBlLmVfcG9seWdvblNoYXBlOiB7XHJcbiAgICAgIGNvbnN0IHBvbHk6IGIyUG9seWdvblNoYXBlID0gc2hhcGUgYXMgYjJQb2x5Z29uU2hhcGU7XHJcbiAgICAgIGNvbnN0IHZlcnRleENvdW50OiBudW1iZXIgPSBwb2x5Lm1fY291bnQ7XHJcbiAgICAgIGNvbnN0IHZlcnRpY2VzOiBiMlZlYzJbXSA9IHBvbHkubV92ZXJ0aWNlcztcclxuICAgICAgZHJhd2VyLkRyYXdTb2xpZFBvbHlnb24odmVydGljZXMsIHZlcnRleENvdW50LCBjb2xvcik7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuLy8vIENhbGwgdGhpcyB0byBkcmF3IHNoYXBlcyBhbmQgb3RoZXIgZGVidWcgZHJhdyBkYXRhLlxyXG5jb25zdCBEcmF3RGVidWdEYXRhX3NfY29sb3IgPSBuZXcgYjJDb2xvcigwLCAwLCAwKTtcclxuY29uc3QgRHJhd0RlYnVnRGF0YV9zX3ZzID0gYjJWZWMyLk1ha2VBcnJheSg0KTtcclxuY29uc3QgRHJhd0RlYnVnRGF0YV9zX3hmID0gbmV3IGIyVHJhbnNmb3JtKCk7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZHJhd0RlYnVnRGF0YShkcmF3ZXI6IGIyRHJhdywgd29ybGQ6IGIyV29ybGQpOiB2b2lkIHtcclxuICBjb25zdCBmbGFncyA9IGRyYXdlci5HZXRGbGFncygpO1xyXG4gIGNvbnN0IGNvbG9yID0gRHJhd0RlYnVnRGF0YV9zX2NvbG9yLlNldFJHQigwLCAwLCAwKTtcclxuXHJcbiAgaWYgKGZsYWdzICYgYjJEcmF3RmxhZ3MuZV9zaGFwZUJpdCkge1xyXG4gICAgZm9yIChsZXQgYjogYjJCb2R5IHwgbnVsbCA9IHdvcmxkLm1fYm9keUxpc3Q7IGI7IGIgPSBiLm1fbmV4dCkge1xyXG4gICAgICBjb25zdCB4ZjogYjJUcmFuc2Zvcm0gPSBiLm1feGY7XHJcblxyXG4gICAgICBkcmF3ZXIuUHVzaFRyYW5zZm9ybSh4Zik7XHJcblxyXG4gICAgICBmb3IgKGxldCBmID0gYi5HZXRGaXh0dXJlTGlzdCgpOyBmOyBmID0gZi5tX25leHQpIHtcclxuICAgICAgICBpZiAoIWIuSXNBY3RpdmUoKSkge1xyXG4gICAgICAgICAgY29sb3IuU2V0UkdCKDAuNSwgMC41LCAwLjMpO1xyXG4gICAgICAgICAgRHJhd1NoYXBlKGRyYXdlciwgZiwgY29sb3IpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoYi5HZXRUeXBlKCkgPT09IGIyQm9keVR5cGUuYjJfc3RhdGljQm9keSkge1xyXG4gICAgICAgICAgY29sb3IuU2V0UkdCKDAuNSwgMC45LCAwLjUpO1xyXG4gICAgICAgICAgRHJhd1NoYXBlKGRyYXdlciwgZiwgY29sb3IpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoYi5HZXRUeXBlKCkgPT09IGIyQm9keVR5cGUuYjJfa2luZW1hdGljQm9keSkge1xyXG4gICAgICAgICAgY29sb3IuU2V0UkdCKDAuNSwgMC41LCAwLjkpO1xyXG4gICAgICAgICAgRHJhd1NoYXBlKGRyYXdlciwgZiwgY29sb3IpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoIWIuSXNBd2FrZSgpKSB7XHJcbiAgICAgICAgICBjb2xvci5TZXRSR0IoMC42LCAwLjYsIDAuNik7XHJcbiAgICAgICAgICBEcmF3U2hhcGUoZHJhd2VyLCBmLCBjb2xvcik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNvbG9yLlNldFJHQigwLjksIDAuNywgMC43KTtcclxuICAgICAgICAgIERyYXdTaGFwZShkcmF3ZXIsIGYsIGNvbG9yKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGRyYXdlci5Qb3BUcmFuc2Zvcm0oeGYpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaWYgKCEhQjJfRU5BQkxFX1BBUlRJQ0xFICYmIGZsYWdzICYgYjJEcmF3RmxhZ3MuZV9wYXJ0aWNsZUJpdCkge1xyXG4gICAgZm9yIChsZXQgcCA9IHdvcmxkLm1fcGFydGljbGVTeXN0ZW1MaXN0OyBwOyBwID0gcC5tX25leHQpIHtcclxuICAgICAgRHJhd1BhcnRpY2xlU3lzdGVtKGRyYXdlciwgcCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBpZiAoZmxhZ3MgJiBiMkRyYXdGbGFncy5lX2pvaW50Qml0KSB7XHJcbiAgICBmb3IgKGxldCBqID0gd29ybGQubV9qb2ludExpc3Q7IGo7IGogPSBqLm1fbmV4dCkge1xyXG4gICAgICBEcmF3Sm9pbnQoZHJhd2VyLCBqKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qXHJcbiAgICBpZiAoZmxhZ3MgJiBiMkRyYXdGbGFncy5lX3BhaXJCaXQpIHtcclxuICAgICAgY29sb3IuU2V0UkdCKDAuMywgMC45LCAwLjkpO1xyXG4gICAgICBmb3IgKGxldCBjb250YWN0ID0gdGhpcy5tX2NvbnRhY3RNYW5hZ2VyLm1fY29udGFjdExpc3Q7IGNvbnRhY3Q7IGNvbnRhY3QgPSBjb250YWN0Lm1fbmV4dCkge1xyXG4gICAgICAgIGNvbnN0IGZpeHR1cmVBID0gY29udGFjdC5HZXRGaXh0dXJlQSgpO1xyXG4gICAgICAgIGNvbnN0IGZpeHR1cmVCID0gY29udGFjdC5HZXRGaXh0dXJlQigpO1xyXG5cclxuICAgICAgICBjb25zdCBjQSA9IGZpeHR1cmVBLkdldEFBQkIoKS5HZXRDZW50ZXIoKTtcclxuICAgICAgICBjb25zdCBjQiA9IGZpeHR1cmVCLkdldEFBQkIoKS5HZXRDZW50ZXIoKTtcclxuXHJcbiAgICAgICAgdGhpcy5tX2RlYnVnRHJhdy5EcmF3U2VnbWVudChjQSwgY0IsIGNvbG9yKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgKi9cclxuXHJcbiAgaWYgKGZsYWdzICYgYjJEcmF3RmxhZ3MuZV9hYWJiQml0KSB7XHJcbiAgICBjb2xvci5TZXRSR0IoMC45LCAwLjMsIDAuOSk7XHJcbiAgICBjb25zdCB2cyA9IERyYXdEZWJ1Z0RhdGFfc192cztcclxuXHJcbiAgICBmb3IgKGxldCBiOiBiMkJvZHkgfCBudWxsID0gd29ybGQubV9ib2R5TGlzdDsgYjsgYiA9IGIubV9uZXh0KSB7XHJcbiAgICAgIGlmICghYi5Jc0FjdGl2ZSgpKSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGZvciAobGV0IGYgPSBiLkdldEZpeHR1cmVMaXN0KCk7IGY7IGYgPSBmLm1fbmV4dCkge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZi5tX3Byb3h5Q291bnQ7ICsraSkge1xyXG4gICAgICAgICAgY29uc3QgcHJveHk6IGIyRml4dHVyZVByb3h5ID0gZi5tX3Byb3hpZXNbaV07XHJcblxyXG4gICAgICAgICAgY29uc3QgYWFiYjogYjJBQUJCID0gcHJveHkudHJlZU5vZGUuYWFiYjtcclxuICAgICAgICAgIHZzWzBdLlNldChhYWJiLmxvd2VyQm91bmQueCwgYWFiYi5sb3dlckJvdW5kLnkpO1xyXG4gICAgICAgICAgdnNbMV0uU2V0KGFhYmIudXBwZXJCb3VuZC54LCBhYWJiLmxvd2VyQm91bmQueSk7XHJcbiAgICAgICAgICB2c1syXS5TZXQoYWFiYi51cHBlckJvdW5kLngsIGFhYmIudXBwZXJCb3VuZC55KTtcclxuICAgICAgICAgIHZzWzNdLlNldChhYWJiLmxvd2VyQm91bmQueCwgYWFiYi51cHBlckJvdW5kLnkpO1xyXG5cclxuICAgICAgICAgIGRyYXdlci5EcmF3UG9seWdvbih2cywgNCwgY29sb3IpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaWYgKGZsYWdzICYgYjJEcmF3RmxhZ3MuZV9jZW50ZXJPZk1hc3NCaXQpIHtcclxuICAgIGZvciAobGV0IGI6IGIyQm9keSB8IG51bGwgPSB3b3JsZC5tX2JvZHlMaXN0OyBiOyBiID0gYi5tX25leHQpIHtcclxuICAgICAgY29uc3QgeGYgPSBEcmF3RGVidWdEYXRhX3NfeGY7XHJcbiAgICAgIHhmLnEuQ29weShiLm1feGYucSk7XHJcbiAgICAgIHhmLnAuQ29weShiLkdldFdvcmxkQ2VudGVyKCkpO1xyXG4gICAgICBkcmF3ZXIuRHJhd1RyYW5zZm9ybSh4Zik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBAc2VlIGIyQ29udHJvbGxlciBsaXN0XHJcbiAgaWYgKEIyX0VOQUJMRV9DT05UUk9MTEVSKSB7XHJcbiAgICBpZiAoZmxhZ3MgJiBiMkRyYXdGbGFncy5lX2NvbnRyb2xsZXJCaXQpIHtcclxuICAgICAgZm9yIChsZXQgYyA9IHdvcmxkLm1fY29udHJvbGxlckxpc3Q7IGM7IGMgPSBjLm1fbmV4dCkge1xyXG4gICAgICAgIGMuRHJhdyhkcmF3ZXIpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==