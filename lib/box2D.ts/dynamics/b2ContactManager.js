/*
 * Copyright (c) 2006-2009 Erin Catto http://www.box2d.org
 *
 * This software is provided 'as-is', without any express or implied
 * warranty.  In no event will the authors be held liable for any damages
 * arising from the use of this software.
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 * 1. The origin of this software must not be misrepresented; you must not
 * claim that you wrote the original software. If you use this software
 * in a product, an acknowledgment in the product documentation would be
 * appreciated but is not required.
 * 2. Altered source versions must be plainly marked as such, and must not be
 * misrepresented as being the original software.
 * 3. This notice may not be removed or altered from any source distribution.
 */
import { b2Assert } from '../common/b2Settings';
import { b2BroadPhase } from '../collision/b2BroadPhase';
import { b2TestOverlapAABB } from '../collision/b2Collision';
import { b2ContactFactory } from './contacts/b2ContactFactory';
import { b2FixtureProxy } from './b2Fixture';
import { b2ContactFilter, b2ContactListener } from './b2WorldCallbacks';
// Delegate of b2World.
export class b2ContactManager {
    constructor() {
        this.m_broadPhase = new b2BroadPhase();
        this.m_contactList = null;
        this.m_contactCount = 0;
        this.m_contactFilter = b2ContactFilter.b2_defaultFilter;
        this.m_contactListener = b2ContactListener.b2_defaultListener;
        this.m_contactFactory = new b2ContactFactory();
    }
    // Broad-phase callback.
    AddPair(proxyA, proxyB) {
        !!B2_DEBUG && b2Assert(proxyA instanceof b2FixtureProxy);
        !!B2_DEBUG && b2Assert(proxyB instanceof b2FixtureProxy);
        let fixtureA = proxyA.fixture;
        let fixtureB = proxyB.fixture;
        const indexA = proxyA.childIndex;
        const indexB = proxyB.childIndex;
        let bodyA = fixtureA.GetBody();
        let bodyB = fixtureB.GetBody();
        // Are the fixtures on the same body?
        if (bodyA === bodyB) {
            return;
        }
        // TODO_ERIN use a hash table to remove a potential bottleneck when both
        // bodies have a lot of contacts.
        // Does a contact already exist?
        let edge = bodyB.GetContactList();
        while (edge !== null) {
            if (edge.other === bodyA) {
                const fA = edge.contact.GetFixtureA();
                const fB = edge.contact.GetFixtureB();
                const iA = edge.contact.GetChildIndexA();
                const iB = edge.contact.GetChildIndexB();
                if (fA === fixtureA && fB === fixtureB && iA === indexA && iB === indexB) {
                    // A contact already exists.
                    return;
                }
                if (fA === fixtureB && fB === fixtureA && iA === indexB && iB === indexA) {
                    // A contact already exists.
                    return;
                }
            }
            edge = edge.next;
        }
        // Does a joint override collision? Is at least one body dynamic?
        if (!bodyB.ShouldCollide(bodyA)) {
            return;
        }
        // Check user filtering.
        if (this.m_contactFilter && !this.m_contactFilter.ShouldCollide(fixtureA, fixtureB)) {
            return;
        }
        // Call the factory.
        const c = this.m_contactFactory.Create(fixtureA, indexA, fixtureB, indexB);
        if (c === null) {
            return;
        }
        // Contact creation may swap fixtures.
        fixtureA = c.GetFixtureA();
        fixtureB = c.GetFixtureB();
        //indexA = c.GetChildIndexA();
        //indexB = c.GetChildIndexB();
        bodyA = fixtureA.m_body;
        bodyB = fixtureB.m_body;
        // Insert into the world.
        c.m_prev = null;
        c.m_next = this.m_contactList;
        if (this.m_contactList !== null) {
            this.m_contactList.m_prev = c;
        }
        this.m_contactList = c;
        // Connect to island graph.
        // Connect to body A
        c.m_nodeA.other = bodyB;
        c.m_nodeA.prev = null;
        c.m_nodeA.next = bodyA.m_contactList;
        if (bodyA.m_contactList !== null) {
            bodyA.m_contactList.prev = c.m_nodeA;
        }
        bodyA.m_contactList = c.m_nodeA;
        // Connect to body B
        c.m_nodeB.other = bodyA;
        c.m_nodeB.prev = null;
        c.m_nodeB.next = bodyB.m_contactList;
        if (bodyB.m_contactList !== null) {
            bodyB.m_contactList.prev = c.m_nodeB;
        }
        bodyB.m_contactList = c.m_nodeB;
        // Wake up the bodies
        if (!fixtureA.IsSensor() && !fixtureB.IsSensor()) {
            bodyA.SetAwake(true);
            bodyB.SetAwake(true);
        }
        ++this.m_contactCount;
    }
    FindNewContacts() {
        const listA = b2ContactManager.s_updatePairs_proxyA;
        const listB = b2ContactManager.s_updatePairs_proxyB;
        listA.length = 0;
        listB.length = 0;
        this.m_broadPhase.UpdatePairs_(listA, listB);
        for (let i = 0; i < listA.length; ++i) {
            this.AddPair(listA[i], listB[i]);
        }
    }
    Destroy(c) {
        const fixtureA = c.GetFixtureA();
        const fixtureB = c.GetFixtureB();
        const bodyA = fixtureA.GetBody();
        const bodyB = fixtureB.GetBody();
        if (this.m_contactListener && c.IsTouching()) {
            this.m_contactListener.EndContact(c);
        }
        // Remove from the world.
        if (c.m_prev) {
            c.m_prev.m_next = c.m_next;
        }
        if (c.m_next) {
            c.m_next.m_prev = c.m_prev;
        }
        if (c === this.m_contactList) {
            this.m_contactList = c.m_next;
        }
        // Remove from body 1
        if (c.m_nodeA.prev) {
            c.m_nodeA.prev.next = c.m_nodeA.next;
        }
        if (c.m_nodeA.next) {
            c.m_nodeA.next.prev = c.m_nodeA.prev;
        }
        if (c.m_nodeA === bodyA.m_contactList) {
            bodyA.m_contactList = c.m_nodeA.next;
        }
        // Remove from body 2
        if (c.m_nodeB.prev) {
            c.m_nodeB.prev.next = c.m_nodeB.next;
        }
        if (c.m_nodeB.next) {
            c.m_nodeB.next.prev = c.m_nodeB.prev;
        }
        if (c.m_nodeB === bodyB.m_contactList) {
            bodyB.m_contactList = c.m_nodeB.next;
        }
        // moved this from b2ContactFactory:Destroy
        if (c.m_manifold.pointCount > 0 && !fixtureA.IsSensor() && !fixtureB.IsSensor()) {
            fixtureA.GetBody().SetAwake(true);
            fixtureB.GetBody().SetAwake(true);
        }
        // Call the factory.
        this.m_contactFactory.Destroy(c);
        --this.m_contactCount;
    }
    // This is the top level collision call for the time step. Here
    // all the narrow phase collision is processed for the world
    // contact list.
    Collide() {
        // Update awake contacts.
        let c = this.m_contactList;
        while (c) {
            const fixtureA = c.GetFixtureA();
            const fixtureB = c.GetFixtureB();
            const indexA = c.GetChildIndexA();
            const indexB = c.GetChildIndexB();
            const bodyA = fixtureA.GetBody();
            const bodyB = fixtureB.GetBody();
            // Is this contact flagged for filtering?
            if (c.m_filterFlag) {
                // Check user filtering.
                if (this.m_contactFilter && !this.m_contactFilter.ShouldCollide(fixtureA, fixtureB)) {
                    const cNuke = c;
                    c = cNuke.m_next;
                    this.Destroy(cNuke);
                    continue;
                }
                // Clear the filtering flag.
                c.m_filterFlag = false;
            }
            const activeA = bodyA.IsAwake() && bodyA.m_type !== 0 /* b2_staticBody */;
            const activeB = bodyB.IsAwake() && bodyB.m_type !== 0 /* b2_staticBody */;
            // At least one body must be awake and it must be dynamic or kinematic.
            if (!activeA && !activeB) {
                c = c.m_next;
                continue;
            }
            const treeNodeA = fixtureA.m_proxies[indexA].treeNode;
            const treeNodeB = fixtureB.m_proxies[indexB].treeNode;
            const overlap = b2TestOverlapAABB(treeNodeA.aabb, treeNodeB.aabb);
            // Here we destroy contacts that cease to overlap in the broad-phase.
            if (!overlap) {
                const cNuke = c;
                c = cNuke.m_next;
                this.Destroy(cNuke);
                continue;
            }
            // The contact persists.
            c.Update(this.m_contactListener);
            c = c.m_next;
        }
    }
}
b2ContactManager.s_updatePairs_proxyA = [];
b2ContactManager.s_updatePairs_proxyB = [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYjJDb250YWN0TWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9keW5hbWljcy9iMkNvbnRhY3RNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7O0dBZ0JHO0FBRUgsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUV6RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUU3RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUUvRCxPQUFPLEVBQWEsY0FBYyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3hELE9BQU8sRUFBRSxlQUFlLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUV4RSx1QkFBdUI7QUFDdkIsTUFBTSxPQUFPLGdCQUFnQjtJQUE3QjtRQUNXLGlCQUFZLEdBQWlDLElBQUksWUFBWSxFQUFrQixDQUFDO1FBQ3pGLGtCQUFhLEdBQXFCLElBQUksQ0FBQztRQUN2QyxtQkFBYyxHQUFHLENBQUMsQ0FBQztRQUNuQixvQkFBZSxHQUFvQixlQUFlLENBQUMsZ0JBQWdCLENBQUM7UUFDcEUsc0JBQWlCLEdBQXNCLGlCQUFpQixDQUFDLGtCQUFrQixDQUFDO1FBRW5FLHFCQUFnQixHQUFxQixJQUFJLGdCQUFnQixFQUFFLENBQUM7SUE4T3ZFLENBQUM7SUE1T0Msd0JBQXdCO0lBQ3hCLE9BQU8sQ0FBQyxNQUFzQixFQUFFLE1BQXNCO1FBQ3BELENBQUMsQ0FBQyxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sWUFBWSxjQUFjLENBQUMsQ0FBQztRQUN6RCxDQUFDLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxNQUFNLFlBQVksY0FBYyxDQUFDLENBQUM7UUFFekQsSUFBSSxRQUFRLEdBQUcsTUFBTSxD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QUcsS0FBSyxDQUFDO2FBQ3hCO1lBRUQsTUFBTSxPQUFPLEdBQVksS0FBSyxDQUFDLE9BQU8sRUFBRSxJQUFJLEtBQUssQ0FBQyxNQUFNLDBCQUE2QixDQUFDO1lBQ3RGLE1BQU0sT0FBTyxHQUFZLEtBQUssQ0FBQyxPQUFPLEVBQUUsSUFBSSxLQUFLLENBQUMsTUFBTSwwQkFBNkIsQ0FBQztZQUV0Rix1RUFBdUU7WUFDdkUsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDeEIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7Z0JBQ2IsU0FBUzthQUNWO1lBRUQsTUFBTSxTQUFTLEdBQStCLFFBQVEsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBUSxDQUFDO1lBQ2xGLE1BQU0sU0FBUyxHQUErQixRQUFRLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsQ0FBQztZQUNsRixNQUFNLE9BQU8sR0FBWSxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUUzRSxxRUFBcUU7WUFDckUsSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDWixNQUFNLEtBQUssR0FBYyxDQUFDLENBQUM7Z0JBQzNCLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO2dCQUNqQixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNwQixTQUFTO2FBQ1Y7WUFFRCx3QkFBd0I7WUFDeEIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUNqQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztTQUNkO0lBQ0gsQ0FBQzs7QUFoSU0scUNBQW9CLEdBQXFCLEVBQUUsQ0FBQztBQUM1QyxxQ0FBb0IsR0FBcUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQ29weXJpZ2h0IChjKSAyMDA2LTIwMDkgRXJpbiBDYXR0byBodHRwOi8vd3d3LmJveDJkLm9yZ1xyXG4gKlxyXG4gKiBUaGlzIHNvZnR3YXJlIGlzIHByb3ZpZGVkICdhcy1pcycsIHdpdGhvdXQgYW55IGV4cHJlc3Mgb3IgaW1wbGllZFxyXG4gKiB3YXJyYW50eS4gIEluIG5vIGV2ZW50IHdpbGwgdGhlIGF1dGhvcnMgYmUgaGVsZCBsaWFibGUgZm9yIGFueSBkYW1hZ2VzXHJcbiAqIGFyaXNpbmcgZnJvbSB0aGUgdXNlIG9mIHRoaXMgc29mdHdhcmUuXHJcbiAqIFBlcm1pc3Npb24gaXMgZ3JhbnRlZCB0byBhbnlvbmUgdG8gdXNlIHRoaXMgc29mdHdhcmUgZm9yIGFueSBwdXJwb3NlLFxyXG4gKiBpbmNsdWRpbmcgY29tbWVyY2lhbCBhcHBsaWNhdGlvbnMsIGFuZCB0byBhbHRlciBpdCBhbmQgcmVkaXN0cmlidXRlIGl0XHJcbiAqIGZyZWVseSwgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIHJlc3RyaWN0aW9uczpcclxuICogMS4gVGhlIG9yaWdpbiBvZiB0aGlzIHNvZnR3YXJlIG11c3Qgbm90IGJlIG1pc3JlcHJlc2VudGVkOyB5b3UgbXVzdCBub3RcclxuICogY2xhaW0gdGhhdCB5b3Ugd3JvdGUgdGhlIG9yaWdpbmFsIHNvZnR3YXJlLiBJZiB5b3UgdXNlIHRoaXMgc29mdHdhcmVcclxuICogaW4gYSBwcm9kdWN0LCBhbiBhY2tub3dsZWRnbWVudCBpbiB0aGUgcHJvZHVjdCBkb2N1bWVudGF0aW9uIHdvdWxkIGJlXHJcbiAqIGFwcHJlY2lhdGVkIGJ1dCBpcyBub3QgcmVxdWlyZWQuXHJcbiAqIDIuIEFsdGVyZWQgc291cmNlIHZlcnNpb25zIG11c3QgYmUgcGxhaW5seSBtYXJrZWQgYXMgc3VjaCwgYW5kIG11c3Qgbm90IGJlXHJcbiAqIG1pc3JlcHJlc2VudGVkIGFzIGJlaW5nIHRoZSBvcmlnaW5hbCBzb2Z0d2FyZS5cclxuICogMy4gVGhpcyBub3RpY2UgbWF5IG5vdCBiZSByZW1vdmVkIG9yIGFsdGVyZWQgZnJvbSBhbnkgc291cmNlIGRpc3RyaWJ1dGlvbi5cclxuICovXHJcblxyXG5pbXBvcnQgeyBiMkFzc2VydCB9IGZyb20gJy4uL2NvbW1vbi9iMlNldHRpbmdzJztcclxuaW1wb3J0IHsgYjJCcm9hZFBoYXNlIH0gZnJvbSAnLi4vY29sbGlzaW9uL2IyQnJvYWRQaGFzZSc7XHJcbmltcG9ydCB7IGIyVHJlZU5vZGUgfSBmcm9tICcuLi9jb2xsaXNpb24vYjJEeW5hbWljVHJlZSc7XHJcbmltcG9ydCB7IGIyVGVzdE92ZXJsYXBBQUJCIH0gZnJvbSAnLi4vY29sbGlzaW9uL2IyQ29sbGlzaW9uJztcclxuaW1wb3J0IHsgYjJDb250YWN0LCBiMkNvbnRhY3RFZGdlIH0gZnJvbSAnLi9jb250YWN0cy9iMkNvbnRhY3QnO1xyXG5pbXBvcnQgeyBiMkNvbnRhY3RGYWN0b3J5IH0gZnJvbSAnLi9jb250YWN0cy9iMkNvbnRhY3RGYWN0b3J5JztcclxuaW1wb3J0IHsgYjJCb2R5LCBiMkJvZHlUeXBlIH0gZnJvbSAnLi9iMkJvZHknO1xyXG5pbXBvcnQgeyBiMkZpeHR1cmUsIGIyRml4dHVyZVByb3h5IH0gZnJvbSAnLi9iMkZpeHR1cmUnO1xyXG5pbXBvcnQgeyBiMkNvbnRhY3RGaWx0ZXIsIGIyQ29udGFjdExpc3RlbmVyIH0gZnJvbSAnLi9iMldvcmxkQ2FsbGJhY2tzJztcclxuXHJcbi8vIERlbGVnYXRlIG9mIGIyV29ybGQuXHJcbmV4cG9ydCBjbGFzcyBiMkNvbnRhY3RNYW5hZ2VyIHtcclxuICByZWFkb25seSBtX2Jyb2FkUGhhc2U6IGIyQnJvYWRQaGFzZTxiMkZpeHR1cmVQcm94eT4gPSBuZXcgYjJCcm9hZFBoYXNlPGIyRml4dHVyZVByb3h5PigpO1xyXG4gIG1fY29udGFjdExpc3Q6IGIyQ29udGFjdCB8IG51bGwgPSBudWxsO1xyXG4gIG1fY29udGFjdENvdW50ID0gMDtcclxuICBtX2NvbnRhY3RGaWx0ZXI6IGIyQ29udGFjdEZpbHRlciA9IGIyQ29udGFjdEZpbHRlci5iMl9kZWZhdWx0RmlsdGVyO1xyXG4gIG1fY29udGFjdExpc3RlbmVyOiBiMkNvbnRhY3RMaXN0ZW5lciA9IGIyQ29udGFjdExpc3RlbmVyLmIyX2RlZmF1bHRMaXN0ZW5lcjtcclxuXHJcbiAgcmVhZG9ubHkgbV9jb250YWN0RmFjdG9yeTogYjJDb250YWN0RmFjdG9yeSA9IG5ldyBiMkNvbnRhY3RGYWN0b3J5KCk7XHJcblxyXG4gIC8vIEJyb2FkLXBoYXNlIGNhbGxiYWNrLlxyXG4gIEFkZFBhaXIocHJveHlBOiBiMkZpeHR1cmVQcm94eSwgcHJveHlCOiBiMkZpeHR1cmVQcm94eSk6IHZvaWQge1xyXG4gICAgISFCMl9ERUJVRyAmJiBiMkFzc2VydChwcm94eUEgaW5zdGFuY2VvZiBiMkZpeHR1cmVQcm94eSk7XHJcbiAgICAhIUIyX0RFQlVHICYmIGIyQXNzZXJ0KHByb3h5QiBpbnN0YW5jZW9mIGIyRml4dHVyZVByb3h5KTtcclxuXHJcbiAgICBsZXQgZml4dHVyZUEgPSBwcm94eUEuZml4dHVyZTtcclxuICAgIGxldCBmaXh0dXJlQiA9IHByb3h5Qi5maXh0dXJlO1xyXG5cclxuICAgIGNvbnN0IGluZGV4QSA9IHByb3h5QS5jaGlsZEluZGV4O1xyXG4gICAgY29uc3QgaW5kZXhCID0gcHJveHlCLmNoaWxkSW5kZXg7XHJcblxyXG4gICAgbGV0IGJvZHlBID0gZml4dHVyZUEuR2V0Qm9keSgpO1xyXG4gICAgbGV0IGJvZHlCID0gZml4dHVyZUIuR2V0Qm9keSgpO1xyXG5cclxuICAgIC8vIEFyZSB0aGUgZml4dHVyZXMgb24gdGhlIHNhbWUgYm9keT9cclxuICAgIGlmIChib2R5QSA9PT0gYm9keUIpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFRPRE9fRVJJTiB1c2UgYSBoYXNoIHRhYmxlIHRvIHJlbW92ZSBhIHBvdGVudGlhbCBib3R0bGVuZWNrIHdoZW4gYm90aFxyXG4gICAgLy8gYm9kaWVzIGhhdmUgYSBsb3Qgb2YgY29udGFjdHMuXHJcbiAgICAvLyBEb2VzIGEgY29udGFjdCBhbHJlYWR5IGV4aXN0P1xyXG4gICAgbGV0IGVkZ2U6IGIyQ29udGFjdEVkZ2UgfCBudWxsID0gYm9keUIuR2V0Q29udGFjdExpc3QoKTtcclxuICAgIHdoaWxlIChlZGdlICE9PSBudWxsKSB7XHJcbiAgICAgIGlmIChlZGdlLm90aGVyID09PSBib2R5QSkge1xyXG4gICAgICAgIGNvbnN0IGZBID0gZWRnZS5jb250YWN0LkdldEZpeHR1cmVBKCk7XHJcbiAgICAgICAgY29uc3QgZkIgPSBlZGdlLmNvbnRhY3QuR2V0Rml4dHVyZUIoKTtcclxuICAgICAgICBjb25zdCBpQSA9IGVkZ2UuY29udGFjdC5HZXRDaGlsZEluZGV4QSgpO1xyXG4gICAgICAgIGNvbnN0IGlCID0gZWRnZS5jb250YWN0LkdldENoaWxkSW5kZXhCKCk7XHJcblxyXG4gICAgICAgIGlmIChmQSA9PT0gZml4dHVyZUEgJiYgZkIgPT09IGZpeHR1cmVCICYmIGlBID09PSBpbmRleEEgJiYgaUIgPT09IGluZGV4Qikge1xyXG4gICAgICAgICAgLy8gQSBjb250YWN0IGFscmVhZHkgZXhpc3RzLlxyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGZBID09PSBmaXh0dXJlQiAmJiBmQiA9PT0gZml4dHVyZUEgJiYgaUEgPT09IGluZGV4QiAmJiBpQiA9PT0gaW5kZXhBKSB7XHJcbiAgICAgICAgICAvLyBBIGNvbnRhY3QgYWxyZWFkeSBleGlzdHMuXHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBlZGdlID0gZWRnZS5uZXh0O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIERvZXMgYSBqb2ludCBvdmVycmlkZSBjb2xsaXNpb24/IElzIGF0IGxlYXN0IG9uZSBib2R5IGR5bmFtaWM/XHJcbiAgICBpZiAoIWJvZHlCLlNob3VsZENvbGxpZGUoYm9keUEpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBDaGVjayB1c2VyIGZpbHRlcmluZy5cclxuICAgIGlmICh0aGlzLm1fY29udGFjdEZpbHRlciAmJiAhdGhpcy5tX2NvbnRhY3RGaWx0ZXIuU2hvdWxkQ29sbGlkZShmaXh0dXJlQSwgZml4dHVyZUIpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBDYWxsIHRoZSBmYWN0b3J5LlxyXG4gICAgY29uc3QgYzogYjJDb250YWN0IHwgbnVsbCA9IHRoaXMubV9jb250YWN0RmFjdG9yeS5DcmVhdGUoZml4dHVyZUEsIGluZGV4QSwgZml4dHVyZUIsIGluZGV4Qik7XHJcbiAgICBpZiAoYyA9PT0gbnVsbCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ29udGFjdCBjcmVhdGlvbiBtYXkgc3dhcCBmaXh0dXJlcy5cclxuICAgIGZpeHR1cmVBID0gYy5HZXRGaXh0dXJlQSgpO1xyXG4gICAgZml4dHVyZUIgPSBjLkdldEZpeHR1cmVCKCk7XHJcbiAgICAvL2luZGV4QSA9IGMuR2V0Q2hpbGRJbmRleEEoKTtcclxuICAgIC8vaW5kZXhCID0gYy5HZXRDaGlsZEluZGV4QigpO1xyXG4gICAgYm9keUEgPSBmaXh0dXJlQS5tX2JvZHk7XHJcbiAgICBib2R5QiA9IGZpeHR1cmVCLm1fYm9keTtcclxuXHJcbiAgICAvLyBJbnNlcnQgaW50byB0aGUgd29ybGQuXHJcbiAgICBjLm1fcHJldiA9IG51bGw7XHJcbiAgICBjLm1fbmV4dCA9IHRoaXMubV9jb250YWN0TGlzdDtcclxuICAgIGlmICh0aGlzLm1fY29udGFjdExpc3QgIT09IG51bGwpIHtcclxuICAgICAgdGhpcy5tX2NvbnRhY3RMaXN0Lm1fcHJldiA9IGM7XHJcbiAgICB9XHJcbiAgICB0aGlzLm1fY29udGFjdExpc3QgPSBjO1xyXG5cclxuICAgIC8vIENvbm5lY3QgdG8gaXNsYW5kIGdyYXBoLlxyXG5cclxuICAgIC8vIENvbm5lY3QgdG8gYm9keSBBXHJcbiAgICBjLm1fbm9kZUEub3RoZXIgPSBib2R5QjtcclxuXHJcbiAgICBjLm1fbm9kZUEucHJldiA9IG51bGw7XHJcbiAgICBjLm1fbm9kZUEubmV4dCA9IGJvZHlBLm1fY29udGFjdExpc3Q7XHJcbiAgICBpZiAoYm9keUEubV9jb250YWN0TGlzdCAhPT0gbnVsbCkge1xyXG4gICAgICBib2R5QS5tX2NvbnRhY3RMaXN0LnByZXYgPSBjLm1fbm9kZUE7XHJcbiAgICB9XHJcbiAgICBib2R5QS5tX2NvbnRhY3RMaXN0ID0gYy5tX25vZGVBO1xyXG5cclxuICAgIC8vIENvbm5lY3QgdG8gYm9keSBCXHJcbiAgICBjLm1fbm9kZUIub3RoZXIgPSBib2R5QTtcclxuXHJcbiAgICBjLm1fbm9kZUIucHJldiA9IG51bGw7XHJcbiAgICBjLm1fbm9kZUIubmV4dCA9IGJvZHlCLm1fY29udGFjdExpc3Q7XHJcbiAgICBpZiAoYm9keUIubV9jb250YWN0TGlzdCAhPT0gbnVsbCkge1xyXG4gICAgICBib2R5Qi5tX2NvbnRhY3RMaXN0LnByZXYgPSBjLm1fbm9kZUI7XHJcbiAgICB9XHJcbiAgICBib2R5Qi5tX2NvbnRhY3RMaXN0ID0gYy5tX25vZGVCO1xyXG5cclxuICAgIC8vIFdha2UgdXAgdGhlIGJvZGllc1xyXG4gICAgaWYgKCFmaXh0dXJlQS5Jc1NlbnNvcigpICYmICFmaXh0dXJlQi5Jc1NlbnNvcigpKSB7XHJcbiAgICAgIGJvZHlBLlNldEF3YWtlKHRydWUpO1xyXG4gICAgICBib2R5Qi5TZXRBd2FrZSh0cnVlKTtcclxuICAgIH1cclxuXHJcbiAgICArK3RoaXMubV9jb250YWN0Q291bnQ7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgc191cGRhdGVQYWlyc19wcm94eUE6IGIyRml4dHVyZVByb3h5W10gPSBbXTtcclxuICBzdGF0aWMgc191cGRhdGVQYWlyc19wcm94eUI6IGIyRml4dHVyZVByb3h5W10gPSBbXTtcclxuXHJcbiAgRmluZE5ld0NvbnRhY3RzKCk6IHZvaWQge1xyXG4gICAgY29uc3QgbGlzdEEgPSBiMkNvbnRhY3RNYW5hZ2VyLnNfdXBkYXRlUGFpcnNfcHJveHlBO1xyXG4gICAgY29uc3QgbGlzdEIgPSBiMkNvbnRhY3RNYW5hZ2VyLnNfdXBkYXRlUGFpcnNfcHJveHlCO1xyXG4gICAgbGlzdEEubGVuZ3RoID0gMDtcclxuICAgIGxpc3RCLmxlbmd0aCA9IDA7XHJcbiAgICB0aGlzLm1fYnJvYWRQaGFzZS5VcGRhdGVQYWlyc18obGlzdEEsIGxpc3RCKTtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3RBLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgIHRoaXMuQWRkUGFpcihsaXN0QVtpXSwgbGlzdEJbaV0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgRGVzdHJveShjOiBiMkNvbnRhY3QpOiB2b2lkIHtcclxuICAgIGNvbnN0IGZpeHR1cmVBOiBiMkZpeHR1cmUgPSBjLkdldEZpeHR1cmVBKCk7XHJcbiAgICBjb25zdCBmaXh0dXJlQjogYjJGaXh0dXJlID0gYy5HZXRGaXh0dXJlQigpO1xyXG4gICAgY29uc3QgYm9keUE6IGIyQm9keSA9IGZpeHR1cmVBLkdldEJvZHkoKTtcclxuICAgIGNvbnN0IGJvZHlCOiBiMkJvZHkgPSBmaXh0dXJlQi5HZXRCb2R5KCk7XHJcblxyXG4gICAgaWYgKHRoaXMubV9jb250YWN0TGlzdGVuZXIgJiYgYy5Jc1RvdWNoaW5nKCkpIHtcclxuICAgICAgdGhpcy5tX2NvbnRhY3RMaXN0ZW5lci5FbmRDb250YWN0KGMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFJlbW92ZSBmcm9tIHRoZSB3b3JsZC5cclxuICAgIGlmIChjLm1fcHJldikge1xyXG4gICAgICBjLm1fcHJldi5tX25leHQgPSBjLm1fbmV4dDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoYy5tX25leHQpIHtcclxuICAgICAgYy5tX25leHQubV9wcmV2ID0gYy5tX3ByZXY7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGMgPT09IHRoaXMubV9jb250YWN0TGlzdCkge1xyXG4gICAgICB0aGlzLm1fY29udGFjdExpc3QgPSBjLm1fbmV4dDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBSZW1vdmUgZnJvbSBib2R5IDFcclxuICAgIGlmIChjLm1fbm9kZUEucHJldikge1xyXG4gICAgICBjLm1fbm9kZUEucHJldi5uZXh0ID0gYy5tX25vZGVBLm5leHQ7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGMubV9ub2RlQS5uZXh0KSB7XHJcbiAgICAgIGMubV9ub2RlQS5uZXh0LnByZXYgPSBjLm1fbm9kZUEucHJldjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoYy5tX25vZGVBID09PSBib2R5QS5tX2NvbnRhY3RMaXN0KSB7XHJcbiAgICAgIGJvZHlBLm1fY29udGFjdExpc3QgPSBjLm1fbm9kZUEubmV4dDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBSZW1vdmUgZnJvbSBib2R5IDJcclxuICAgIGlmIChjLm1fbm9kZUIucHJldikge1xyXG4gICAgICBjLm1fbm9kZUIucHJldi5uZXh0ID0gYy5tX25vZGVCLm5leHQ7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGMubV9ub2RlQi5uZXh0KSB7XHJcbiAgICAgIGMubV9ub2RlQi5uZXh0LnByZXYgPSBjLm1fbm9kZUIucHJldjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoYy5tX25vZGVCID09PSBib2R5Qi5tX2NvbnRhY3RMaXN0KSB7XHJcbiAgICAgIGJvZHlCLm1fY29udGFjdExpc3QgPSBjLm1fbm9kZUIubmV4dDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBtb3ZlZCB0aGlzIGZyb20gYjJDb250YWN0RmFjdG9yeTpEZXN0cm95XHJcbiAgICBpZiAoYy5tX21hbmlmb2xkLnBvaW50Q291bnQgPiAwICYmICFmaXh0dXJlQS5Jc1NlbnNvcigpICYmICFmaXh0dXJlQi5Jc1NlbnNvcigpKSB7XHJcbiAgICAgIGZpeHR1cmVBLkdldEJvZHkoKS5TZXRBd2FrZSh0cnVlKTtcclxuICAgICAgZml4dHVyZUIuR2V0Qm9keSgpLlNldEF3YWtlKHRydWUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENhbGwgdGhlIGZhY3RvcnkuXHJcbiAgICB0aGlzLm1fY29udGFjdEZhY3RvcnkuRGVzdHJveShjKTtcclxuICAgIC0tdGhpcy5tX2NvbnRhY3RDb3VudDtcclxuICB9XHJcblxyXG4gIC8vIFRoaXMgaXMgdGhlIHRvcCBsZXZlbCBjb2xsaXNpb24gY2FsbCBmb3IgdGhlIHRpbWUgc3RlcC4gSGVyZVxyXG4gIC8vIGFsbCB0aGUgbmFycm93IHBoYXNlIGNvbGxpc2lvbiBpcyBwcm9jZXNzZWQgZm9yIHRoZSB3b3JsZFxyXG4gIC8vIGNvbnRhY3QgbGlzdC5cclxuICBDb2xsaWRlKCk6IHZvaWQge1xyXG4gICAgLy8gVXBkYXRlIGF3YWtlIGNvbnRhY3RzLlxyXG4gICAgbGV0IGM6IGIyQ29udGFjdCB8IG51bGwgPSB0aGlzLm1fY29udGFjdExpc3Q7XHJcbiAgICB3aGlsZSAoYykge1xyXG4gICAgICBjb25zdCBmaXh0dXJlQTogYjJGaXh0dXJlID0gYy5HZXRGaXh0dXJlQSgpO1xyXG4gICAgICBjb25zdCBmaXh0dXJlQjogYjJGaXh0dXJlID0gYy5HZXRGaXh0dXJlQigpO1xyXG4gICAgICBjb25zdCBpbmRleEE6IG51bWJlciA9IGMuR2V0Q2hpbGRJbmRleEEoKTtcclxuICAgICAgY29uc3QgaW5kZXhCOiBudW1iZXIgPSBjLkdldENoaWxkSW5kZXhCKCk7XHJcbiAgICAgIGNvbnN0IGJvZHlBOiBiMkJvZHkgPSBmaXh0dXJlQS5HZXRCb2R5KCk7XHJcbiAgICAgIGNvbnN0IGJvZHlCOiBiMkJvZHkgPSBmaXh0dXJlQi5HZXRCb2R5KCk7XHJcblxyXG4gICAgICAvLyBJcyB0aGlzIGNvbnRhY3QgZmxhZ2dlZCBmb3IgZmlsdGVyaW5nP1xyXG4gICAgICBpZiAoYy5tX2ZpbHRlckZsYWcpIHtcclxuICAgICAgICAvLyBDaGVjayB1c2VyIGZpbHRlcmluZy5cclxuICAgICAgICBpZiAodGhpcy5tX2NvbnRhY3RGaWx0ZXIgJiYgIXRoaXMubV9jb250YWN0RmlsdGVyLlNob3VsZENvbGxpZGUoZml4dHVyZUEsIGZpeHR1cmVCKSkge1xyXG4gICAgICAgICAgY29uc3QgY051a2U6IGIyQ29udGFjdCA9IGM7XHJcbiAgICAgICAgICBjID0gY051a2UubV9uZXh0O1xyXG4gICAgICAgICAgdGhpcy5EZXN0cm95KGNOdWtlKTtcclxuICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQ2xlYXIgdGhlIGZpbHRlcmluZyBmbGFnLlxyXG4gICAgICAgIGMubV9maWx0ZXJGbGFnID0gZmFsc2U7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGFjdGl2ZUE6IGJvb2xlYW4gPSBib2R5QS5Jc0F3YWtlKCkgJiYgYm9keUEubV90eXBlICE9PSBiMkJvZHlUeXBlLmIyX3N0YXRpY0JvZHk7XHJcbiAgICAgIGNvbnN0IGFjdGl2ZUI6IGJvb2xlYW4gPSBib2R5Qi5Jc0F3YWtlKCkgJiYgYm9keUIubV90eXBlICE9PSBiMkJvZHlUeXBlLmIyX3N0YXRpY0JvZHk7XHJcblxyXG4gICAgICAvLyBBdCBsZWFzdCBvbmUgYm9keSBtdXN0IGJlIGF3YWtlIGFuZCBpdCBtdXN0IGJlIGR5bmFtaWMgb3Iga2luZW1hdGljLlxyXG4gICAgICBpZiAoIWFjdGl2ZUEgJiYgIWFjdGl2ZUIpIHtcclxuICAgICAgICBjID0gYy5tX25leHQ7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHRyZWVOb2RlQTogYjJUcmVlTm9kZTxiMkZpeHR1cmVQcm94eT4gPSBmaXh0dXJlQS5tX3Byb3hpZXNbaW5kZXhBXS50cmVlTm9kZTtcclxuICAgICAgY29uc3QgdHJlZU5vZGVCOiBiMlRyZWVOb2RlPGIyRml4dHVyZVByb3h5PiA9IGZpeHR1cmVCLm1fcHJveGllc1tpbmRleEJdLnRyZWVOb2RlO1xyXG4gICAgICBjb25zdCBvdmVybGFwOiBib29sZWFuID0gYjJUZXN0T3ZlcmxhcEFBQkIodHJlZU5vZGVBLmFhYmIsIHRyZWVOb2RlQi5hYWJiKTtcclxuXHJcbiAgICAgIC8vIEhlcmUgd2UgZGVzdHJveSBjb250YWN0cyB0aGF0IGNlYXNlIHRvIG92ZXJsYXAgaW4gdGhlIGJyb2FkLXBoYXNlLlxyXG4gICAgICBpZiAoIW92ZXJsYXApIHtcclxuICAgICAgICBjb25zdCBjTnVrZTogYjJDb250YWN0ID0gYztcclxuICAgICAgICBjID0gY051a2UubV9uZXh0O1xyXG4gICAgICAgIHRoaXMuRGVzdHJveShjTnVrZSk7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFRoZSBjb250YWN0IHBlcnNpc3RzLlxyXG4gICAgICBjLlVwZGF0ZSh0aGlzLm1fY29udGFjdExpc3RlbmVyKTtcclxuICAgICAgYyA9IGMubV9uZXh0O1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=