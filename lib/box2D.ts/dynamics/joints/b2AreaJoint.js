import { b2_epsilon, b2_linearSlop, b2_maxLinearCorrection, b2Assert, b2MakeNumberArray, b2Maybe, } from '../../common/b2Settings';
import { b2Sq, b2Sqrt, b2Vec2 } from '../../common/b2Math';
import { b2Joint, b2JointDef } from './b2Joint';
import { b2DistanceJointDef } from './b2DistanceJoint';
export class b2AreaJointDef extends b2JointDef {
    constructor() {
        super(12 /* e_areaJoint */);
        this.bodies = [];
        this.frequencyHz = 0;
        this.dampingRatio = 0;
    }
    AddBody(body) {
        this.bodies.push(body);
        if (this.bodies.length === 1) {
            this.bodyA = body;
        }
        else if (this.bodies.length === 2) {
            this.bodyB = body;
        }
    }
}
export class b2AreaJoint extends b2Joint {
    constructor(def) {
        super(def);
        this.m_frequencyHz = 0;
        this.m_dampingRatio = 0;
        // Solver shared
        this.m_impulse = 0;
        this.m_targetArea = 0;
        this.m_delta = new b2Vec2();
        !!B2_DEBUG &&
            b2Assert(def.bodies.length >= 3, 'You cannot create an area joint with less than three bodies.');
        this.m_bodies = def.bodies;
        this.m_frequencyHz = b2Maybe(def.frequencyHz, 0);
        this.m_dampingRatio = b2Maybe(def.dampingRatio, 0);
        this.m_targetLengths = b2MakeNumberArray(def.bodies.length);
        this.m_normals = b2Vec2.MakeArray(def.bodies.length);
        this.m_joints = []; // b2MakeNullArray(def.bodies.length);
        this.m_deltas = b2Vec2.MakeArray(def.bodies.length);
        const djd = new b2DistanceJointDef();
        djd.frequencyHz = this.m_frequencyHz;
        djd.dampingRatio = this.m_dampingRatio;
        this.m_targetArea = 0;
        for (let i = 0; i < this.m_bodies.length; ++i) {
            const body = this.m_bodies[i];
            const next = this.m_bodies[(i + 1) % this.m_bodies.length];
            const body_c = body.GetWorldCenter();
            const next_c = next.GetWorldCenter();
            this.m_targetLengths[i] = b2Vec2.DistanceVV(body_c, next_c);
            this.m_targetArea += b2Vec2.CrossVV(body_c, next_c);
            djd.Initialize(body, next, body_c, next_c);
            this.m_joints[i] = body.GetWorld().CreateJoint(djd);
        }
        this.m_targetArea *= 0.5;
    }
    GetAnchorA(out) {
        return out;
    }
    GetAnchorB(out) {
        return out;
    }
    GetReactionForce(inv_dt, out) {
        return out;
    }
    GetReactionTorque(inv_dt) {
        return 0;
    }
    SetFrequency(hz) {
        this.m_frequencyHz = hz;
        for (let i = 0; i < this.m_joints.length; ++i) {
            this.m_joints[i].SetFrequency(hz);
        }
    }
    GetFrequency() {
        return this.m_frequencyHz;
    }
    SetDampingRatio(ratio) {
        this.m_dampingRatio = ratio;
        for (let i = 0; i < this.m_joints.length; ++i) {
            this.m_joints[i].SetDampingRatio(ratio);
        }
    }
    GetDampingRatio() {
        return this.m_dampingRatio;
    }
    InitVelocityConstraints(data) {
        for (let i = 0; i < this.m_bodies.length; ++i) {
            const prev = this.m_bodies[(i + this.m_bodies.length - 1) % this.m_bodies.length];
            const next = this.m_bodies[(i + 1) % this.m_bodies.length];
            const prev_c = data.positions[prev.m_islandIndex].c;
            const next_c = data.positions[next.m_islandIndex].c;
            const delta = this.m_deltas[i];
            b2Vec2.SubVV(next_c, prev_c, delta);
        }
        if (data.step.warmStarting) {
            this.m_impulse *= data.step.dtRatio;
            for (let i = 0; i < this.m_bodies.length; ++i) {
                const body = this.m_bodies[i];
                const body_v = data.velocities[body.m_islandIndex].v;
                const delta = this.m_deltas[i];
                body_v.x += body.m_invMass * delta.y * 0.5 * this.m_impulse;
                body_v.y += body.m_invMass * -delta.x * 0.5 * this.m_impulse;
            }
        }
        else {
            this.m_impulse = 0;
        }
    }
    SolveVelocityConstraints(data) {
        let dotMassSum = 0;
        let crossMassSum = 0;
        for (let i = 0; i < this.m_bodies.length; ++i) {
            const body = this.m_bodies[i];
            const body_v = data.velocities[body.m_islandIndex].v;
            const delta = this.m_deltas[i];
            dotMassSum += delta.LengthSquared() / body.GetMass();
            crossMassSum += b2Vec2.CrossVV(body_v, delta);
        }
        const lambda = (-2 * crossMassSum) / dotMassSum;
        // lambda = b2Clamp(lambda, -b2_maxLinearCorrection, b2_maxLinearCorrection);
        this.m_impulse += lambda;
        for (let i = 0; i < this.m_bodies.length; ++i) {
            const body = this.m_bodies[i];
            const body_v = data.velocities[body.m_islandIndex].v;
            const delta = this.m_deltas[i];
            body_v.x += body.m_invMass * delta.y * 0.5 * lambda;
            body_v.y += body.m_invMass * -delta.x * 0.5 * lambda;
        }
    }
    SolvePositionConstraints(data) {
        let perimeter = 0;
        let area = 0;
        for (let i = 0; i < this.m_bodies.length; ++i) {
            const body = this.m_bodies[i];
            const next = this.m_bodies[(i + 1) % this.m_bodies.length];
            const body_c = data.positions[body.m_islandIndex].c;
            const next_c = data.positions[next.m_islandIndex].c;
            const delta = b2Vec2.SubVV(next_c, body_c, this.m_delta);
            let dist = delta.Length();
            if (dist < b2_epsilon) {
                dist = 1;
            }
            this.m_normals[i].x = delta.y / dist;
            this.m_normals[i].y = -delta.x / dist;
            perimeter += dist;
            area += b2Vec2.CrossVV(body_c, next_c);
        }
        area *= 0.5;
        const deltaArea = this.m_targetArea - area;
        const toExtrude = (0.5 * deltaArea) / perimeter;
        let done = true;
        for (let i = 0; i < this.m_bodies.length; ++i) {
            const body = this.m_bodies[i];
            const body_c = data.positions[body.m_islandIndex].c;
            const next_i = (i + 1) % this.m_bodies.length;
            const delta = b2Vec2.AddVV(this.m_normals[i], this.m_normals[next_i], this.m_delta);
            delta.SelfMul(toExtrude);
            const norm_sq = delta.LengthSquared();
            if (norm_sq > b2Sq(b2_maxLinearCorrection)) {
                delta.SelfMul(b2_maxLinearCorrection / b2Sqrt(norm_sq));
            }
            if (norm_sq > b2Sq(b2_linearSlop)) {
                done = false;
            }
            body_c.x += delta.x;
            body_c.y += delta.y;
        }
        return done;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYjJBcmVhSm9pbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvZHluYW1pY3Mvam9pbnRzL2IyQXJlYUpvaW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxVQUFVLEVBQ1YsYUFBYSxFQUNiLHNCQUFzQixFQUN0QixRQUFRLEVBQ1IsaUJBQWlCLEVBQ2pCLE9BQU8sR0FDUixNQUFNLHlCQUF5QixDQUFDO0FBQ2pDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBTSxNQUFNLHFCQUFxQixDQUFDO0FBQy9ELE9BQU8sRUFBZSxPQUFPLEVBQUUsVUFBVSxFQUFlLE1BQU0sV0FBVyxDQUFDO0FBQzFFLE9BQU8sRUFBbUIsa0JBQWtCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQWN4RSxNQUFNLE9BQU8sY0FBZSxTQUFRLFVBQVU7SUFPNUM7UUFDRSxLQUFLLHNCQUF5QixDQUFDO1FBUGpDLFdBQU0sR0FBYSxFQUFFLENBQUM7UUFFdEIsZ0JBQVcsR0FBRyxDQUFDLENBQUM7UUFFaEIsaUJBQVksR0FBRyxDQUFDLENBQUM7SUFJakIsQ0FBQztJQUVELE9BQU8sQ0FBQyxJQUFZO1FBQ2xCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXZCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzVCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1NBQ25CO2FBQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDbkMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7U0FDbkI7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLE9BQU8sV0FBWSxTQUFRLE9BQU87SUFnQnRDLFlBQVksR0FBb0I7UUFDOUIsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBZmIs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QUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRXpCLE1BQU0sT0FBTyxHQUFXLEtBQUssQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUM5QyxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsRUFBRTtnQkFDMUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQzthQUN6RDtZQUNELElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRTtnQkFDakMsSUFBSSxHQUFHLEtBQUssQ0FBQzthQUNkO1lBRUQsTUFBTSxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQztTQUNyQjtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBiMl9lcHNpbG9uLFxyXG4gIGIyX2xpbmVhclNsb3AsXHJcbiAgYjJfbWF4TGluZWFyQ29ycmVjdGlvbixcclxuICBiMkFzc2VydCxcclxuICBiMk1ha2VOdW1iZXJBcnJheSxcclxuICBiMk1heWJlLFxyXG59IGZyb20gJy4uLy4uL2NvbW1vbi9iMlNldHRpbmdzJztcclxuaW1wb3J0IHsgYjJTcSwgYjJTcXJ0LCBiMlZlYzIsIFhZIH0gZnJvbSAnLi4vLi4vY29tbW9uL2IyTWF0aCc7XHJcbmltcG9ydCB7IGIySUpvaW50RGVmLCBiMkpvaW50LCBiMkpvaW50RGVmLCBiMkpvaW50VHlwZSB9IGZyb20gJy4vYjJKb2ludCc7XHJcbmltcG9ydCB7IGIyRGlzdGFuY2VKb2ludCwgYjJEaXN0YW5jZUpvaW50RGVmIH0gZnJvbSAnLi9iMkRpc3RhbmNlSm9pbnQnO1xyXG5pbXBvcnQgeyBiMlNvbHZlckRhdGEgfSBmcm9tICcuLi9iMlRpbWVTdGVwJztcclxuaW1wb3J0IHsgYjJCb2R5IH0gZnJvbSAnLi4vYjJCb2R5JztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgYjJJQXJlYUpvaW50RGVmIGV4dGVuZHMgYjJJSm9pbnREZWYge1xyXG4gIC8vIHdvcmxkOiBiMldvcmxkO1xyXG5cclxuICBib2RpZXM6IGIyQm9keVtdO1xyXG5cclxuICBmcmVxdWVuY3lIej86IG51bWJlcjtcclxuXHJcbiAgZGFtcGluZ1JhdGlvPzogbnVtYmVyO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgYjJBcmVhSm9pbnREZWYgZXh0ZW5kcyBiMkpvaW50RGVmIGltcGxlbWVudHMgYjJJQXJlYUpvaW50RGVmIHtcclxuICBib2RpZXM6IGIyQm9keVtdID0gW107XHJcblxyXG4gIGZyZXF1ZW5jeUh6ID0gMDtcclxuXHJcbiAgZGFtcGluZ1JhdGlvID0gMDtcclxuXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICBzdXBlcihiMkpvaW50VHlwZS5lX2FyZWFKb2ludCk7XHJcbiAgfVxyXG5cclxuICBBZGRCb2R5KGJvZHk6IGIyQm9keSk6IHZvaWQge1xyXG4gICAgdGhpcy5ib2RpZXMucHVzaChib2R5KTtcclxuXHJcbiAgICBpZiAodGhpcy5ib2RpZXMubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgIHRoaXMuYm9keUEgPSBib2R5O1xyXG4gICAgfSBlbHNlIGlmICh0aGlzLmJvZGllcy5sZW5ndGggPT09IDIpIHtcclxuICAgICAgdGhpcy5ib2R5QiA9IGJvZHk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgYjJBcmVhSm9pbnQgZXh0ZW5kcyBiMkpvaW50IHtcclxuICBtX2JvZGllczogYjJCb2R5W107XHJcbiAgbV9mcmVxdWVuY3lIeiA9IDA7XHJcbiAgbV9kYW1waW5nUmF0aW8gPSAwO1xyXG5cclxuICAvLyBTb2x2ZXIgc2hhcmVkXHJcbiAgbV9pbXB1bHNlID0gMDtcclxuXHJcbiAgLy8gU29sdmVyIHRlbXBcclxuICByZWFkb25seSBtX3RhcmdldExlbmd0aHM6IG51bWJlcltdO1xyXG4gIG1fdGFyZ2V0QXJlYSA9IDA7XHJcbiAgcmVhZG9ubHkgbV9ub3JtYWxzOiBiMlZlYzJbXTtcclxuICByZWFkb25seSBtX2pvaW50czogYjJEaXN0YW5jZUpvaW50W107XHJcbiAgcmVhZG9ubHkgbV9kZWx0YXM6IGIyVmVjMltdO1xyXG4gIHJlYWRvbmx5IG1fZGVsdGE6IGIyVmVjMiA9IG5ldyBiMlZlYzIoKTtcclxuXHJcbiAgY29uc3RydWN0b3IoZGVmOiBiMklBcmVhSm9pbnREZWYpIHtcclxuICAgIHN1cGVyKGRlZik7XHJcblxyXG4gICAgISFCMl9ERUJVRyAmJlxyXG4gICAgICBiMkFzc2VydChcclxuICAgICAgICBkZWYuYm9kaWVzLmxlbmd0aCA+PSAzLFxyXG4gICAgICAgICdZb3UgY2Fubm90IGNyZWF0ZSBhbiBhcmVhIGpvaW50IHdpdGggbGVzcyB0aGFuIHRocmVlIGJvZGllcy4nLFxyXG4gICAgICApO1xyXG5cclxuICAgIHRoaXMubV9ib2RpZXMgPSBkZWYuYm9kaWVzO1xyXG4gICAgdGhpcy5tX2ZyZXF1ZW5jeUh6ID0gYjJNYXliZShkZWYuZnJlcXVlbmN5SHosIDApO1xyXG4gICAgdGhpcy5tX2RhbXBpbmdSYXRpbyA9IGIyTWF5YmUoZGVmLmRhbXBpbmdSYXRpbywgMCk7XHJcblxyXG4gICAgdGhpcy5tX3RhcmdldExlbmd0aHMgPSBiMk1ha2VOdW1iZXJBcnJheShkZWYuYm9kaWVzLmxlbmd0aCk7XHJcbiAgICB0aGlzLm1fbm9ybWFscyA9IGIyVmVjMi5NYWtlQXJyYXkoZGVmLmJvZGllcy5sZW5ndGgpO1xyXG4gICAgdGhpcy5tX2pvaW50cyA9IFtdOyAvLyBiMk1ha2VOdWxsQXJyYXkoZGVmLmJvZGllcy5sZW5ndGgpO1xyXG4gICAgdGhpcy5tX2RlbHRhcyA9IGIyVmVjMi5NYWtlQXJyYXkoZGVmLmJvZGllcy5sZW5ndGgpO1xyXG5cclxuICAgIGNvbnN0IGRqZDogYjJEaXN0YW5jZUpvaW50RGVmID0gbmV3IGIyRGlzdGFuY2VKb2ludERlZigpO1xyXG4gICAgZGpkLmZyZXF1ZW5jeUh6ID0gdGhpcy5tX2ZyZXF1ZW5jeUh6O1xyXG4gICAgZGpkLmRhbXBpbmdSYXRpbyA9IHRoaXMubV9kYW1waW5nUmF0aW87XHJcblxyXG4gICAgdGhpcy5tX3RhcmdldEFyZWEgPSAwO1xyXG5cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5tX2JvZGllcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICBjb25zdCBib2R5OiBiMkJvZHkgPSB0aGlzLm1fYm9kaWVzW2ldO1xyXG4gICAgICBjb25zdCBuZXh0OiBiMkJvZHkgPSB0aGlzLm1fYm9kaWVzWyhpICsgMSkgJSB0aGlzLm1fYm9kaWVzLmxlbmd0aF07XHJcblxyXG4gICAgICBjb25zdCBib2R5X2M6IGIyVmVjMiA9IGJvZHkuR2V0V29ybGRDZW50ZXIoKTtcclxuICAgICAgY29uc3QgbmV4dF9jOiBiMlZlYzIgPSBuZXh0LkdldFdvcmxkQ2VudGVyKCk7XHJcblxyXG4gICAgICB0aGlzLm1fdGFyZ2V0TGVuZ3Roc1tpXSA9IGIyVmVjMi5EaXN0YW5jZVZWKGJvZHlfYywgbmV4dF9jKTtcclxuXHJcbiAgICAgIHRoaXMubV90YXJnZXRBcmVhICs9IGIyVmVjMi5Dcm9zc1ZWKGJvZHlfYywgbmV4dF9jKTtcclxuXHJcbiAgICAgIGRqZC5Jbml0aWFsaXplKGJvZHksIG5leHQsIGJvZHlfYywgbmV4dF9jKTtcclxuICAgICAgdGhpcy5tX2pvaW50c1tpXSA9IGJvZHkuR2V0V29ybGQoKS5DcmVhdGVKb2ludChkamQpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMubV90YXJnZXRBcmVhICo9IDAuNTtcclxuICB9XHJcblxyXG4gIEdldEFuY2hvckE8VCBleHRlbmRzIFhZPihvdXQ6IFQpOiBUIHtcclxuICAgIHJldHVybiBvdXQ7XHJcbiAgfVxyXG5cclxuICBHZXRBbmNob3JCPFQgZXh0ZW5kcyBYWT4ob3V0OiBUKTogVCB7XHJcbiAgICByZXR1cm4gb3V0O1xyXG4gIH1cclxuXHJcbiAgR2V0UmVhY3Rpb25Gb3JjZTxUIGV4dGVuZHMgWFk+KGludl9kdDogbnVtYmVyLCBvdXQ6IFQpOiBUIHtcclxuICAgIHJldHVybiBvdXQ7XHJcbiAgfVxyXG5cclxuICBHZXRSZWFjdGlvblRvcnF1ZShpbnZfZHQ6IG51bWJlcik6IG51bWJlciB7XHJcbiAgICByZXR1cm4gMDtcclxuICB9XHJcblxyXG4gIFNldEZyZXF1ZW5jeShoejogbnVtYmVyKTogdm9pZCB7XHJcbiAgICB0aGlzLm1fZnJlcXVlbmN5SHogPSBoejtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubV9qb2ludHMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgdGhpcy5tX2pvaW50c1tpXS5TZXRGcmVxdWVuY3koaHopO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgR2V0RnJlcXVlbmN5KCkge1xyXG4gICAgcmV0dXJuIHRoaXMubV9mcmVxdWVuY3lIejtcclxuICB9XHJcblxyXG4gIFNldERhbXBpbmdSYXRpbyhyYXRpbzogbnVtYmVyKTogdm9pZCB7XHJcbiAgICB0aGlzLm1fZGFtcGluZ1JhdGlvID0gcmF0aW87XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm1fam9pbnRzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgIHRoaXMubV9qb2ludHNbaV0uU2V0RGFtcGluZ1JhdGlvKHJhdGlvKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIEdldERhbXBpbmdSYXRpbygpIHtcclxuICAgIHJldHVybiB0aGlzLm1fZGFtcGluZ1JhdGlvO1xyXG4gIH1cclxuXHJcbiAgSW5pdFZlbG9jaXR5Q29uc3RyYWludHMoZGF0YTogYjJTb2x2ZXJEYXRhKTogdm9pZCB7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubV9ib2RpZXMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgY29uc3QgcHJldjogYjJCb2R5ID0gdGhpcy5tX2JvZGllc1soaSArIHRoaXMubV9ib2RpZXMubGVuZ3RoIC0gMSkgJSB0aGlzLm1fYm9kaWVzLmxlbmd0aF07XHJcbiAgICAgIGNvbnN0IG5leHQ6IGIyQm9keSA9IHRoaXMubV9ib2RpZXNbKGkgKyAxKSAlIHRoaXMubV9ib2RpZXMubGVuZ3RoXTtcclxuICAgICAgY29uc3QgcHJldl9jOiBiMlZlYzIgPSBkYXRhLnBvc2l0aW9uc1twcmV2Lm1faXNsYW5kSW5kZXhdLmM7XHJcbiAgICAgIGNvbnN0IG5leHRfYzogYjJWZWMyID0gZGF0YS5wb3NpdGlvbnNbbmV4dC5tX2lzbGFuZEluZGV4XS5jO1xyXG4gICAgICBjb25zdCBkZWx0YTogYjJWZWMyID0gdGhpcy5tX2RlbHRhc1tpXTtcclxuXHJcbiAgICAgIGIyVmVjMi5TdWJWVihuZXh0X2MsIHByZXZfYywgZGVsdGEpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChkYXRhLnN0ZXAud2FybVN0YXJ0aW5nKSB7XHJcbiAgICAgIHRoaXMubV9pbXB1bHNlICo9IGRhdGEuc3RlcC5kdFJhdGlvO1xyXG5cclxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm1fYm9kaWVzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgY29uc3QgYm9keTogYjJCb2R5ID0gdGhpcy5tX2JvZGllc1tpXTtcclxuICAgICAgICBjb25zdCBib2R5X3Y6IGIyVmVjMiA9IGRhdGEudmVsb2NpdGllc1tib2R5Lm1faXNsYW5kSW5kZXhdLnY7XHJcbiAgICAgICAgY29uc3QgZGVsdGE6IGIyVmVjMiA9IHRoaXMubV9kZWx0YXNbaV07XHJcblxyXG4gICAgICAgIGJvZHlfdi54ICs9IGJvZHkubV9pbnZNYXNzICogZGVsdGEueSAqIDAuNSAqIHRoaXMubV9pbXB1bHNlO1xyXG4gICAgICAgIGJvZHlfdi55ICs9IGJvZHkubV9pbnZNYXNzICogLWRlbHRhLnggKiAwLjUgKiB0aGlzLm1faW1wdWxzZTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5tX2ltcHVsc2UgPSAwO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgU29sdmVWZWxvY2l0eUNvbnN0cmFpbnRzKGRhdGE6IGIyU29sdmVyRGF0YSk6IHZvaWQge1xyXG4gICAgbGV0IGRvdE1hc3NTdW0gPSAwO1xyXG4gICAgbGV0IGNyb3NzTWFzc1N1bSA9IDA7XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm1fYm9kaWVzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgIGNvbnN0IGJvZHk6IGIyQm9keSA9IHRoaXMubV9ib2RpZXNbaV07XHJcbiAgICAgIGNvbnN0IGJvZHlfdjogYjJWZWMyID0gZGF0YS52ZWxvY2l0aWVzW2JvZHkubV9pc2xhbmRJbmRleF0udjtcclxuICAgICAgY29uc3QgZGVsdGE6IGIyVmVjMiA9IHRoaXMubV9kZWx0YXNbaV07XHJcblxyXG4gICAgICBkb3RNYXNzU3VtICs9IGRlbHRhLkxlbmd0aFNxdWFyZWQoKSAvIGJvZHkuR2V0TWFzcygpO1xyXG4gICAgICBjcm9zc01hc3NTdW0gKz0gYjJWZWMyLkNyb3NzVlYoYm9keV92LCBkZWx0YSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbGFtYmRhOiBudW1iZXIgPSAoLTIgKiBjcm9zc01hc3NTdW0pIC8gZG90TWFzc1N1bTtcclxuICAgIC8vIGxhbWJkYSA9IGIyQ2xhbXAobGFtYmRhLCAtYjJfbWF4TGluZWFyQ29ycmVjdGlvbiwgYjJfbWF4TGluZWFyQ29ycmVjdGlvbik7XHJcblxyXG4gICAgdGhpcy5tX2ltcHVsc2UgKz0gbGFtYmRhO1xyXG5cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5tX2JvZGllcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICBjb25zdCBib2R5OiBiMkJvZHkgPSB0aGlzLm1fYm9kaWVzW2ldO1xyXG4gICAgICBjb25zdCBib2R5X3Y6IGIyVmVjMiA9IGRhdGEudmVsb2NpdGllc1tib2R5Lm1faXNsYW5kSW5kZXhdLnY7XHJcbiAgICAgIGNvbnN0IGRlbHRhOiBiMlZlYzIgPSB0aGlzLm1fZGVsdGFzW2ldO1xyXG5cclxuICAgICAgYm9keV92LnggKz0gYm9keS5tX2ludk1hc3MgKiBkZWx0YS55ICogMC41ICogbGFtYmRhO1xyXG4gICAgICBib2R5X3YueSArPSBib2R5Lm1faW52TWFzcyAqIC1kZWx0YS54ICogMC41ICogbGFtYmRhO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgU29sdmVQb3NpdGlvbkNvbnN0cmFpbnRzKGRhdGE6IGIyU29sdmVyRGF0YSk6IGJvb2xlYW4ge1xyXG4gICAgbGV0IHBlcmltZXRlciA9IDA7XHJcbiAgICBsZXQgYXJlYSA9IDA7XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm1fYm9kaWVzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgIGNvbnN0IGJvZHk6IGIyQm9keSA9IHRoaXMubV9ib2RpZXNbaV07XHJcbiAgICAgIGNvbnN0IG5leHQ6IGIyQm9keSA9IHRoaXMubV9ib2RpZXNbKGkgKyAxKSAlIHRoaXMubV9ib2RpZXMubGVuZ3RoXTtcclxuICAgICAgY29uc3QgYm9keV9jOiBiMlZlYzIgPSBkYXRhLnBvc2l0aW9uc1tib2R5Lm1faXNsYW5kSW5kZXhdLmM7XHJcbiAgICAgIGNvbnN0IG5leHRfYzogYjJWZWMyID0gZGF0YS5wb3NpdGlvbnNbbmV4dC5tX2lzbGFuZEluZGV4XS5jO1xyXG5cclxuICAgICAgY29uc3QgZGVsdGE6IGIyVmVjMiA9IGIyVmVjMi5TdWJWVihuZXh0X2MsIGJvZHlfYywgdGhpcy5tX2RlbHRhKTtcclxuXHJcbiAgICAgIGxldCBkaXN0OiBudW1iZXIgPSBkZWx0YS5MZW5ndGgoKTtcclxuICAgICAgaWYgKGRpc3QgPCBiMl9lcHNpbG9uKSB7XHJcbiAgICAgICAgZGlzdCA9IDE7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMubV9ub3JtYWxzW2ldLnggPSBkZWx0YS55IC8gZGlzdDtcclxuICAgICAgdGhpcy5tX25vcm1hbHNbaV0ueSA9IC1kZWx0YS54IC8gZGlzdDtcclxuXHJcbiAgICAgIHBlcmltZXRlciArPSBkaXN0O1xyXG5cclxuICAgICAgYXJlYSArPSBiMlZlYzIuQ3Jvc3NWVihib2R5X2MsIG5leHRfYyk7XHJcbiAgICB9XHJcblxyXG4gICAgYXJlYSAqPSAwLjU7XHJcblxyXG4gICAgY29uc3QgZGVsdGFBcmVhOiBudW1iZXIgPSB0aGlzLm1fdGFyZ2V0QXJlYSAtIGFyZWE7XHJcbiAgICBjb25zdCB0b0V4dHJ1ZGU6IG51bWJlciA9ICgwLjUgKiBkZWx0YUFyZWEpIC8gcGVyaW1ldGVyO1xyXG4gICAgbGV0IGRvbmUgPSB0cnVlO1xyXG5cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5tX2JvZGllcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICBjb25zdCBib2R5OiBiMkJvZHkgPSB0aGlzLm1fYm9kaWVzW2ldO1xyXG4gICAgICBjb25zdCBib2R5X2M6IGIyVmVjMiA9IGRhdGEucG9zaXRpb25zW2JvZHkubV9pc2xhbmRJbmRleF0uYztcclxuICAgICAgY29uc3QgbmV4dF9pOiBudW1iZXIgPSAoaSArIDEpICUgdGhpcy5tX2JvZGllcy5sZW5ndGg7XHJcblxyXG4gICAgICBjb25zdCBkZWx0YTogYjJWZWMyID0gYjJWZWMyLkFkZFZWKHRoaXMubV9ub3JtYWxzW2ldLCB0aGlzLm1fbm9ybWFsc1tuZXh0X2ldLCB0aGlzLm1fZGVsdGEpO1xyXG4gICAgICBkZWx0YS5TZWxmTXVsKHRvRXh0cnVkZSk7XHJcblxyXG4gICAgICBjb25zdCBub3JtX3NxOiBudW1iZXIgPSBkZWx0YS5MZW5ndGhTcXVhcmVkKCk7XHJcbiAgICAgIGlmIChub3JtX3NxID4gYjJTcShiMl9tYXhMaW5lYXJDb3JyZWN0aW9uKSkge1xyXG4gICAgICAgIGRlbHRhLlNlbGZNdWwoYjJfbWF4TGluZWFyQ29ycmVjdGlvbiAvIGIyU3FydChub3JtX3NxKSk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKG5vcm1fc3EgPiBiMlNxKGIyX2xpbmVhclNsb3ApKSB7XHJcbiAgICAgICAgZG9uZSA9IGZhbHNlO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBib2R5X2MueCArPSBkZWx0YS54O1xyXG4gICAgICBib2R5X2MueSArPSBkZWx0YS55O1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBkb25lO1xyXG4gIH1cclxufVxyXG4iXX0=